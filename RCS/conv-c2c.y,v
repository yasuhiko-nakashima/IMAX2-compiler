head	1.102;
access;
symbols;
locks
	nakashim:1.102; strict;
comment	@ * @;


1.102
date	2022.10.28.22.06.17;	author nakashim;	state Exp;
branches;
next	1.101;

1.101
date	2022.10.28.12.57.14;	author nakashim;	state Exp;
branches;
next	1.100;

1.100
date	2022.10.28.09.11.09;	author nakashim;	state Exp;
branches;
next	1.99;

1.99
date	2022.10.28.08.41.47;	author nakashim;	state Exp;
branches;
next	1.98;

1.98
date	2022.10.28.00.05.48;	author nakashim;	state Exp;
branches;
next	1.97;

1.97
date	2022.10.27.23.24.05;	author nakashim;	state Exp;
branches;
next	1.96;

1.96
date	2022.10.25.23.18.52;	author nakashim;	state Exp;
branches;
next	1.95;

1.95
date	2022.03.03.14.57.44;	author nakashim;	state Exp;
branches;
next	1.94;

1.94
date	2021.12.24.13.51.42;	author nakashim;	state Exp;
branches;
next	1.93;

1.93
date	2021.12.21.03.59.45;	author nakashim;	state Exp;
branches;
next	1.92;

1.92
date	2021.12.19.08.44.18;	author nakashim;	state Exp;
branches;
next	1.91;

1.91
date	2021.12.19.06.36.43;	author nakashim;	state Exp;
branches;
next	1.90;

1.90
date	2021.12.08.00.58.43;	author nakashim;	state Exp;
branches;
next	1.89;

1.89
date	2021.09.21.07.42.10;	author nakashim;	state Exp;
branches;
next	1.88;

1.88
date	2021.06.07.11.29.58;	author nakashim;	state Exp;
branches;
next	1.87;

1.87
date	2020.11.16.13.15.28;	author nakashim;	state Exp;
branches;
next	1.86;

1.86
date	2020.06.01.03.10.33;	author nakashim;	state Exp;
branches;
next	1.85;

1.85
date	2020.05.14.15.40.12;	author nakashim;	state Exp;
branches;
next	1.84;

1.84
date	2020.05.14.08.16.52;	author nakashim;	state Exp;
branches;
next	1.83;

1.83
date	2020.05.05.13.55.38;	author nakashim;	state Exp;
branches;
next	1.82;

1.82
date	2019.10.20.02.52.15;	author nakashim;	state Exp;
branches;
next	1.81;

1.81
date	2019.04.30.03.06.44;	author nakashim;	state Exp;
branches;
next	1.80;

1.80
date	2019.02.17.12.45.35;	author nakashim;	state Exp;
branches;
next	1.79;

1.79
date	2018.10.18.12.42.50;	author nakashim;	state Exp;
branches;
next	1.78;

1.78
date	2018.10.16.13.26.38;	author nakashim;	state Exp;
branches;
next	1.77;

1.77
date	2018.09.18.01.53.38;	author nakashim;	state Exp;
branches;
next	1.76;

1.76
date	2018.09.15.23.24.53;	author nakashim;	state Exp;
branches;
next	1.75;

1.75
date	2018.09.10.11.45.48;	author nakashim;	state Exp;
branches;
next	1.74;

1.74
date	2018.09.09.10.41.00;	author nakashim;	state Exp;
branches;
next	1.73;

1.73
date	2018.09.04.02.02.31;	author nakashim;	state Exp;
branches;
next	1.72;

1.72
date	2017.12.24.14.12.32;	author nakashim;	state Exp;
branches;
next	1.71;

1.71
date	2017.05.30.08.40.26;	author nakashim;	state Exp;
branches;
next	1.70;

1.70
date	2017.05.29.06.17.39;	author nakashim;	state Exp;
branches;
next	1.69;

1.69
date	2017.05.27.12.26.29;	author nakashim;	state Exp;
branches;
next	1.68;

1.68
date	2017.04.28.01.03.12;	author nakashim;	state Exp;
branches;
next	1.67;

1.67
date	2017.04.21.03.30.17;	author nakashim;	state Exp;
branches;
next	1.66;

1.66
date	2017.02.28.14.50.26;	author nakashim;	state Exp;
branches;
next	1.65;

1.65
date	2016.12.04.15.05.10;	author nakashim;	state Exp;
branches;
next	1.64;

1.64
date	2016.12.03.07.47.15;	author nakashim;	state Exp;
branches;
next	1.63;

1.63
date	2016.11.29.02.04.09;	author nakashim;	state Exp;
branches;
next	1.62;

1.62
date	2016.11.26.12.18.47;	author nakashim;	state Exp;
branches;
next	1.61;

1.61
date	2016.11.21.23.12.46;	author nakashim;	state Exp;
branches;
next	1.60;

1.60
date	2016.11.06.08.37.31;	author nakashim;	state Exp;
branches;
next	1.59;

1.59
date	2016.09.23.03.29.52;	author nakashim;	state Exp;
branches;
next	1.58;

1.58
date	2016.09.03.07.37.42;	author nakashim;	state Exp;
branches;
next	1.57;

1.57
date	2016.08.16.05.44.09;	author nakashim;	state Exp;
branches;
next	1.56;

1.56
date	2016.06.04.10.21.49;	author nakashim;	state Exp;
branches;
next	1.55;

1.55
date	2016.06.02.11.41.49;	author nakashim;	state Exp;
branches;
next	1.54;

1.54
date	2016.06.01.12.56.25;	author nakashim;	state Exp;
branches;
next	1.53;

1.53
date	2016.05.03.01.43.45;	author nakashim;	state Exp;
branches;
next	1.52;

1.52
date	2016.04.30.02.10.03;	author nakashim;	state Exp;
branches;
next	1.51;

1.51
date	2016.04.27.15.20.12;	author nakashim;	state Exp;
branches;
next	1.50;

1.50
date	2016.04.19.11.35.25;	author nakashim;	state Exp;
branches;
next	1.49;

1.49
date	2016.04.18.13.07.13;	author nakashim;	state Exp;
branches;
next	1.48;

1.48
date	2016.04.14.22.44.54;	author nakashim;	state Exp;
branches;
next	1.47;

1.47
date	2016.04.11.02.30.13;	author nakashim;	state Exp;
branches;
next	1.46;

1.46
date	2016.04.02.03.40.15;	author nakashim;	state Exp;
branches;
next	1.45;

1.45
date	2016.03.26.14.39.33;	author nakashim;	state Exp;
branches;
next	1.44;

1.44
date	2016.03.12.14.26.21;	author nakashim;	state Exp;
branches;
next	1.43;

1.43
date	2016.03.12.11.31.48;	author nakashim;	state Exp;
branches;
next	1.42;

1.42
date	2016.02.08.23.34.17;	author nakashim;	state Exp;
branches;
next	1.41;

1.41
date	2016.02.01.23.57.55;	author nakashim;	state Exp;
branches;
next	1.40;

1.40
date	2016.01.30.07.43.06;	author nakashim;	state Exp;
branches;
next	1.39;

1.39
date	2016.01.29.15.14.28;	author nakashim;	state Exp;
branches;
next	1.38;

1.38
date	2016.01.28.23.41.25;	author nakashim;	state Exp;
branches;
next	1.37;

1.37
date	2016.01.28.02.34.39;	author nakashim;	state Exp;
branches;
next	1.36;

1.36
date	2016.01.27.22.59.07;	author nakashim;	state Exp;
branches;
next	1.35;

1.35
date	2016.01.27.14.55.23;	author nakashim;	state Exp;
branches;
next	1.34;

1.34
date	2016.01.26.16.40.31;	author nakashim;	state Exp;
branches;
next	1.33;

1.33
date	2016.01.26.11.59.28;	author nakashim;	state Exp;
branches;
next	1.32;

1.32
date	2016.01.26.06.54.33;	author nakashim;	state Exp;
branches;
next	1.31;

1.31
date	2016.01.24.11.40.49;	author nakashim;	state Exp;
branches;
next	1.30;

1.30
date	2016.01.22.16.10.30;	author nakashim;	state Exp;
branches;
next	1.29;

1.29
date	2016.01.21.14.10.01;	author nakashim;	state Exp;
branches;
next	1.28;

1.28
date	2016.01.19.07.26.53;	author nakashim;	state Exp;
branches;
next	1.27;

1.27
date	2016.01.19.03.03.51;	author nakashim;	state Exp;
branches;
next	1.26;

1.26
date	2016.01.18.04.48.28;	author nakashim;	state Exp;
branches;
next	1.25;

1.25
date	2016.01.17.14.28.15;	author nakashim;	state Exp;
branches;
next	1.24;

1.24
date	2016.01.16.08.47.16;	author nakashim;	state Exp;
branches;
next	1.23;

1.23
date	2016.01.16.01.54.19;	author nakashim;	state Exp;
branches;
next	1.22;

1.22
date	2016.01.15.04.06.34;	author nakashim;	state Exp;
branches;
next	1.21;

1.21
date	2016.01.02.11.33.08;	author nakashim;	state Exp;
branches;
next	1.20;

1.20
date	2015.12.12.08.45.11;	author nakashim;	state Exp;
branches;
next	1.19;

1.19
date	2015.12.06.10.25.16;	author nakashim;	state Exp;
branches;
next	1.18;

1.18
date	2015.12.05.08.43.22;	author nakashim;	state Exp;
branches;
next	1.17;

1.17
date	2015.12.04.05.03.22;	author nakashim;	state Exp;
branches;
next	1.16;

1.16
date	2015.11.30.14.18.42;	author nakashim;	state Exp;
branches;
next	1.15;

1.15
date	2015.11.30.09.08.32;	author nakashim;	state Exp;
branches;
next	1.14;

1.14
date	2015.11.29.02.52.58;	author nakashim;	state Exp;
branches;
next	1.13;

1.13
date	2015.11.23.14.03.24;	author nakashim;	state Exp;
branches;
next	1.12;

1.12
date	2015.11.16.23.56.46;	author nakashim;	state Exp;
branches;
next	1.11;

1.11
date	2015.11.15.03.22.47;	author nakashim;	state Exp;
branches;
next	1.10;

1.10
date	2015.11.14.10.25.41;	author nakashim;	state Exp;
branches;
next	1.9;

1.9
date	2015.11.13.12.37.04;	author nakashim;	state Exp;
branches;
next	1.8;

1.8
date	2015.11.12.13.04.55;	author nakashim;	state Exp;
branches;
next	1.7;

1.7
date	2015.11.12.09.57.10;	author nakashim;	state Exp;
branches;
next	1.6;

1.6
date	2015.11.11.16.09.20;	author nakashim;	state Exp;
branches;
next	1.5;

1.5
date	2015.11.08.07.16.14;	author nakashim;	state Exp;
branches;
next	1.4;

1.4
date	2015.11.08.07.15.38;	author nakashim;	state Exp;
branches;
next	1.3;

1.3
date	2015.11.08.03.08.18;	author nakashim;	state Exp;
branches;
next	1.2;

1.2
date	2015.11.08.02.59.28;	author nakashim;	state Exp;
branches;
next	1.1;

1.1
date	2015.07.27.23.16.09;	author nakashim;	state Exp;
branches;
next	;


desc
@@


1.102
log
@*** empty log message ***
@
text
@
/* EMAX6 Compiler                      */
/*        Copyright (C) 2012 by NAIST. */
/*         Primary writer: Y.Nakashima */
/*                nakashim@@is.naist.jp */

/* conv-a2c.y   2012/6/15 */

%token  EOL
%token  ARMV8
%token  EMAX6ABEGIN  EMAX6ASTATEM  EMAX6AEND  EMAX6ADRAIN
%token  EMAX6TBEGIN  EMAX6TSTATEM  EMAX6TEND

/* CGRA */
%token  CGRA_ULL     CGRA_UINT    CGRA_SLL   CGRA_SRL
%token  CGRA_WHILE   CGRA_FOR
%token  CGRA_CEX     CGRA_EX4     CGRA_EXE
%token  CGRA_MEX     CGRA_MO4     CGRA_MOP
%token	CGRA_DECR    CGRA_INCR

/* TRANSACTION */
%token  TRAN_READ       TRAN_WRITE

/* COMMON */
%token  IMMEDIATE
%token  EXRNO
%token  ALRNO
%token  BDRNO
%token  CHIP
%token  INITNO
%token  LOOPNO
%token  VARIABLE
%token  ASIS

%start  program
%%
program : program line
        | line
        ;

line :  EOL {
        }
        | ARMV8 {
          fprintf(ofile, "%s\n", yytext);
        }
        | EMAX6ABEGIN VARIABLE expr { /* reset conf[][] */
          printf("==EMAX6AB reading line=%d name=%s\n", y_lineno, id[$2].name);
          current_prefix  = $2;
          current_mapdist = id[$3].val;
          current_nchip   = 1; /* default */
          current_lmmwb   = 0;
          last_insn = 0;
	  bzero(&insn, sizeof(insn));
	  bzero(&dec,  sizeof(dec));
	  bzero(&bus,  sizeof(bus));
	  bzero(&conf, sizeof(conf));
	  bzero(&lmmi, sizeof(lmmi));
	  bzero(&lmmx, sizeof(lmmx));
	  bzero(&regv, sizeof(regv));
	  fprintf(ofile, "#ifndef EMAXSC\n");
          fprintf(ofile, "volatile emax6_conf_%s();\n", id[current_prefix].name);
	  fprintf(ofile, "#endif\n");
        }
        | EMAX6ASTATEM EMAX6ABODY {
        }
        | EMAX6AEND {
	  emit_emax6a(0);
	  hash_clear();
        }
        | EMAX6ADRAIN {
	  emit_emax6a(1);
	  hash_clear();
        }
        | EMAX6TBEGIN VARIABLE { /* reset tconf[][] */
          printf("==EMAX6TB reading line=%d name=%s\n", y_lineno, id[$2].name);
          current_prefix = $2;
          trans_pc = 0;
	  bzero(&trans, sizeof(trans));
	  bzero(&tconf, sizeof(tconf));
	}
        | EMAX6TSTATEM EMAX6TBODY {
	}
        | EMAX6TEND {
	  emit_emax6t(0);
	  hash_clear();
	}
        ;

EMAX6ABODY : EMAX6AUNIT {
        }
        | EMAX6ABODY EMAX6AUNIT {
        }
        ;

EMAX6AUNIT : CGRA_WHILE "(" VARIABLE CGRA_DECR ")" "\{" {
          if (last_insn >= INSN_DEPTH) {
	    fprintf(stderr, "in %s: last_insn exceeds INSN_DEPTH=%d\n", id[current_prefix].name, INSN_DEPTH);
            exit(1);
          }
	  insn[last_insn].iheader.type = 1; /* WHILE */
	  insn[last_insn].iheader.row  = 0; /* top */
	  insn[last_insn].iheader.col  = 0; /* top */
	  insn[last_insn].iexe.op1     = OP_WHILE;
	  insn[last_insn].iexe.updt    = 1;
	  insn[last_insn].iexe.init    = 0;
	  insn[last_insn].iexe.src1v   = T_VARIABLE; /* variable */
	  insn[last_insn].iexe.src1h   = $3;
	  insn[last_insn].iexe.src1s   = -1; /* no suffix */
	  insn[last_insn].iexe.src1e   = EXP_H3210; /* full */
	  insn[last_insn].iexe.src2v   = T_IMMEDIATE; /* variable */
	  insn[last_insn].iexe.src2h   = $4; /* -1 */
	  insn[last_insn].iexe.src2s   = -1; /* no suffix */
	  insn[last_insn].iexe.src2e   = EXP_H3210; /* full */
	  insn[last_insn].iexe.exedv   = T_VARIABLE; /* variable */
	  insn[last_insn].iexe.exedh   = $3;
	  insn[last_insn].iexe.exeds   = -1; /* no suffix */
          last_insn++;
	}
        | CGRA_FOR "(" CHIP "=" expr ";" CHIP "<" expr ";" CHIP CGRA_INCR ")" "\{" {
	  if (id[$5].val != 0) {
	    fprintf(stderr, "in %s: for(CHIP=0;;) should be specified\n", id[current_prefix].name);
            exit(1);
	  }
          current_nchip = id[$9].val; /* should be <= EMAX_NCHIP */
	  if (current_nchip > EMAX_NCHIP) {
	    fprintf(stderr, "in %s: for(;CHIP<NCHIP;) NCHIP(%d) should be <= EMAX_NCHIP(%d)\n", id[current_prefix].name, current_nchip, EMAX_NCHIP);
            exit(1);
	  }
	  fprintf(ofile, "#ifndef EMAXSC\n");
	  fprintf(ofile, "\t((struct reg_ctrl*)emax6.reg_ctrl)->i[0].mcid = %d; // NCHIP-1\n", current_nchip-1);
	  fprintf(ofile, "#endif\n");
	}
        | CGRA_FOR "(" INITNO "=" expr "," LOOPNO "=" ASIS "," XVARIABLE "=" ASIS ";" LOOPNO CGRA_DECR ";" INITNO "=" expr ")" "\{" {
	  int loop_no = id[$3].val;
          if (last_insn >= INSN_DEPTH) {
	    fprintf(stderr, "in %s: last_insn exceeds INSN_DEPTH=%d\n", id[current_prefix].name, INSN_DEPTH);
            exit(1);
          }
	  if (loop_no > 1) {
	    fprintf(stderr, "in %s: for() is limited to INIT0 or INIT1\n", id[current_prefix].name);
            exit(1);
	  }
	  if (loop_no != id[ $7].val || loop_no != id[$15].val || loop_no != id[$18].val || loop_no != id[$7].val) {
	    fprintf(stderr, "in %s: for() INIT#/LOOP# mismatch\n", id[current_prefix].name);
            exit(1);
	  }
	  if (id[$5].val != 1 || id[$20].val != 0) {
	    fprintf(stderr, "in %s: for(INIT#=1,...; LOOP#--; INIT#=0) should be specified\n", id[current_prefix].name);
            exit(1);
	  }
	  fprintf(ofile, "\t%s = %s;\n", id[ $7].name, id[ $9].name);
	  if (id[$11].cidx) {
	    int c, len, i; char *buf;
	    len = strlen(id[$13].name);
	    buf = malloc(len+1);
	    buf[len] = 0;
	    for (c=0; c<current_nchip; c++) {
	      strncpy(buf, id[$13].name, len);
	      for (i=0; i<len; i++) {
		if (!strncmp(id[$13].name+i, "CHIP", 4)) {
		  *(buf+i+0) = ' ';
		  *(buf+i+1) = ' ';
		  *(buf+i+2) = ' ';
		  *(buf+i+3) = '0'+c;
		  i += 4;
		}
	      }
	      fprintf(ofile, "\t%s[%d] = %s;\n", id[$11].name, c, buf);
	    }
	    free(buf);
	  }
	  else
	    fprintf(ofile, "\t%s = %s;\n", id[$11].name, id[$13].name);
	  insn[last_insn].iheader.type = 2; /* FOR */
	  insn[last_insn].iheader.row  = 0; /* top */
	  insn[last_insn].iheader.col  = loop_no;
	  insn[last_insn].iexe.op1     = OP_FOR;
	  insn[last_insn].iexe.updt    = 1;
	  insn[last_insn].iexe.init    = 0;
	  insn[last_insn].iexe.src1v   = T_VARIABLE; /* variable */
	  insn[last_insn].iexe.src1h   = $15;
	  insn[last_insn].iexe.src1s   = -1; /* no suffix */
	  insn[last_insn].iexe.src1e   = EXP_H3210; /* full */
	  insn[last_insn].iexe.src2v   = T_IMMEDIATE; /* variable */
	  insn[last_insn].iexe.src2h   = $16; /* -1 */
	  insn[last_insn].iexe.src2s   = -1; /* no suffix */
	  insn[last_insn].iexe.src2e   = EXP_H3210; /* full */
	  insn[last_insn].iexe.exedv   = T_VARIABLE; /* variable */
	  insn[last_insn].iexe.exedh   = $15;
	  insn[last_insn].iexe.exeds   = -1; /* no suffix */
          last_insn++;
	}
        | CGRA_CEX "(" expr "," cex_dst "," cex_src "," cex_src "," cex_src "," cex_src "," expr ")" ";" {
          if (last_insn >= INSN_DEPTH) {
	    fprintf(stderr, "in %s: last_insn exceeds INSN_DEPTH=%d\n", id[current_prefix].name, INSN_DEPTH);
            exit(1);
          }
	  insn[last_insn].iheader.type = 3; /* CEX */
	  insn[last_insn].iheader.row  = -1;
	  insn[last_insn].iheader.col  = -1;
	  insn[last_insn].icex.op      = id[ $3].val;
	  insn[last_insn].icex.bit0v   = id[$13].type;
	  insn[last_insn].icex.bit0h   = $13;
	  insn[last_insn].icex.bit1v   = id[$11].type;
	  insn[last_insn].icex.bit1h   = $11;
	  insn[last_insn].icex.bit2v   = id[ $9].type;
	  insn[last_insn].icex.bit2h   = $9;
	  insn[last_insn].icex.bit3v   = id[ $7].type;
	  insn[last_insn].icex.bit3h   = $7;
	  insn[last_insn].icex.table   = id[$15].val;
	  insn[last_insn].icex.cexdv   = id[ $5].type;
	  insn[last_insn].icex.cexdh   = $5;
          last_insn++;
        }
        | CGRA_EX4 "(" expr "," ex4_dstd "," ex4_src "," expr "," ex4_src "," expr "," ex4_src "," expr "," expr "," ex4_src "," expr "," ex4_src ")" ";" {
	  /* ex4(op1, &BR[r-1][c1], &BR[r-1][c2], &BR[r-1][c3], op2, IMM, op3, IMM, &BR[r][c], NULL); followed by next ex */
	  /* ex4(op1, &BR[r-1][c1], &BR[r-1][c2], &BR[r-1][c3], op2, IMM, op3, IMM, &AR[r],    NULL); followed by store(automatic allocating) */
          if (last_insn >= INSN_DEPTH) {
	    fprintf(stderr, "in %s: last_insn exceeds INSN_DEPTH=%d\n", id[current_prefix].name, INSN_DEPTH);
            exit(1);
          }
	  insn[last_insn].iheader.type = 4; /* EX4 */
	  insn[last_insn].iheader.row  = id[ $5].type==T_ALRNO?(id[$5].val):id[$5].type==T_BDRNO?(id[$5].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[ $5].type==T_ALRNO?(        -1):id[$5].type==T_BDRNO?(id[$5].val%EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iexe.op1     = id[ $3].val;
	  insn[last_insn].iexe.op2     = id[$19].val;
	  insn[last_insn].iexe.op3     = id[$23].val;
	  insn[last_insn].iexe.updt    = ($5 == $7)?1:0; /* if (src1 == dstd) self_update=1 */
	  insn[last_insn].iexe.init    = 0;
	  insn[last_insn].iexe.src1v   = id[ $7].type;
	  insn[last_insn].iexe.src1h   = $7;
	  insn[last_insn].iexe.src1s   = 4; /* all suffix */
	  insn[last_insn].iexe.src1e   = id[ $9].val;
	  insn[last_insn].iexe.src2v   = id[$11].type;
	  insn[last_insn].iexe.src2h   = $11;
	  insn[last_insn].iexe.src2s   = 4; /* all suffix */
	  insn[last_insn].iexe.src2e   = id[$13].val;
	  insn[last_insn].iexe.src3v   = id[$15].type;
	  insn[last_insn].iexe.src3h   = $15;
	  insn[last_insn].iexe.src3s   = 4; /* all suffix */
	  insn[last_insn].iexe.src3e   = id[$17].val;
	  insn[last_insn].iexe.src4v   = id[$21].type;
	  insn[last_insn].iexe.src4h   = $21;
	  insn[last_insn].iexe.src4s   = 4; /* all suffix */
	  insn[last_insn].iexe.src5v   = id[$25].type;
	  insn[last_insn].iexe.src5h   = $25;
	  insn[last_insn].iexe.src5s   = 4; /* all suffix */
	  insn[last_insn].iexe.exedv   = id[$5].type;
	  insn[last_insn].iexe.exedh   = $5;
	  insn[last_insn].iexe.exeds   = 4; /* all suffix */
          last_insn++;
        }
        | CGRA_EX4 "(" expr "," exe_dstd "," exe_src1 "," expr "," ex4_src "," expr "," ex4_src "," expr "," expr "," ex4_src "," expr "," exe_src5 ")" ";" {
	  /* ex4(OP_SFMA, &b00, b00, EXP_H3210, BR[r][1], EXP_H3210, BR[r][2], EXP_H3210, OP_NOP, 0LL, OP_NOP, 32LL) */
          if (last_insn >= INSN_DEPTH) {
	    fprintf(stderr, "in %s: last_insn exceeds INSN_DEPTH=%d\n", id[current_prefix].name, INSN_DEPTH);
            exit(1);
          }
	  insn[last_insn].iheader.type = 4; /* EX4 */
	  insn[last_insn].iheader.row  = id[ $5].type==T_ALRNO?(id[$5].val)                :id[$5].type==T_BDRNO?(id[$5].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[ $5].type==T_ALRNO?(insn[last_insn].iexe.exeds):id[$5].type==T_BDRNO?(id[$5].val%EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iexe.op1     = id[ $3].val;
	  insn[last_insn].iexe.op2     = id[$19].val;
	  insn[last_insn].iexe.op3     = id[$23].val;
	  insn[last_insn].iexe.updt    = ($5 == $7)?1:0; /* if (src1 == dstd) self_update=1 */
	  insn[last_insn].iexe.init    = 0;
	  insn[last_insn].iexe.src1v   = id[ $7].type;
	  insn[last_insn].iexe.src1h   = $7;
	  insn[last_insn].iexe.src1e   = id[ $9].val;
	  insn[last_insn].iexe.src2v   = id[$11].type;
	  insn[last_insn].iexe.src2h   = $11;
	  insn[last_insn].iexe.src2s   = 4; /* all suffix */
	  insn[last_insn].iexe.src2e   = id[$13].val;
	  insn[last_insn].iexe.src3v   = id[$15].type;
	  insn[last_insn].iexe.src3h   = $15;
	  insn[last_insn].iexe.src3s   = 4; /* all suffix */
	  insn[last_insn].iexe.src3e   = id[$17].val;
	  insn[last_insn].iexe.src4v   = id[$21].type;
	  insn[last_insn].iexe.src4h   = $21;
	  insn[last_insn].iexe.src4s   = 4; /* all suffix */
	  insn[last_insn].iexe.src5v   = id[$25].type;
	  insn[last_insn].iexe.src5h   = $25;
	  insn[last_insn].iexe.exedv   = id[$5].type;
	  insn[last_insn].iexe.exedh   = $5;
          last_insn++;
        }
        | CGRA_EX4 "(" expr "," exe_dstd "," INITNO "?" exe_src1 ":" exe_src1 "," expr "," ex4_src "," expr "," ex4_src "," expr "," expr "," ex4_src "," expr "," exe_src5 ")" ";" {
	  /* ex4(OP_SFMA, &b00, INIT0?b00:b00, EXP_H3210, BR[r][1], EXP_H3210, BR[r][2], EXP_H3210, OP_NOP, 0LL, OP_NOP, 32LL) */
	  int loop_no0 = id[$7].val;
          if (last_insn >= INSN_DEPTH) {
	    fprintf(stderr, "in %s: last_insn exceeds INSN_DEPTH=%d\n", id[current_prefix].name, INSN_DEPTH);
            exit(1);
          }
	  if (loop_no0 != 0) {
	    fprintf(stderr, "in %s: exe(INIT0) should be specified\n", id[current_prefix].name);
            exit(1);
	  }
	  if ($9 != $11) {
	    fprintf(stderr, "in %s: exe(INIT0?src1:src1) src1 should be the same\n", id[current_prefix].name);
            exit(1);
	  }
	  insn[last_insn].iheader.type = 4; /* EX4 */
	  insn[last_insn].iheader.row  = id[ $5].type==T_ALRNO?(id[$5].val)                :id[$5].type==T_BDRNO?(id[$5].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[ $5].type==T_ALRNO?(insn[last_insn].iexe.exeds):id[$5].type==T_BDRNO?(id[$5].val%EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iexe.op1     = id[ $3].val;
	  insn[last_insn].iexe.op2     = id[$23].val;
	  insn[last_insn].iexe.op3     = id[$27].val;
	  insn[last_insn].iexe.updt    = ($5 == $9)?1:0; /* if (src1 == dstd) self_update=1 */
	  insn[last_insn].iexe.init    = 1; /* activate INIT0?src1 */
	  insn[last_insn].iexe.src1v   = id[ $9].type;
	  insn[last_insn].iexe.src1h   = $9;
	  insn[last_insn].iexe.src1e   = id[ $13].val;
	  insn[last_insn].iexe.src2v   = id[ $15].type;
	  insn[last_insn].iexe.src2h   = $15;
	  insn[last_insn].iexe.src2s   = 4; /* all suffix */
	  insn[last_insn].iexe.src2e   = id[$17].val;
	  insn[last_insn].iexe.src3v   = id[$19].type;
	  insn[last_insn].iexe.src3h   = $19;
	  insn[last_insn].iexe.src3s   = 4; /* all suffix */
	  insn[last_insn].iexe.src3e   = id[$21].val;
	  insn[last_insn].iexe.src4v   = id[$25].type;
	  insn[last_insn].iexe.src4h   = $25;
	  insn[last_insn].iexe.src4s   = 4; /* all suffix */
	  insn[last_insn].iexe.src5v   = id[$29].type;
	  insn[last_insn].iexe.src5h   = $29;
	  insn[last_insn].iexe.exedv   = id[$5].type;
	  insn[last_insn].iexe.exedh   = $5;
          last_insn++;
        }
        | CGRA_EXE "(" expr "," exe_dstd "," exe_src1 "," expr "," exe_src2 "," expr "," exe_src3 "," expr "," expr "," exe_src4 "," expr "," exe_src5 ")" ";" {
	  /* exe(op1, BR[r-1][c1][s], BR[r-1][c2][s], BR[r-1][c3][s], op2, IMM, op3, IMM, &BR[r][c][s]); followed by next ex */
	  /* exe(op1, BR[r-1][c1][s], BR[r-1][c2][s], BR[r-1][c3][s], op2, IMM, op3, IMM, &AR[r][c]   ); followed by store(automatic allocating) */
          if (last_insn >= INSN_DEPTH) {
	    fprintf(stderr, "in %s: last_insn exceeds INSN_DEPTH=%d\n", id[current_prefix].name, INSN_DEPTH);
            exit(1);
          }
	  insn[last_insn].iheader.type = 5; /* EXE */
	  insn[last_insn].iheader.row  = id[ $5].type==T_ALRNO?(id[$5].val)                :id[$5].type==T_BDRNO?(id[$5].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[ $5].type==T_ALRNO?(insn[last_insn].iexe.exeds):id[$5].type==T_BDRNO?(id[$5].val%EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iexe.op1     = id[ $3].val;
	  insn[last_insn].iexe.op2     = id[$19].val;
	  insn[last_insn].iexe.op3     = id[$23].val;
	  insn[last_insn].iexe.updt    = ($5 == $7)?1:0; /* if (src1 == dstd) self_update=1 */
	  insn[last_insn].iexe.init    = 0;
	  insn[last_insn].iexe.src1v   = id[ $7].type;
	  insn[last_insn].iexe.src1h   = $7;
	  insn[last_insn].iexe.src1e   = id[ $9].val;
	  insn[last_insn].iexe.src2v   = id[$11].type;
	  insn[last_insn].iexe.src2h   = $11;
	  insn[last_insn].iexe.src2e   = id[$13].val;
	  insn[last_insn].iexe.src3v   = id[$15].type;
	  insn[last_insn].iexe.src3h   = $15;
	  insn[last_insn].iexe.src3e   = id[$17].val;
	  insn[last_insn].iexe.src4v   = id[$21].type;
	  insn[last_insn].iexe.src4h   = $21;
	  insn[last_insn].iexe.src5v   = id[$25].type;
	  insn[last_insn].iexe.src5h   = $25;
	  insn[last_insn].iexe.exedv   = id[$5].type;
	  insn[last_insn].iexe.exedh   = $5;
          last_insn++;
        }
        | CGRA_EXE "(" expr "," exe_dstd "," INITNO "?" exe_src1 ":" exe_src1 "," expr "," exe_src2 "," expr "," exe_src3 "," expr "," expr "," exe_src4 "," expr "," exe_src5 ")" ";" {
	  /* exe(op1, BR[r-1][c1][s], BR[r-1][c2][s], BR[r-1][c3][s], op2, IMM, op3, IMM, &BR[r][c][s]); followed by next ex */
	  /* exe(op1, BR[r-1][c1][s], BR[r-1][c2][s], BR[r-1][c3][s], op2, IMM, op3, IMM, &AR[r][c]   ); followed by store(automatic allocating) */
	  int loop_no0 = id[$7].val;
          if (last_insn >= INSN_DEPTH) {
	    fprintf(stderr, "in %s: last_insn exceeds INSN_DEPTH=%d\n", id[current_prefix].name, INSN_DEPTH);
            exit(1);
          }
	  if (loop_no0 != 0) {
	    fprintf(stderr, "in %s: exe(INIT0) should be specified\n", id[current_prefix].name);
            exit(1);
	  }
	  if ($9 != $11) {
	    fprintf(stderr, "in %s: exe(INIT0?src1:src1) should be specified\n", id[current_prefix].name);
            exit(1);
	  }
	  insn[last_insn].iheader.type = 5; /* EXE */
	  insn[last_insn].iheader.row  = id[ $5].type==T_ALRNO?(id[$5].val)                :id[$5].type==T_BDRNO?(id[$5].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[ $5].type==T_ALRNO?(insn[last_insn].iexe.exeds):id[$5].type==T_BDRNO?(id[$5].val%EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iexe.op1     = id[ $3].val;
	  insn[last_insn].iexe.op2     = id[$23].val;
	  insn[last_insn].iexe.op3     = id[$27].val;
	  insn[last_insn].iexe.updt    = ($5 == $9)?1:0; /* if (src1 == dstd) self_update=1 */
	  insn[last_insn].iexe.init    = 1; /* activate INIT0?src1 */
	  insn[last_insn].iexe.src1v   = id[ $9].type;
	  insn[last_insn].iexe.src1h   = $9;
	  insn[last_insn].iexe.src1e   = id[$13].val;
	  insn[last_insn].iexe.src2v   = id[$15].type;
	  insn[last_insn].iexe.src2h   = $15;
	  insn[last_insn].iexe.src2e   = id[$17].val;
	  insn[last_insn].iexe.src3v   = id[$19].type;
	  insn[last_insn].iexe.src3h   = $19;
	  insn[last_insn].iexe.src3e   = id[$21].val;
	  insn[last_insn].iexe.src4v   = id[$25].type;
	  insn[last_insn].iexe.src4h   = $25;
	  insn[last_insn].iexe.src5v   = id[$29].type;
	  insn[last_insn].iexe.src5h   = $29;
	  insn[last_insn].iexe.exedv   = id[$5].type;
	  insn[last_insn].iexe.exedh   = $5;
          last_insn++;
        }
        | CGRA_EXE "(" expr "," exe_dstd "," exe_src1 "," expr "," INITNO "?" exe_src2 ":" expr "," expr "," exe_src3 "," expr "," expr "," exe_src4 "," expr "," exe_src5 ")" ";" {
	  /* exe(op1, BR[r-1][c1][s], BR[r-1][c2][s], BR[r-1][c3][s], op2, IMM, op3, IMM, &BR[r][c][s]); followed by next ex */
	  /* exe(op1, BR[r-1][c1][s], BR[r-1][c2][s], BR[r-1][c3][s], op2, IMM, op3, IMM, &AR[r][c]   ); followed by store(automatic allocating) */
	  int loop_no0 = id[$11].val;
          if (last_insn >= INSN_DEPTH) {
	    fprintf(stderr, "in %s: last_insn exceeds INSN_DEPTH=%d\n", id[current_prefix].name, INSN_DEPTH);
            exit(1);
          }
	  if (loop_no0 != 0) {
	    fprintf(stderr, "in %s: exe(INIT0) should be specified\n", id[current_prefix].name);
            exit(1);
	  }
	  if (id[$15].val != 0) {
	    fprintf(stderr, "in %s: exe(INIT0?src2:expr) expr should be zero\n", id[current_prefix].name);
            exit(1);
	  }
	  insn[last_insn].iheader.type = 5; /* EXE */
	  insn[last_insn].iheader.row  = id[ $5].type==T_ALRNO?(id[$5].val)                :id[$5].type==T_BDRNO?(id[$5].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[ $5].type==T_ALRNO?(insn[last_insn].iexe.exeds):id[$5].type==T_BDRNO?(id[$5].val%EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iexe.op1     = id[ $3].val;
	  insn[last_insn].iexe.op2     = id[$23].val;
	  insn[last_insn].iexe.op3     = id[$27].val;
	  insn[last_insn].iexe.updt    = ($5 == $7)?1:0; /* if (src1 == dstd) self_update=1 */
	  insn[last_insn].iexe.init    = 2; /* activate s2+INIT0 */
	  insn[last_insn].iexe.src1v   = id[ $7].type;
	  insn[last_insn].iexe.src1h   = $7;
	  insn[last_insn].iexe.src1e   = id[ $9].val;
	  insn[last_insn].iexe.src2v   = id[$13].type;
	  insn[last_insn].iexe.src2h   = $13;
	  insn[last_insn].iexe.src2e   = id[$17].val;
	  insn[last_insn].iexe.src3v   = id[$19].type;
	  insn[last_insn].iexe.src3h   = $19;
	  insn[last_insn].iexe.src3e   = id[$21].val;
	  insn[last_insn].iexe.src4v   = id[$25].type;
	  insn[last_insn].iexe.src4h   = $25;
	  insn[last_insn].iexe.src5v   = id[$29].type;
	  insn[last_insn].iexe.src5h   = $29;
	  insn[last_insn].iexe.exedv   = id[$5].type;
	  insn[last_insn].iexe.exedh   = $5;
          last_insn++;
        }
      /*| CGRA_MEX "(" expr "," mex_dst "," INITNO "?" XVARIABLE ":" XVARIABLE "," INITNO "?" expr ":" expr "," mex_src3 "," mex_src4 ")" ";" {*/
        | CGRA_MEX "(" expr "," mex_dst2 "," INITNO "?" mex_adr3 ":" XVARIABLE "," INITNO "?" expr ":" expr "," expr "," mex_dst1 "," INITNO "?" mex_adr1 ":" XVARIABLE "," INITNO "?" expr ":" expr "," expr "," mex_src2 "," mex_src1 ")" ";" {
          /*  1     2    3   4     5      6    7     8      9     10     11     12   13    14  15   16  17   18  19   20    21     22   23    24    25     26    27      28   29    30  31   32  33   34  35   36    37     38    39 */
	  /* old mex(OP_CMPA_LE, &b0[h],       INIT0?b:b0[h],                INIT0?0:8, BR[r][2][1], BR[r][2][0]);*/
	  /* old mex(OP_CMPA_GE, &a0[h][CHIP], INIT0?a[h][CHIP]:a0[h][CHIP], INIT0?0:8, BR[r][2][1], BR[r][2][0]);*/
	  /* new mex(OP_CMPA_LE, &b0[h][0], INIT0?b[0]:b0[h][0], INIT0?0LL:8LL, OP_CMPA_GE, &a0[h][0][CHIP], INIT0?a[h][CHIP]:a0[h][0][CHIP], INIT0?0LL:8LL, 0LL, BR[r][2][1], BR[r][2][0]);*/
	  /* new mex(OP_CMPA_LE, &J[x],     INIT0?0LL:J[x],      INIT0?0LL:8LL, OP_CMPA_GE, &K[x],           INIT0?0LL:K[x],                  INIT0?0LL:8LL, BE8, BR[r][2][1], BR[r][2][0]);*/
	  /*     mop(OP_LDR, 3, &BR[r][2][1], b0[h],       bofs, MSK_W1, b,          2*LP*RMGRP, 0, 0, NULL, 2*LP*RMGRP);*/
	  /*     mop(OP_LDR, 3, &BR[r][2][0], a0[h][CHIP], cofs, MSK_W1, a[h][CHIP], 2*LP,       0, 0, NULL, 2*LP      );*/
	  int loop_no0 = id[$7].val;
          if (last_insn >= INSN_DEPTH) {
	    fprintf(stderr, "in %s: last_insn exceeds INSN_DEPTH=%d\n", id[current_prefix].name, INSN_DEPTH);
            exit(1);
          }
	  if (loop_no0 != 0) {
	    fprintf(stderr, "in %s: mex(INIT0) should be specified\n", id[current_prefix].name);
            exit(1);
	  }
	  if (loop_no0 != id[$13].val || loop_no0 != id[$23].val || loop_no0 != id[$29].val) {
	    fprintf(stderr, "in %s: mex() INIT# mismatch\n", id[current_prefix].name);
            exit(1);
	  }
	  if ($5 != $11 || $21 != $27) {
	    fprintf(stderr, "in %s: mex(dst,INIT0?src0:src) dst and src should be the same\n", id[current_prefix].name);
            exit(1);
	  }
	  if (id[$15].val != 0 || id[$31].val != 0) {
	    fprintf(stderr, "in %s: mex(INIT0?expr0:expr) expr0 should be zero\n", id[current_prefix].name);
            exit(1);
	  }
	  if (id[$37].val != id[$39].val) {
	    fprintf(stderr, "in %s: mex(src2[%d][%d],src1[%d][%d]) should be the same row/col\n", id[current_prefix].name, (Uint)id[$31].val/EMAX_WIDTH, (Uint)id[$31].val%EMAX_WIDTH, (Uint)id[$33].val/EMAX_WIDTH, (Uint)id[$33].val%EMAX_WIDTH);
            exit(1);
	  }
	  if (insn[last_insn].imex.src2s != 1 || insn[last_insn].imex.src1s != 0) {
	    fprintf(stderr, "in %s: mex(src2[%d][%d][%d],src1[%d][%d][%d]) should be src2[][][1] and src1[][][0]\n", id[current_prefix].name, (Uint)id[$31].val/EMAX_WIDTH, (Uint)id[$31].val%EMAX_WIDTH, insn[last_insn].imex.src2s, (Uint)id[$33].val/EMAX_WIDTH, (Uint)id[$33].val%EMAX_WIDTH, insn[last_insn].imex.src1s);
            exit(1);
	  }
	  insn[last_insn].iheader.type = 6; /* MEX */
	  insn[last_insn].iheader.row  = id[$37].type==T_BDRNO?(id[$37].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[$37].type==T_BDRNO?(id[$37].val%EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].imex.op0     = id[$19].val; /* activate self_update */
	  insn[last_insn].imex.op1     = id[ $3].val; /* activate self_update */
	  insn[last_insn].imex.init    = 1;           /* activate INIT0?src1 */
	  insn[last_insn].imex.adr1v   = id[$25].type; 
	  insn[last_insn].imex.adr1h   = $25;
	  insn[last_insn].imex.adr2v   = id[$27].type;
	  insn[last_insn].imex.adr2h   = $27;
	  insn[last_insn].imex.adr2s   = -1;
	  insn[last_insn].imex.dist1v  = id[$33].type;
	  insn[last_insn].imex.dist1h  = $33;
	  insn[last_insn].imex.adr3v   = id[ $9].type;
	  insn[last_insn].imex.adr3h   = $9;
	  insn[last_insn].imex.adr4v   = id[$11].type;
	  insn[last_insn].imex.adr4h   = $11;
	  insn[last_insn].imex.adr4s   = -1;
	  insn[last_insn].imex.dist2v  = id[$17].type;
	  insn[last_insn].imex.dist2h  = $17;
	  insn[last_insn].imex.limitv  = id[$35].type;
	  insn[last_insn].imex.limith  = $35;
	  insn[last_insn].imex.src1v   = id[$39].type;
	  insn[last_insn].imex.src1h   = $39;
	  insn[last_insn].imex.src2v   = id[$37].type;
	  insn[last_insn].imex.src2h   = $37;
	  insn[last_insn].imex.mexd0v  = id[$21].type;
	  insn[last_insn].imex.mexd0h  = $21;
	  insn[last_insn].imex.mexd1v  = id[ $5].type;
	  insn[last_insn].imex.mexd1h  = $5;
          last_insn++;
        }
        | CGRA_MO4 "(" expr "," mop_ex "," mo4_srcdst "," mop_base "," mop_offset "," expr "," mop_top "," mop_len "," expr "," force "," mop_top "," mop_len ")" ";" {
	  /* mop(load,  ex, BR[r][c][s], single_reg, offset, offset_mask, stream_top, length, block, force, ptop, plen); load requires target regs */
	  /* mop(store, ex, AR[r][c][s], single_reg, offset, offset_mask, stream_top, length, block, force, ptop, plen); store requires current ex */
          if (last_insn >= INSN_DEPTH) {
	    fprintf(stderr, "in %s: last_insn exceeds INSN_DEPTH=%d\n", id[current_prefix].name, INSN_DEPTH);
            exit(1);
          }
	  insn[last_insn].iheader.type = 7; /* MO4 */
	  insn[last_insn].iheader.row  = id[ $7].type==T_ALRNO?(id[$7].val):id[$7].type==T_BDRNO?(id[$7].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[ $7].type==T_ALRNO?(        -1):id[$7].type==T_BDRNO?(id[$7].val%EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].imop.op      = id[ $3].val;
	  insn[last_insn].imop.mtype   = get_mop_type(id[ $3].val);
	  insn[last_insn].imop.exv     = id[ $5].type;
	  insn[last_insn].imop.exh     = $5;
	  insn[last_insn].imop.mopdv   = id[ $7].type;
	  insn[last_insn].imop.mopdh   = $7;
	  insn[last_insn].imop.mopds   = 4; /* all suffix */
	  insn[last_insn].imop.basev   = id[ $9].type;
	  insn[last_insn].imop.baseh   = $9;
	  insn[last_insn].imop.offsv   = id[$11].type;
	  insn[last_insn].imop.offsh   = $11;
	  if (insn[last_insn].imop.updt) { /* addr++ */
	    if (insn[last_insn].imop.offsv != T_IMMEDIATE || id[insn[last_insn].imop.offsh].val) { /* != zero */
	      fprintf(stderr, "in %s: incremental base=%s requires offset=0 (specified type=%d val=%d)\n",
		      id[current_prefix].name, id[insn[last_insn].imop.baseh].name, insn[last_insn].imop.offsv, id[insn[last_insn].imop.offsh].val);
	      exit(1);
	    }
	    else {
	      Ull size;
	      switch (insn[last_insn].imop.op) {
	      case OP_LDRQ: case OP_STRQ: size = 32LL; break;
	      default:
		fprintf(stderr, "in %s: incremental base=%s is available with OP_LDRQ and OP_STRQ\n",
			id[current_prefix].name, id[insn[last_insn].imop.baseh].name);
		exit(1);
	      }
	      /* one_shotを使用し,アドレス計算の初回は,immediateを０として扱う */
	      insn[last_insn].imex.op0    = OP_ALWAYS;
	      insn[last_insn].imex.dist1v = T_IMMEDIATE;
	      insn[last_insn].imex.dist1h = hash_reg_immediate(size);
	    }
	  }
	  else if (insn[last_insn].imop.op == OP_LDDMQ) {
	    insn[last_insn].imop.updt    = 1; /* force automatic imcrement */
	    /* basev -> dexu->ex1v */
	    /* offsv -> dexu->ex2v */
	  }
	  else if (insn[last_insn].imop.op == OP_TR) {
	    insn[last_insn].imop.updt    = 1; /* force automatic imcrement */
	    insn[last_insn].imop.basev   = T_IMMEDIATE;
	    insn[last_insn].imop.baseh   = hash_reg_immediate(0LL); /* start from lmm_0 */
	    insn[last_insn].imop.bases   = -1;
	    insn[last_insn].imex.op0     = OP_ALWAYS;
	    insn[last_insn].imex.dist1v  = T_IMMEDIATE;
	    insn[last_insn].imex.dist1h  = hash_reg_immediate(32LL);
	  }
	  insn[last_insn].imop.offsm   = id[$13].val;
	  insn[last_insn].imop.topv    = id[$15].type;
	  insn[last_insn].imop.toph    = $15;
	  insn[last_insn].imop.lenv    = id[$17].type;
	  insn[last_insn].imop.lenh    = $17;
	  insn[last_insn].imop.blk     = id[$19].val;
	  insn[last_insn].imop.forcev  = id[$21].type; /* OP_LDは変数OK(lmr/lmp動的切替えOK), OP_STは定数のみ(lmw/lmxの動的切替えNG) */
	  insn[last_insn].imop.forceh  = $21;          /* OP_LDは変数OK(lmr/lmp動的切替えOK), OP_STは定数のみ(lmw/lmxの動的切替えNG) */
	  insn[last_insn].imop.ptopv   = id[$23].type;
	  insn[last_insn].imop.ptoph   = $23;
	  insn[last_insn].imop.plenv   = id[$25].type;
	  insn[last_insn].imop.plenh   = $25;
          last_insn++;
        }
        | CGRA_MOP "(" expr "," mop_ex "," mop_srcdst "," mop_base "," mop_offset "," expr "," mop_top "," mop_len "," expr "," force "," mop_top "," mop_len ")" ";" {
	  /* mop(load,  ex, BR[r][c][s], single_reg, offset, offset_mask, stream_top, length, block, force, ptop, plen); load requires target regs */
	  /* mop(store, ex, AR[r][c][s], single_reg, offset, offset_mask, stream_top, length, , blockforce, ptop, plen); store requires current ex */
          if (last_insn >= INSN_DEPTH) {
	    fprintf(stderr, "in %s: last_insn exceeds INSN_DEPTH=%d\n", id[current_prefix].name, INSN_DEPTH);
            exit(1);
          }
	  insn[last_insn].iheader.type = 8; /* MOP */
	  insn[last_insn].iheader.row  = id[ $7].type==T_ALRNO?(id[$7].val)                :id[ $3].val<OP_IM_BUFRD&&id[$7].type==T_BDRNO?(id[$7].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[ $7].type==T_ALRNO?(insn[last_insn].imop.mopds):id[ $3].val<OP_IM_BUFRD&&id[$7].type==T_BDRNO?(id[$7].val%EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].imop.op      = id[ $3].val;
	  insn[last_insn].imop.mtype   = get_mop_type(id[ $3].val);
	  insn[last_insn].imop.exv     = id[ $5].type;
	  insn[last_insn].imop.exh     = $5;
	  insn[last_insn].imop.mopdv   = id[ $7].type;
	  insn[last_insn].imop.mopdh   = $7;
	  insn[last_insn].imop.basev   = id[ $9].type;
	  insn[last_insn].imop.baseh   = $9;
	  insn[last_insn].imop.offsv   = id[$11].type;
	  insn[last_insn].imop.offsh   = $11;
	  if (insn[last_insn].imop.updt) { /* addr++ */
	    if (insn[last_insn].imop.offsv != T_IMMEDIATE || id[insn[last_insn].imop.offsh].val) { /* != zero */
	      fprintf(stderr, "in %s: incremental base=%s requires offset=0 (specified type=%d val=%d)\n",
		      id[current_prefix].name, id[insn[last_insn].imop.baseh].name, insn[last_insn].imop.offsv, id[insn[last_insn].imop.offsh].val);
	      exit(1);
	    }
	    else {
	      Ull size;
	      switch (insn[last_insn].imop.op) {
	      case OP_LDR:  case OP_STR:  size =  8LL; break;
	      case OP_LDWR: case OP_STWR: size =  4LL; break;
#if 0
	      case OP_LDHR: case OP_STHR: size =  2LL; break;
#endif
	      case OP_LDBR: case OP_STBR: size =  1LL; break;
	      default:
		fprintf(stderr, "in %s: incremental base=%s is available with OP_LD*R and OP_ST*R\n",
			id[current_prefix].name, id[insn[last_insn].imop.baseh].name);
		exit(1);
	      }
	      /* one_shotを使用し,アドレス計算の初回は,immediateを０として扱う */
	      insn[last_insn].imex.op0    = OP_ALWAYS;
	      insn[last_insn].imex.dist1v = T_IMMEDIATE;
	      insn[last_insn].imex.dist1h = hash_reg_immediate(size);
	    }
	  }
	  insn[last_insn].imop.offsm   = id[$13].val;
	  insn[last_insn].imop.topv    = id[$15].type;
	  insn[last_insn].imop.toph    = $15;
	  insn[last_insn].imop.lenv    = id[$17].type;
	  insn[last_insn].imop.lenh    = $17;
	  insn[last_insn].imop.blk     = id[$19].val;
	  insn[last_insn].imop.forcev  = id[$21].type; /* OP_LDは変数OK(lmr/lmp動的切替えOK), OP_STは定数のみ(lmw/lmxの動的切替えNG) */
	  insn[last_insn].imop.forceh  = $21;          /* OP_LDは変数OK(lmr/lmp動的切替えOK), OP_STは定数のみ(lmw/lmxの動的切替えNG) */
	  insn[last_insn].imop.ptopv   = id[$23].type;
	  insn[last_insn].imop.ptoph   = $23;
	  insn[last_insn].imop.plenv   = id[$25].type;
	  insn[last_insn].imop.plenh   = $25;
          last_insn++;
        }
        | "\}" {
        }
	| {
        }
        ;

cex_src : expr {
          $$ = $1;
        }
        | VARIABLE {
          $$ = $1;
	}
        | CGRA_ULL VARIABLE {
          $$ = $2;
	}
	; 

cex_dst : "\&" EXRNO {
          $$ = $2;
        }
	;

ex4_src : expr {
          $$ = $1;
        }
        | XVARIABLE { /* var ([UNIT_WIDTH]) */
          $$ = $1;
	}
        | CGRA_ULL XVARIABLE { /* var ([UNIT_WIDTH]) */
          $$ = $2;
	}
        | ALRNO { /* AR[r] ([UNIT_WIDTH]) */
          $$ = $1;
	}
        | BDRNO { /* BR[r][c] ([UNIT_WIDTH]) */
          $$ = $1;
	}
	;

ex4_dstd : XVARIABLE { /* var ([UNIT_WIDTH]) */
          $$ = $1;
	}
        | ALRNO { /* AR[r] ([UNIT_WIDTH]) */
          $$ = $1;
	}
	;

exe_src1 : expr {
	  insn[last_insn].iexe.src1s = -1;
          $$ = $1;
        }
        | XVARIABLE {
	  insn[last_insn].iexe.src1s = -1;
          $$ = $1;
	}
        | CGRA_ULL XVARIABLE {
	  insn[last_insn].iexe.src1s = -1;
          $$ = $2;
	}
        | ALRNO "\[" expr "\]" { /* AR[r][s] */
	  insn[last_insn].iexe.src1s = id[$3].val;
          $$ = $1;
	}
        | BDRNO "\[" expr "\]" { /* BR[r][c][s] */
	  insn[last_insn].iexe.src1s = id[$3].val;
          $$ = $1;
	}
	;

exe_src2 : expr {
	  insn[last_insn].iexe.src2s = -1;
          $$ = $1;
        }
        | XVARIABLE {
	  insn[last_insn].iexe.src2s = -1;
          $$ = $1;
	}
        | CGRA_ULL XVARIABLE {
	  insn[last_insn].iexe.src2s = -1;
          $$ = $2;
	}
        | ALRNO "\[" expr "\]" { /* AR[r][s] */
	  insn[last_insn].iexe.src2s = id[$3].val;
          $$ = $1;
	}
        | BDRNO "\[" expr "\]" { /* BR[r][c][s] */
	  insn[last_insn].iexe.src2s = id[$3].val;
          $$ = $1;
	}
	;

exe_src3 : expr {
	  insn[last_insn].iexe.src3s = -1;
          $$ = $1;
        }
        | XVARIABLE {
	  insn[last_insn].iexe.src3s = -1;
          $$ = $1;
	}
        | CGRA_ULL XVARIABLE {
	  insn[last_insn].iexe.src3s = -1;
          $$ = $2;
	}
        | ALRNO "\[" expr "\]" { /* AR[r][s] */
	  insn[last_insn].iexe.src3s = id[$3].val;
          $$ = $1;
	}
        | BDRNO "\[" expr "\]" { /* BR[r][c][s] */
	  insn[last_insn].iexe.src3s = id[$3].val;
          $$ = $1;
	}
	;

exe_src4 : expr {
	  insn[last_insn].iexe.src4s = -1;
          $$ = $1;
        }
        | XVARIABLE {
	  insn[last_insn].iexe.src4s = -1;
          $$ = $1;
	}
        | CGRA_ULL XVARIABLE {
	  insn[last_insn].iexe.src4s = -1;
          $$ = $2;
	}
        | ALRNO "\[" expr "\]" { /* AR[r][s] */
	  insn[last_insn].iexe.src4s = id[$3].val;
          $$ = $1;
	}
        | BDRNO "\[" expr "\]" { /* BR[r][c][s] */
	  insn[last_insn].iexe.src4s = id[$3].val;
          $$ = $1;
	}
	;

exe_src5 : expr {
	  insn[last_insn].iexe.src5s = -1;
          $$ = $1;
        }
        | XVARIABLE {
	  insn[last_insn].iexe.src5s = -1;
          $$ = $1;
	}
        | CGRA_ULL XVARIABLE {
	  insn[last_insn].iexe.src5s = -1;
          $$ = $2;
	}
        | ALRNO "\[" expr "\]" { /* AR[r][s] */
	  insn[last_insn].iexe.src5s = id[$3].val;
          $$ = $1;
	}
        | BDRNO "\[" expr "\]" { /* BR[r][c][s] */
	  insn[last_insn].iexe.src5s = id[$3].val;
          $$ = $1;
	}
	;

exe_dstd : "\&" XVARIABLE { /* &var */
	  insn[last_insn].iexe.exeds = -1;
          $$ = $2;
        }
        | "\&" ALRNO "\[" expr "\]" { /* &AR[r][s] */
	  insn[last_insn].iexe.exeds = id[$4].val;
          $$ = $2;
	}
	;

mex_adr1 : expr {
	  insn[last_insn].imex.adr1s = -1;
          $$ = $1;
        }
        | XVARIABLE {
	  insn[last_insn].imex.adr1s = -1;
          $$ = $1;
	}
        | CGRA_ULL XVARIABLE {
	  insn[last_insn].imex.adr1s = -1;
          $$ = $2;
	}
	;

mex_adr3 : expr {
	  insn[last_insn].imex.adr3s = -1;
          $$ = $1;
        }
        | XVARIABLE {
	  insn[last_insn].imex.adr3s = -1;
          $$ = $1;
	}
        | CGRA_ULL XVARIABLE {
	  insn[last_insn].imex.adr3s = -1;
          $$ = $2;
	}
	;

mex_src1 : expr {
	  insn[last_insn].imex.src1s = -1;
          $$ = $1;
        }
        | BDRNO "\[" expr "\]" { /* BR[r][c][s] */
	  insn[last_insn].imex.src1s = id[$3].val;
          $$ = $1;
        }
        ;

mex_src2 : expr {
	  insn[last_insn].imex.src2s = -1;
          $$ = $1;
        }
        | BDRNO "\[" expr "\]" { /* BR[r][c][s] */
	  insn[last_insn].imex.src2s = id[$3].val;
          $$ = $1;
        }
        ;

mex_dst1 : "\&" XVARIABLE {
	  insn[last_insn].imex.mexd0s = -1;
          $$ = $2;
	}
	;

mex_dst2 : "\&" XVARIABLE {
	  insn[last_insn].imex.mexd1s = -1;
          $$ = $2;
	}
	;

mop_ex : expr {
          $$ = $1;
        }
        | EXRNO { /* exx */
          $$ = $1;
	}
	;

mo4_srcdst : XVARIABLE { /* for load/store */
          $$ = $1;
	}
        | ALRNO { /* for store */
          $$ = $1;
	}
        | BDRNO { /* for load */
          $$ = $1;
        }
	;

mop_srcdst : "\&" XVARIABLE { /* for load/store */
	  insn[last_insn].imop.mopds = -1;
          $$ = $2;
	}
        | "\&" ALRNO "\[" expr "\]" { /* for store */
	  insn[last_insn].imop.mopds = id[$4].val;
          $$ = $2;
	}
        | "\&" BDRNO "\[" expr "\]" { /* for load */
	  insn[last_insn].imop.mopds = id[$4].val;
          $$ = $2;
        }
	;

mop_base : expr {
	  insn[last_insn].imop.bases = -1;
          $$ = $1;
        }
        | XVARIABLE {
	  insn[last_insn].imop.bases = -1;
          $$ = $1;
	}
        | CGRA_ULL XVARIABLE {
	  insn[last_insn].imop.bases = -1;
          $$ = $2;
	}
        | XVARIABLE CGRA_INCR {
	  insn[last_insn].imop.updt  = 1;
	  insn[last_insn].imop.bases = -1;
          $$ = $1;
	}
        | CGRA_ULL "(" XVARIABLE CGRA_INCR ")" {
	  insn[last_insn].imop.updt  = 1;
	  insn[last_insn].imop.bases = -1;
          $$ = $3;
	}
        | BDRNO "\[" expr "\]" {
	  insn[last_insn].imop.bases = id[$3].val;
          $$ = $1;
	}
	;

mop_offset : expr {
	  insn[last_insn].imop.offss = -1;
          $$ = $1;
        }
        | XVARIABLE {
	  insn[last_insn].imop.offss = -1;
          $$ = $1;
	}
        | CGRA_ULL XVARIABLE {
	  insn[last_insn].imop.offss = -1;
          $$ = $2;
	}
        | BDRNO "\[" expr "\]" {
	  insn[last_insn].imop.offss = id[$3].val;
          $$ = $1;
	}
	;

mop_top : expr {
          $$ = $1;
        }
        | XVARIABLE {
          $$ = $1;
	}
        | CGRA_ULL XVARIABLE {
          $$ = $2;
	}
	;

mop_len : expr {
          $$ = $1;
        }
        | VARIABLE {
          $$ = $1;
	}
        | CGRA_ULL VARIABLE {
          $$ = $2;
	}
	;

force : expr {
          $$ = $1;
        }
        | VARIABLE {
          $$ = $1;
	}
        | CGRA_ULL VARIABLE {
          $$ = $2;
	}
	;

XVARIABLE : CHIP {
          /*id[$1].chip = 1;*/
          $$ = $1;
        }
        | VARIABLE "[" CHIP "]" {
	  id[$1].cidx = 1;
          $$ = $1;
	}
        | VARIABLE {
          $$ = $1;
	}

expr : term {
          $$ = $1;
        }
        | expr "\+" term {
          int hashval;
	  strncpy(buf, "(",         BUF_MAXLEN-1);
	  strncat(buf, id[$1].name, BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, ")+(",       BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, id[$3].name, BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, ")",         BUF_MAXLEN-strlen(buf)-1);
	  if (!hash_search(buf, &hashval)) { /* not found */
	    id[hashval].type = T_IMMEDIATE;
	    id[hashval].val = id[$1].val + id[$3].val;
	  }
          $$ = hashval;
        }
        | expr "\-" term {
          int hashval;
	  strncpy(buf, "(",         BUF_MAXLEN-1);
	  strncat(buf, id[$1].name, BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, ")-(",       BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, id[$3].name, BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, ")",         BUF_MAXLEN-strlen(buf)-1);
	  if (!hash_search(buf, &hashval)) { /* not found */
	    id[hashval].type = T_IMMEDIATE;
	    id[hashval].val = id[$1].val - id[$3].val;
	  }
          $$ = hashval;
        }
        | expr CGRA_SLL term {
          int hashval;
	  strncpy(buf, "(",         BUF_MAXLEN-1);
	  strncat(buf, id[$1].name, BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, ")<<(",      BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, id[$3].name, BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, ")",         BUF_MAXLEN-strlen(buf)-1);
	  if (!hash_search(buf, &hashval)) { /* not found */
	    id[hashval].type = T_IMMEDIATE;
	    id[hashval].val = id[$1].val << id[$3].val;
	  }
          $$ = hashval;
        }
        | expr CGRA_SRL term {
          int hashval;
	  strncpy(buf, "(",         BUF_MAXLEN-1);
	  strncat(buf, id[$1].name, BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, ")>>(",      BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, id[$3].name, BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, ")",         BUF_MAXLEN-strlen(buf)-1);
	  if (!hash_search(buf, &hashval)) { /* not found */
	    id[hashval].type = T_IMMEDIATE;
	    id[hashval].val = id[$1].val >> id[$3].val;
	  }
          $$ = hashval;
        }
        | expr "\&" term {
          int hashval;
	  strncpy(buf, "(",         BUF_MAXLEN-1);
	  strncat(buf, id[$1].name, BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, ")&(",       BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, id[$3].name, BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, ")",         BUF_MAXLEN-strlen(buf)-1);
	  if (!hash_search(buf, &hashval)) { /* not found */
	    id[hashval].type = T_IMMEDIATE;
	    id[hashval].val = id[$1].val & id[$3].val;
	  }
          $$ = hashval;
        }
        | expr "\^" term {
          int hashval;
	  strncpy(buf, "(",         BUF_MAXLEN-1);
	  strncat(buf, id[$1].name, BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, ")^(",       BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, id[$3].name, BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, ")",         BUF_MAXLEN-strlen(buf)-1);
	  if (!hash_search(buf, &hashval)) { /* not found */
	    id[hashval].type = T_IMMEDIATE;
	    id[hashval].val = id[$1].val ^ id[$3].val;
	  }
          $$ = hashval;
        }
        | expr "\|" term {
          int hashval;
	  strncpy(buf, "(",         BUF_MAXLEN-1);
	  strncat(buf, id[$1].name, BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, ")|(",       BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, id[$3].name, BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, ")",         BUF_MAXLEN-strlen(buf)-1);
	  if (!hash_search(buf, &hashval)) { /* not found */
	    id[hashval].type = T_IMMEDIATE;
	    id[hashval].val = id[$1].val | id[$3].val;
	  }
          $$ = hashval;
        }
        ;

term : factor {
          $$ = $1;
        }
        | "\~" factor {
          int hashval;
	  strncpy(buf, "~(",        BUF_MAXLEN-1);
	  strncat(buf, id[$2].name, BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, ")",         BUF_MAXLEN-strlen(buf)-1);
	  if (!hash_search(buf, &hashval)) { /* not found */
	    id[hashval].type = T_IMMEDIATE;
	    id[hashval].val = ~ id[$2].val;
	  }
          $$ = hashval;
        }
        | "-" factor {
          int hashval;
	  strncpy(buf, "-(",        BUF_MAXLEN-1);
	  strncat(buf, id[$2].name, BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, ")",         BUF_MAXLEN-strlen(buf)-1);
	  if (!hash_search(buf, &hashval)) { /* not found */
	    id[hashval].type = T_IMMEDIATE;
	    id[hashval].val = - id[$2].val;
	  }
          $$ = hashval;
        }
        | term "\*" factor {
          int hashval;
	  strncpy(buf, "(",         BUF_MAXLEN-1);
	  strncat(buf, id[$1].name, BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, ")*(",       BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, id[$3].name, BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, ")",         BUF_MAXLEN-strlen(buf)-1);
	  if (!hash_search(buf, &hashval)) { /* not found */
	    id[hashval].type = T_IMMEDIATE;
	    id[hashval].val = id[$1].val * id[$3].val;
	  }
          $$ = hashval;
        }
        | term "\/" factor {
          int hashval;
	  strncpy(buf, "(",         BUF_MAXLEN-1);
	  strncat(buf, id[$1].name, BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, ")/(",       BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, id[$3].name, BUF_MAXLEN-strlen(buf)-1);
	  strncat(buf, ")",         BUF_MAXLEN-strlen(buf)-1);
	  if (!hash_search(buf, &hashval)) { /* not found */
	    id[hashval].type = T_IMMEDIATE;
	    id[hashval].val = id[$1].val / id[$3].val;
	  }
          $$ = hashval;
        }
        ;

factor : "(" expr ")" {
          $$ = $2;
        }
        | number {
          $$ = $1;
        }
        ;

number : IMMEDIATE {
          $$ = $1;
        }
        | CGRA_ULL IMMEDIATE {
          $$ = $2;
        }
        | CGRA_UINT IMMEDIATE {
          $$ = $2;
        }
        ;

EMAX6TBODY : TRAN_READ {
          trans[trans_pc].rw = 0; /* READ */
	}
        | TRAN_WRITE {
          trans[trans_pc].rw = 1; /* WRITE */
        }
        ;

%%

#include "conv-c2c.h"
#include "emax6.h"
#include "lex.yy.c"

hash(s) register char *s;
{
  register int    hashval;

  for (hashval=0; *s!=0;)
    hashval += *s++;
  return(hashval % ID_NUM+1);
}

hash_clear()
{
  register int    i;

  for (i=0; i<ID_NUM; i++) {
    id[i].name  = NULL;
    id[i].type  = 0;
    id[i].itype = 0;
    id[i].row   = 0;
    id[i].col   = 0;
  }
}

hash_search(buf, reth) char *buf; int *reth;
{
  /* return 0 ... new id[reth] is assigned */
  /* return 1 ... old id[reth] is found */
  char *bufptr;
  int  hashval, hashsave, buflen;

  /* hash */
  hashval = hashsave = hash(buf);
  while (id[hashval].name != NULL) {
    if (!strncmp(buf, id[hashval].name, BUF_MAXLEN)) {
      *reth = hashval;
      return (1);
    }
    hashval = rehash(hashval);
    if (hashval == hashsave)
      break;
  }
  if (id[hashval].name != NULL) {
    yyerror("too many IDs");
    fprintf(stderr, "current ID_NUM is %d\n", ID_NUM);
    exit(1);
  }

  /* new number */
  buflen = strlen(buf)+1;
  id[hashval].name = bufptr = malloc(buflen);
  id[hashval].row = -1; /* init */
  id[hashval].col = -1; /* init */
  strncpy(bufptr, buf, buflen);
  *reth = hashval;
  return(0);
}

hash_reg_immediate(imm) Ull imm;
{
  int hashval;
  /* return hashval */
  snprintf(buf, BUF_MAXLEN, "%lldLL", imm);
  if (!hash_search(buf, &hashval)) { /* not found */
    id[hashval].type = T_IMMEDIATE;
    id[hashval].val = imm;
  }
  return (hashval);
}

yyerror(s) char *s;
{
  if (++y_errornum == 1)
    fprintf(stderr, "\n");
#if 0
  fprintf(stderr, "line %d: \"%s\": %s.\n", y_lineno, yytext, s);
#endif
  /* lex -l により,yylinenoが使える */
  fprintf(stderr, "err%d: line %d: \"%s\": %s.\n", y_errornum, yylineno, yytext, s);
}
@


1.101
log
@*** empty log message ***
@
text
@d449 2
a450 2
	  /* new mex(OP_CMPA_LE, &b0[h][0], INIT0?b[0]:b0[h][0], OP_CMPA_GE, &a0[h][0][CHIP], INIT0?a[h][CHIP]:a0[h][0][CHIP], 0LL, INIT0?0:8,     BR[r][2][1], BR[r][2][0]);*/
	  /* new mex(OP_CMPA_LE, &J[x],     INIT0?0LL:J[x],      OP_CMPA_GE, &K[x],           INIT0?0LL:K[x],                  BE8, INIT0?0LL:8LL, BR[r][2][1], BR[r][2][0]);*/
@


1.100
log
@*** empty log message ***
@
text
@d508 4
a511 4
	  insn[last_insn].imex.mexd1v  = id[$21].type;
	  insn[last_insn].imex.mexd1h  = $21;
	  insn[last_insn].imex.mexd2v  = id[ $5].type;
	  insn[last_insn].imex.mexd2h  = $5;
d860 1
a860 1
	  insn[last_insn].imex.mexd1s = -1;
d866 1
a866 1
	  insn[last_insn].imex.mexd2s = -1;
@


1.99
log
@*** empty log message ***
@
text
@d445 2
a446 2
        | CGRA_MEX "(" expr "," mex_dst2 "," INITNO "?" mex_adr3 ":" XVARIABLE "," expr "," mex_dst1 "," INITNO "?" mex_adr1 ":" XVARIABLE "," expr "," INITNO "?" expr ":" expr "," mex_src2 "," mex_src1 ")" ";" {
          /*  1     2    3   4     5      6    7     8      9     10     11     12  13   14    15    16    17    18    19     20    21      22  23   24   25    26  27   28  29   30    31    32     33 */
d462 1
a462 1
	  if (loop_no0 != id[$17].val || loop_no0 != id[$25].val) {
d466 1
a466 1
	  if ($5 != $11 || $15 != $21) {
d470 1
a470 1
	  if (id[$27].val != 0) {
d474 1
a474 1
	  if (id[$31].val != id[$33].val) {
d483 3
a485 3
	  insn[last_insn].iheader.row  = id[$31].type==T_BDRNO?(id[$31].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[$31].type==T_BDRNO?(id[$31].val%EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].imex.op0     = id[$13].val; /* activate self_update */
d488 4
a491 4
	  insn[last_insn].imex.adr1v   = id[$19].type; 
	  insn[last_insn].imex.adr1h   = $19;
	  insn[last_insn].imex.adr2v   = id[$21].type;
	  insn[last_insn].imex.adr2h   = $21;
d493 2
d500 10
a509 10
	  insn[last_insn].imex.limitv  = id[$23].type;
	  insn[last_insn].imex.limith  = $23;
	  insn[last_insn].imex.distv   = id[$29].type;
	  insn[last_insn].imex.disth   = $29;
	  insn[last_insn].imex.src1v   = id[$33].type;
	  insn[last_insn].imex.src1h   = $33;
	  insn[last_insn].imex.src2v   = id[$31].type;
	  insn[last_insn].imex.src2h   = $31;
	  insn[last_insn].imex.mexd1v  = id[$15].type;
	  insn[last_insn].imex.mexd1h  = $15;
d551 3
a553 3
	      insn[last_insn].imex.op0     = OP_ALWAYS;
	      insn[last_insn].imex.distv   = T_IMMEDIATE;
	      insn[last_insn].imex.disth   = hash_reg_immediate(size);
d567 2
a568 2
	    insn[last_insn].imex.distv   = T_IMMEDIATE;
	    insn[last_insn].imex.disth   = hash_reg_immediate(32LL);
d625 3
a627 3
	      insn[last_insn].imex.op0     = OP_ALWAYS;
	      insn[last_insn].imex.distv   = T_IMMEDIATE;
	      insn[last_insn].imex.disth   = hash_reg_immediate(size);
@


1.98
log
@*** empty log message ***
@
text
@d445 6
a450 6
        | CGRA_MEX "(" expr "," mex_dst2 "," INITNO "?" mex_adr3 ":" XVARIABLE "," mex_dst1 "," INITNO "?" mex_adr1 ":" XVARIABLE "," expr "," INITNO "?" expr ":" expr "," mex_src2 "," mex_src1 ")" ";" {
          /*  1     2    3   4     5      6    7     8      9      10     11     12    13    14    15    16      17    18    19      20  21   22   23    24  25   26  27   28    29    30    31 */
	  /* old mex(OP_CMPA_LE,  &b0[h],       INIT0?b:b0[h],                INIT0?0:8, BR[r][2][1], BR[r][2][0]);*/
	  /* old mex(OP_CMPA_GE,  &a0[h][CHIP], INIT0?a[h][CHIP]:a0[h][CHIP], INIT0?0:8, BR[r][2][1], BR[r][2][0]);*/
	  /* new mex(OP_CMPA_LEGE,&b0[h][0], INIT0?b[0]:b0[h][0], &a0[h][0][CHIP], INIT0?a[h][CHIP]:a0[h][0][CHIP], 0LL, INIT0?0:8,     BR[r][2][1], BR[r][2][0]);*/
	  /* new mex(OP_CMPA_LEGE,&J[x],     INIT0?0LL:J[x],      &K[x],           INIT0?0LL:K[x],                  BE8, INIT0?0LL:8LL, BR[r][2][1], BR[r][2][0]);*/
d462 1
a462 1
	  if (loop_no0 != id[$15].val || loop_no0 != id[$23].val) {
d466 1
a466 1
	  if ($5 != $11 || $13 != $19) {
d470 1
a470 1
	  if (id[$25].val != 0) {
d474 2
a475 2
	  if (id[$29].val != id[$31].val) {
	    fprintf(stderr, "in %s: mex(src2[%d][%d],src1[%d][%d]) should be the same row/col\n", id[current_prefix].name, (Uint)id[$29].val/EMAX_WIDTH, (Uint)id[$29].val%EMAX_WIDTH, (Uint)id[$31].val/EMAX_WIDTH, (Uint)id[$31].val%EMAX_WIDTH);
d479 1
a479 1
	    fprintf(stderr, "in %s: mex(src2[%d][%d][%d],src1[%d][%d][%d]) should be src2[][][1] and src1[][][0]\n", id[current_prefix].name, (Uint)id[$29].val/EMAX_WIDTH, (Uint)id[$29].val%EMAX_WIDTH, insn[last_insn].imex.src2s, (Uint)id[$31].val/EMAX_WIDTH, (Uint)id[$31].val%EMAX_WIDTH, insn[last_insn].imex.src1s);
d483 4
a486 3
	  insn[last_insn].iheader.row  = id[$29].type==T_BDRNO?(id[$29].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[$29].type==T_BDRNO?(id[$29].val%EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].imex.op      = id[ $3].val; /* activate self_update */
d488 4
a491 4
	  insn[last_insn].imex.adr1v   = id[$17].type; 
	  insn[last_insn].imex.adr1h   = $17;
	  insn[last_insn].imex.adr2v   = id[$19].type;
	  insn[last_insn].imex.adr2h   = $19;
d498 10
a507 10
	  insn[last_insn].imex.limitv  = id[$21].type;
	  insn[last_insn].imex.limith  = $21;
	  insn[last_insn].imex.distv   = id[$27].type;
	  insn[last_insn].imex.disth   = $27;
	  insn[last_insn].imex.src1v   = id[$31].type;
	  insn[last_insn].imex.src1h   = $31;
	  insn[last_insn].imex.src2v   = id[$29].type;
	  insn[last_insn].imex.src2h   = $29;
	  insn[last_insn].imex.mexd1v  = id[$13].type;
	  insn[last_insn].imex.mexd1h  = $13;
d549 1
a549 1
	      insn[last_insn].imex.op      = OP_ALWAYS;
d564 1
a564 1
	    insn[last_insn].imex.op      = OP_ALWAYS;
d623 1
a623 1
	      insn[last_insn].imex.op      = OP_ALWAYS;
@


1.97
log
@*** empty log message ***
@
text
@d519 2
a520 2
	  insn[last_insn].iheader.row  = id[ $3].val<OP_IM_BUFRD&&id[ $7].type==T_ALRNO?(id[$7].val):id[ $3].val<OP_IM_BUFRD&&id[$7].type==T_BDRNO?(id[$7].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[ $3].val<OP_IM_BUFRD&&id[ $7].type==T_ALRNO?(        -1):id[ $3].val<OP_IM_BUFRD&&id[$7].type==T_BDRNO?(id[$7].val%EMAX_WIDTH):-1; /* adr/bdr */
@


1.96
log
@*** empty log message ***
@
text
@d589 2
a590 2
	  insn[last_insn].iheader.row  = id[ $3].val<OP_IM_BUFRD&&id[ $7].type==T_ALRNO?(id[$7].val)                :id[ $3].val<OP_IM_BUFRD&&id[$7].type==T_BDRNO?(id[$7].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[ $3].val<OP_IM_BUFRD&&id[ $7].type==T_ALRNO?(insn[last_insn].imop.mopds):id[ $3].val<OP_IM_BUFRD&&id[$7].type==T_BDRNO?(id[$7].val%EMAX_WIDTH):-1; /* adr/bdr */
@


1.95
log
@*** empty log message ***
@
text
@d444 9
a452 5
        | CGRA_MEX "(" expr "," mex_dst "," INITNO "?" XVARIABLE ":" XVARIABLE "," INITNO "?" expr ":" expr "," mex_src3 "," mex_src4 ")" ";" {
	  /* mex(OP_CMPA_LE, &b0[h],       INIT0?b:b0[h],                INIT0?0:8, BR[r][2][1], BR[r][2][0]); */
	  /* mex(OP_CMPA_GE, &a0[h][CHIP], INIT0?a[h][CHIP]:a0[h][CHIP], INIT0?0:8, BR[r][2][1], BR[r][2][0]); */
	  /* mop(OP_LDR, 3,  &BR[r][2][1], b0[h],       bofs, MSK_W1, b,          2*LP*RMGRP,  0, 0, NULL, 2*LP*RMGRP); */
	  /* mop(OP_LDR, 3,  &BR[r][2][0], a0[h][CHIP], cofs, MSK_W1, a[h][CHIP], 2*LP,        0, 0, NULL, 2*LP); */
d462 2
a463 2
	  if ($5 != $11) {
	    fprintf(stderr, "in %s: exe(dst,INIT0?src1:src2) dst and src2 should be the same\n", id[current_prefix].name);
d466 2
a467 2
	  if (loop_no0 != id[$13].val) {
	    fprintf(stderr, "in %s: mex() INIT# mismatch\n", id[current_prefix].name);
d470 2
a471 2
	  if (id[$15].val != 0) {
	    fprintf(stderr, "in %s: mex(INIT0?expr1:expr2) expr1 should be zero\n", id[current_prefix].name);
d474 2
a475 2
	  if (id[$19].val != id[$21].val) {
	    fprintf(stderr, "in %s: mex(src3[%d][%d],src4[%d][%d]) should be the same row/col\n", id[current_prefix].name, (Uint)id[$19].val/EMAX_WIDTH, (Uint)id[$19].val%EMAX_WIDTH, (Uint)id[$21].val/EMAX_WIDTH, (Uint)id[$21].val%EMAX_WIDTH);
d478 2
a479 2
	  if (insn[last_insn].imex.src3s != 1 || insn[last_insn].imex.src4s != 0) {
	    fprintf(stderr, "in %s: mex(src3[%d][%d][%d],src4[%d][%d][%d]) should be src3[][][1] and src4[][][0]\n", id[current_prefix].name, (Uint)id[$19].val/EMAX_WIDTH, (Uint)id[$19].val%EMAX_WIDTH, insn[last_insn].imex.src3s, (Uint)id[$21].val/EMAX_WIDTH, (Uint)id[$21].val%EMAX_WIDTH, insn[last_insn].imex.src4s);
d483 2
a484 2
	  insn[last_insn].iheader.row  = id[$19].type==T_BDRNO?(id[$19].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[$19].type==T_BDRNO?(id[$19].val%EMAX_WIDTH):-1; /* adr/bdr */
d487 22
a508 14
	  insn[last_insn].imex.src1v   = id[ $9].type;
	  insn[last_insn].imex.src1h   = $9;
	  insn[last_insn].imex.src1s   = -1;
	  insn[last_insn].imex.src2v   = id[$11].type;
	  insn[last_insn].imex.src2h   = $11;
	  insn[last_insn].imex.src2s   = -1;
	  insn[last_insn].imex.distv   = id[$17].type;
	  insn[last_insn].imex.disth   = $17;
	  insn[last_insn].imex.src3v   = id[$19].type;
	  insn[last_insn].imex.src3h   = $19;
	  insn[last_insn].imex.src4v   = id[$21].type;
	  insn[last_insn].imex.src4h   = $21;
	  insn[last_insn].imex.mexdv   = id[ $5].type;
	  insn[last_insn].imex.mexdh   = $5;
d519 2
a520 2
	  insn[last_insn].iheader.row  = id[ $7].type==T_ALRNO?(id[$7].val):id[$7].type==T_BDRNO?(id[$7].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[ $7].type==T_ALRNO?(        -1):id[$7].type==T_BDRNO?(id[$7].val%EMAX_WIDTH):-1; /* adr/bdr */
d589 2
a590 2
	  insn[last_insn].iheader.row  = id[ $7].type==T_ALRNO?(id[$7].val)                :id[$7].type==T_BDRNO?(id[$7].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[ $7].type==T_ALRNO?(insn[last_insn].imop.mopds):id[$7].type==T_BDRNO?(id[$7].val%EMAX_WIDTH):-1; /* adr/bdr */
d808 2
a809 2
mex_src1 : XVARIABLE {
	  insn[last_insn].imex.src1s = -1;
d812 9
a820 1
        ;
d822 2
a823 2
mex_src2 : XVARIABLE {
	  insn[last_insn].imex.src2s = -1;
d826 9
a834 1
        ;
d836 2
a837 2
mex_src3 : expr {
	  insn[last_insn].iexe.src3s = -1;
d841 1
a841 1
	  insn[last_insn].imex.src3s = id[$3].val;
d846 2
a847 2
mex_src4 : expr {
	  insn[last_insn].iexe.src4s = -1;
d851 1
a851 1
	  insn[last_insn].imex.src4s = id[$3].val;
d856 8
a863 2
mex_dst : "\&" XVARIABLE {
	  insn[last_insn].imex.mexds = -1;
@


1.94
log
@*** empty log message ***
@
text
@a62 6
#if 0
          fprintf(ofile, "volatile struct { struct regv_breg breg[%d][%d] ;} *emax6_breg_%s  = emax6.reg_breg;\n",  EMAX_DEPTH, EMAX_WIDTH, id[current_prefix].name);
          fprintf(ofile, "volatile struct { struct regv_addr addr[%d][%d] ;} *emax6_addr_%s  = emax6.reg_addr;\n",  EMAX_DEPTH, EMAX_WIDTH, id[current_prefix].name);
          fprintf(ofile, "volatile struct { struct lddmr     lddmr[%d][%d];} *emax6_lddmr_%s = emax6.reg_lddmr;\n", EMAX_DEPTH, EMAX_WIDTH, id[current_prefix].name);
          fprintf(ofile, "volatile struct { struct lddmw     lddmw[%d][%d];} *emax6_lddmw_%s = emax6.reg_lddmw;\n", EMAX_DEPTH, EMAX_WIDTH, id[current_prefix].name);
#endif
@


1.93
log
@*** empty log message ***
@
text
@a173 1
	      fprintf(ofile, "#ifndef EMAXSC\n");
a174 1
	      fprintf(ofile, "#endif\n");
d178 1
a178 2
	  else {
	    fprintf(ofile, "#ifndef EMAXSC\n");
a179 2
	    fprintf(ofile, "#endif\n");
	  }
@


1.92
log
@*** empty log message ***
@
text
@d609 2
a610 2
	      case OP_LDR:  case OP_STR:                 size =  8LL; break;
	      case OP_LDWR: case OP_LDUWR: case OP_STWR: size =  4LL; break;
d612 1
a612 1
	      case OP_LDHR: case OP_LDUHR: case OP_STHR: size =  2LL; break;
d614 1
a614 1
	      case OP_LDBR: case OP_LDUBR: case OP_STBR: size =  1LL; break;
@


1.91
log
@*** empty log message ***
@
text
@d136 1
a136 1
	  fprintf(ofile, "\t  ((struct reg_ctrl*)emax6.reg_ctrl)->i[0].mcid = %d; // NCHIP-1\n", current_nchip-1);
@


1.90
log
@*** empty log message ***
@
text
@a46 1
	  int c;
a62 6
	  forinit_cidx[0] = 0;
          forinit_cidx[1] = 0;
          for (c=0; c<EMAX_NCHIP; c++) {
            forinit[0][c][0]='\0';
            forinit[1][c][0]='\0';
          }
a176 1
	      snprintf(forinit[loop_no][c], BUF_MAXLEN, "%s[%d] = %s", id[$11].name, c, buf);
a177 1
	    forinit_cidx[loop_no] = 1; /* CHIP */
a183 2
	    snprintf(forinit[loop_no][0], BUF_MAXLEN, "%s = %s", id[$11].name, id[$13].name);
            forinit_cidx[loop_no] = 0; /* !CHIP */
@


1.89
log
@*** empty log message ***
@
text
@d47 1
d61 1
d63 7
d142 1
d144 1
d181 1
d183 2
d186 1
d189 2
a190 1
	  else
d192 4
d509 1
a509 1
	  insn[last_insn].imex.src2h   = $15;
d516 1
a516 1
	  insn[last_insn].imex.src4h   = $25;
@


1.88
log
@*** empty log message ***
@
text
@d15 4
a18 3
%token  CGRA_ULL     CGRA_UINT     CGRA_SLL   CGRA_SRL
%token  CGRA_WHILE   CGRA_FOR      CGRA_CEX
%token	CGRA_EX4     CGRA_EXE      CGRA_MO4   CGRA_MOP
d146 1
a146 1
	    fprintf(stderr, "in %s: for() includes INIT#/LOOP# mismatch\n", id[current_prefix].name);
d206 1
a206 1
	  insn[last_insn].icex.bit1v   = id[ $11].type;
d213 1
a213 1
	  insn[last_insn].icex.cexdv   = id[$5].type;
d225 2
a226 2
	  insn[last_insn].iheader.row  = id[$5].type==T_ALRNO?(id[$5].val):id[$5].type==T_BDRNO?(id[$5].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[$5].type==T_ALRNO?(        -1):id[$5].type==T_BDRNO?(id[$5].val%EMAX_WIDTH):-1; /* adr/bdr */
d236 1
a236 1
	  insn[last_insn].iexe.src2v   = id[ $11].type;
d262 2
a263 2
	  insn[last_insn].iheader.row  = id[$5].type==T_ALRNO?(id[$5].val)                :id[$5].type==T_BDRNO?(id[$5].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[$5].type==T_ALRNO?(insn[last_insn].iexe.exeds):id[$5].type==T_BDRNO?(id[$5].val%EMAX_WIDTH):-1; /* adr/bdr */
d272 1
a272 1
	  insn[last_insn].iexe.src2v   = id[ $11].type;
d301 1
a301 1
	    fprintf(stderr, "in %s: exe(INIT0?src1:src1) should be specified\n", id[current_prefix].name);
d305 2
a306 2
	  insn[last_insn].iheader.row  = id[$5].type==T_ALRNO?(id[$5].val)                :id[$5].type==T_BDRNO?(id[$5].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[$5].type==T_ALRNO?(insn[last_insn].iexe.exeds):id[$5].type==T_BDRNO?(id[$5].val%EMAX_WIDTH):-1; /* adr/bdr */
d340 2
a341 2
	  insn[last_insn].iheader.row  = id[$5].type==T_ALRNO?(id[$5].val)                :id[$5].type==T_BDRNO?(id[$5].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[$5].type==T_ALRNO?(insn[last_insn].iexe.exeds):id[$5].type==T_BDRNO?(id[$5].val%EMAX_WIDTH):-1; /* adr/bdr */
d350 1
a350 1
	  insn[last_insn].iexe.src2v   = id[ $11].type;
d381 2
a382 2
	  insn[last_insn].iheader.row  = id[$5].type==T_ALRNO?(id[$5].val)                :id[$5].type==T_BDRNO?(id[$5].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[$5].type==T_ALRNO?(insn[last_insn].iexe.exeds):id[$5].type==T_BDRNO?(id[$5].val%EMAX_WIDTH):-1; /* adr/bdr */
d390 2
a391 2
	  insn[last_insn].iexe.src1e   = id[ $13].val;
	  insn[last_insn].iexe.src2v   = id[ $15].type;
d422 2
a423 2
	  insn[last_insn].iheader.row  = id[$5].type==T_ALRNO?(id[$5].val)                :id[$5].type==T_BDRNO?(id[$5].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[$5].type==T_ALRNO?(insn[last_insn].iexe.exeds):id[$5].type==T_BDRNO?(id[$5].val%EMAX_WIDTH):-1; /* adr/bdr */
d432 1
a432 1
	  insn[last_insn].iexe.src2v   = id[ $13].type;
d446 55
d508 3
a510 3
	  insn[last_insn].iheader.type = 6; /* MO4 */
	  insn[last_insn].iheader.row  = id[$7].type==T_ALRNO?(id[$7].val):id[$7].type==T_BDRNO?(id[$7].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[$7].type==T_ALRNO?(        -1):id[$7].type==T_BDRNO?(id[$7].val%EMAX_WIDTH):-1; /* adr/bdr */
d538 3
a540 2
	      insn[last_insn].imop.offsv   = T_IMMEDIATE;
	      insn[last_insn].imop.offsh   = hash_reg_immediate(size);
d553 3
a555 3
	    insn[last_insn].imop.offsv   = T_IMMEDIATE;
	    insn[last_insn].imop.offsh   = hash_reg_immediate(32LL);
	    insn[last_insn].imop.offss   = -1;
d578 3
a580 3
	  insn[last_insn].iheader.type = 7; /* MOP */
	  insn[last_insn].iheader.row  = id[$7].type==T_ALRNO?(id[$7].val)                :id[$7].type==T_BDRNO?(id[$7].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[$7].type==T_ALRNO?(insn[last_insn].imop.mopds):id[$7].type==T_BDRNO?(id[$7].val%EMAX_WIDTH):-1; /* adr/bdr */
d612 3
a614 2
	      insn[last_insn].imop.offsv   = T_IMMEDIATE;
	      insn[last_insn].imop.offsh   = hash_reg_immediate(size);
d798 38
d882 1
a882 1
	  insn[last_insn].imop.updt = 1;
d887 1
a887 1
	  insn[last_insn].imop.updt = 1;
@


1.87
log
@*** empty log message ***
@
text
@d254 77
@


1.86
log
@*** empty log message ***
@
text
@d468 1
d470 1
@


1.85
log
@*** empty log message ***
@
text
@d368 1
a368 1
        | CGRA_MO4 "(" expr "," mop_ex "," mo4_srcdst "," mop_base "," mop_offset "," expr "," mop_top "," mop_len "," expr "," expr "," mop_top "," mop_len ")" ";" {
d429 2
a430 1
	  insn[last_insn].imop.force   = id[$21].val;
d437 1
a437 1
        | CGRA_MOP "(" expr "," mop_ex "," mop_srcdst "," mop_base "," mop_offset "," expr "," mop_top "," mop_len "," expr "," expr "," mop_top "," mop_len ")" ";" {
d486 2
a487 1
	  insn[last_insn].imop.force   = id[$21].val;
d762 11
@


1.84
log
@*** empty log message ***
@
text
@a550 8
        | VARIABLE "\[" expr "\]" { /* var[s] */
	  insn[last_insn].iexe.src1s = id[$3].val;
          $$ = $1;
        }
        | CGRA_ULL VARIABLE "\[" expr "\]" { /* var[s] */
	  insn[last_insn].iexe.src1s = id[$4].val;
          $$ = $2;
        }
a572 8
        | VARIABLE "\[" expr "\]" { /* var[s] */
	  insn[last_insn].iexe.src2s = id[$3].val;
          $$ = $1;
        }
        | CGRA_ULL VARIABLE "\[" expr "\]" { /* var[s] */
	  insn[last_insn].iexe.src2s = id[$4].val;
          $$ = $2;
        }
a594 8
        | VARIABLE "\[" expr "\]" { /* var[s] */
	  insn[last_insn].iexe.src3s = id[$3].val;
          $$ = $1;
        }
        | CGRA_ULL VARIABLE "\[" expr "\]" { /* var[s] */
	  insn[last_insn].iexe.src3s = id[$4].val;
          $$ = $2;
        }
a616 8
        | VARIABLE "\[" expr "\]" { /* var[s] */
	  insn[last_insn].iexe.src4s = id[$3].val;
          $$ = $1;
        }
        | CGRA_ULL VARIABLE "\[" expr "\]" { /* var[s] */
	  insn[last_insn].iexe.src4s = id[$4].val;
          $$ = $2;
        }
a638 8
        | VARIABLE "\[" expr "\]" { /* var[s] */
	  insn[last_insn].iexe.src5s = id[$3].val;
          $$ = $1;
        }
        | CGRA_ULL VARIABLE "\[" expr "\]" { /* var[s] */
	  insn[last_insn].iexe.src5s = id[$4].val;
          $$ = $2;
        }
a652 4
        | "\&" VARIABLE "\[" expr "\]" { /* &var[s] */
	  insn[last_insn].iexe.exeds = id[$4].val;
          $$ = $2;
        }
a681 4
        | "\&" VARIABLE "\[" expr "\]" { /* for load/store */
	  insn[last_insn].imop.mopds = id[$4].val;
          $$ = $2;
        }
@


1.83
log
@*** empty log message ***
@
text
@d92 7
a98 1
EMAX6ABODY : CGRA_WHILE "(" VARIABLE CGRA_DECR ")" "\{" {
@


1.82
log
@*** empty log message ***
@
text
@a116 1
          current_nchip = id[$9].val; /* should be <= MAXCORE */
d121 6
@


1.81
log
@*** empty log message ***
@
text
@d143 18
a160 3
	    int c;
	    for (c=0; c<current_nchip; c++)
	      fprintf(ofile, "\t%s[%d] = %s;\n", id[$11].name, c, id[$13].name);
@


1.80
log
@*** empty log message ***
@
text
@d799 3
a801 2
	  strncpy(buf, id[$1].name, BUF_MAXLEN-1);
	  strncat(buf, "+", 1);
d803 1
a803 1
	  buf[BUF_MAXLEN-1] = 0;
d812 3
a814 2
	  strncpy(buf, id[$1].name, BUF_MAXLEN-1);
	  strncat(buf, "-", 1);
d816 1
a816 1
	  buf[BUF_MAXLEN-1] = 0;
d825 3
a827 2
	  strncpy(buf, id[$1].name, BUF_MAXLEN-1);
	  strncat(buf, "<<", 2);
d829 1
a829 1
	  buf[BUF_MAXLEN-1] = 0;
d838 3
a840 2
	  strncpy(buf, id[$1].name, BUF_MAXLEN-1);
	  strncat(buf, ">>", 2);
d842 1
a842 1
	  buf[BUF_MAXLEN-1] = 0;
d851 3
a853 2
	  strncpy(buf, id[$1].name, BUF_MAXLEN-1);
	  strncat(buf, "&", 1);
d855 1
a855 1
	  buf[BUF_MAXLEN-1] = 0;
d864 3
a866 2
	  strncpy(buf, id[$1].name, BUF_MAXLEN-1);
	  strncat(buf, "^", 1);
d868 1
a868 1
	  buf[BUF_MAXLEN-1] = 0;
d877 3
a879 2
	  strncpy(buf, id[$1].name, BUF_MAXLEN-1);
	  strncat(buf, "|", 1);
d881 1
a881 1
	  buf[BUF_MAXLEN-1] = 0;
d895 1
a895 2
	  buf[0] = '~';
	  buf[1] = 0;
d897 1
a897 1
	  buf[BUF_MAXLEN-1] = 0;
d906 1
a906 2
	  buf[0] = '-';
	  buf[1] = 0;
d908 1
a908 1
	  buf[BUF_MAXLEN-1] = 0;
d917 3
a919 2
	  strncpy(buf, id[$1].name, BUF_MAXLEN-1);
	  strncat(buf, "*", 1);
d921 1
a921 1
	  buf[BUF_MAXLEN-1] = 0;
d930 3
a932 2
	  strncpy(buf, id[$1].name, BUF_MAXLEN-1);
	  strncat(buf, "/", 1);
d934 1
a934 1
	  buf[BUF_MAXLEN-1] = 0;
@


1.79
log
@*** empty log message ***
@
text
@a24 1
%token  VARIABLE
d29 1
d31 2
a32 1
%token  INITNO
d123 1
a123 1
        | CGRA_FOR "(" INITNO "=" expr "," LOOPNO "=" expr "," XVARIABLE "=" expr ";" LOOPNO CGRA_DECR ";" INITNO "=" expr ")" "\{" {
d141 1
a141 1
	  fprintf(ofile, "\t%s = %lld;\n", id[ $7].name, id[ $9].val);
d145 1
a145 1
	      fprintf(ofile, "\t%s[%d] = %lld;\n", id[$11].name, c, id[$13].val);
d148 1
a148 1
	    fprintf(ofile, "\t%s = %lld;\n", id[$11].name, id[$13].val);
@


1.78
log
@*** empty log message ***
@
text
@d141 6
a146 1
	  if (!id[$11].chip)
a147 5
	  else {
	    int i;
	    for (i=0; i<current_nchip; i++)
	      fprintf(ofile, "\t%s[%d] = %lld;\n", id[$11].name, i, id[$13].val);
	  }
d782 1
a782 1
	  id[$1].chip = 1;
d786 1
a786 1
	  id[$1].chip = 1;
@


1.77
log
@*** empty log message ***
@
text
@d29 2
a31 1
%token  LOOPNO
d48 1
d115 8
a122 1
        | CGRA_FOR "(" INITNO "=" expr "," LOOPNO "=" expr "," VARIABLE "=" expr ";" LOOPNO CGRA_DECR ";" INITNO "=" expr ")" "\{" {
d141 7
a147 1
	  fprintf(ofile, "\t%s = %lld;\n", id[$11].name, id[$13].val);
d490 1
a490 1
        | VARIABLE { /* var ([UNIT_WIDTH]) */
d493 1
a493 1
        | CGRA_ULL VARIABLE { /* var ([UNIT_WIDTH]) */
d504 1
a504 1
ex4_dstd : VARIABLE { /* var ([UNIT_WIDTH]) */
d516 1
a516 1
        | VARIABLE {
d520 1
a520 1
        | CGRA_ULL VARIABLE {
d546 1
a546 1
        | VARIABLE {
d550 1
a550 1
        | CGRA_ULL VARIABLE {
d576 1
a576 1
        | VARIABLE {
d580 1
a580 1
        | CGRA_ULL VARIABLE {
d606 1
a606 1
        | VARIABLE {
d610 1
a610 1
        | CGRA_ULL VARIABLE {
d636 1
a636 1
        | VARIABLE {
d640 1
a640 1
        | CGRA_ULL VARIABLE {
d662 1
a662 1
exe_dstd : "\&" VARIABLE { /* &var */
d684 1
a684 1
mo4_srcdst : VARIABLE { /* for load/store */
d695 1
a695 1
mop_srcdst : "\&" VARIABLE { /* for load/store */
d717 1
a717 1
        | VARIABLE {
d721 1
a721 1
        | CGRA_ULL VARIABLE {
d725 1
a725 1
        | VARIABLE CGRA_INCR {
d730 1
a730 1
        | CGRA_ULL "(" VARIABLE CGRA_INCR ")" {
d745 1
a745 1
        | VARIABLE {
d749 1
a749 1
        | CGRA_ULL VARIABLE {
d762 1
a762 1
        | VARIABLE {
d765 1
a765 1
        | CGRA_ULL VARIABLE {
d781 12
@


1.76
log
@*** empty log message ***
@
text
@d148 1
a148 1
	  insn[last_insn].iexe.exedh   = $3;
@


1.75
log
@*** empty log message ***
@
text
@d244 1
a244 1
        | CGRA_EXE "(" expr "," exe_dstd "," exe_src1 "," expr "," INITNO "?" exe_src2 ":" expr "," expr "," exe_src3 "," expr "," expr "," exe_src4 "," expr "," exe_src5 ")" ";" {
d247 1
a247 1
	  int loop_no0 = id[$11].val;
d256 2
a257 2
	  if (id[$15].val != 0) {
	    fprintf(stderr, "in %s: exe(INIT0?expr1:expr2) expr2 should be zero\n", id[current_prefix].name);
d266 7
a272 7
	  insn[last_insn].iexe.updt    = ($5 == $7)?1:0; /* if (src1 == dstd) self_update=1 */
	  insn[last_insn].iexe.init    = 1; /* activate s2+INIT0 */
	  insn[last_insn].iexe.src1v   = id[ $7].type;
	  insn[last_insn].iexe.src1h   = $7;
	  insn[last_insn].iexe.src1e   = id[ $9].val;
	  insn[last_insn].iexe.src2v   = id[ $13].type;
	  insn[last_insn].iexe.src2h   = $13;
d285 1
a285 1
        | CGRA_EXE "(" expr "," exe_dstd "," exe_src1 "," expr "," INITNO "?" exe_src2 ":" expr "," expr "," INITNO "?" exe_src3 ":" expr "," expr "," exe_src4 "," expr "," exe_src5 ")" ";" {
a288 1
	  int loop_no1 = id[$19].val;
d293 2
a294 2
	  if (loop_no0 != 0 || loop_no1 != 1 ) {
	    fprintf(stderr, "in %s: exe(INIT0?expr:0, INIT1?expr:0) should be specified\n", id[current_prefix].name);
d297 2
a298 2
	  if (id[$15].val != 0 || id[$23].val != 0) {
	    fprintf(stderr, "in %s: exe(INIT#?expr1:expr2) expr2 should be zero\n", id[current_prefix].name);
d305 2
a306 2
	  insn[last_insn].iexe.op2     = id[$25].val;
	  insn[last_insn].iexe.op3     = id[$29].val;
d308 1
a308 1
	  insn[last_insn].iexe.init    = 3; /* activate s3+INIT1 and s2+INIT0 */
d315 7
a321 7
	  insn[last_insn].iexe.src3v   = id[$21].type;
	  insn[last_insn].iexe.src3h   = $21;
	  insn[last_insn].iexe.src3e   = id[$23].val;
	  insn[last_insn].iexe.src4v   = id[$27].type;
	  insn[last_insn].iexe.src4h   = $27;
	  insn[last_insn].iexe.src5v   = id[$31].type;
	  insn[last_insn].iexe.src5h   = $31;
@


1.74
log
@*** empty log message ***
@
text
@d267 1
a267 1
	  insn[last_insn].iexe.init    = 1<<loop_no0;
d306 2
a307 2
	  insn[last_insn].iexe.op2     = id[$23].val;
	  insn[last_insn].iexe.op3     = id[$27].val;
d309 1
a309 1
	  insn[last_insn].iexe.init    = (1<<loop_no1)|(1<<loop_no0);
@


1.73
log
@*** empty log message ***
@
text
@d244 1
a244 1
        | CGRA_EXE "(" expr "," exe_dstd "," exe_src1 "," expr "," INITNO "?" expr ":" expr "," expr "," exe_src3 "," expr "," expr "," exe_src4 "," expr "," exe_src5 ")" ";" {
d285 1
a285 1
        | CGRA_EXE "(" expr "," exe_dstd "," exe_src1 "," expr "," INITNO "?" expr ":" expr "," expr "," INITNO "?" expr ":" expr "," expr "," exe_src4 "," expr "," exe_src5 ")" ";" {
@


1.72
log
@*** empty log message ***
@
text
@d11 2
a12 2
%token  EMAX6ABEGIN     EMAX6ASTATEM    EMAX6AEND	EMAX6ADRAIN
%token  EMAX6TBEGIN     EMAX6TSTATEM    EMAX6TEND
d15 4
a18 6
%token  CGRA_ULL        CGRA_UINT
%token  CGRA_SLL	CGRA_SRL
%token  CGRA_WHILE	CGRA_CEX
%token	CGRA_EX4	CGRA_EXE
%token	CGRA_MO4	CGRA_MOP
%token	CGRA_DECR	CGRA_INCR
d29 2
d99 1
d113 39
d157 1
a157 1
	  insn[last_insn].iheader.type = 2; /* CEX */
d181 1
a181 1
	  insn[last_insn].iheader.type = 3; /* EX4 */
d188 1
d219 1
a219 1
	  insn[last_insn].iheader.type = 4; /* EXE */
d226 1
d244 83
d334 1
a334 1
	  insn[last_insn].iheader.type = 5; /* MO4 */
d402 1
a402 1
	  insn[last_insn].iheader.type = 6; /* MOP */
d767 4
a770 1
expr : expr "\*" sexpr {
d773 13
a785 1
	  strncat(buf, "*", 1);
d790 1
a790 1
	    id[hashval].val = id[$1].val * id[$3].val;
d794 1
a794 1
        | expr "\/" sexpr {
d797 1
a797 1
	  strncat(buf, "/", 1);
d802 1
a802 1
	    id[hashval].val = id[$1].val / id[$3].val;
d806 1
a806 1
        | expr "\%" sexpr {
d809 1
a809 1
	  strncat(buf, "%", 1);
d814 1
a814 1
	    id[hashval].val = id[$1].val % id[$3].val;
d818 1
a818 1
        | expr "\&" sexpr {
d830 1
a830 1
        | expr "\^" sexpr {
d842 1
a842 1
        | expr "\|" sexpr {
a853 3
        | sexpr {
          $$ = $1;
        }
d856 1
a856 1
sexpr : IMMEDIATE {
d859 1
a859 7
        | CGRA_ULL IMMEDIATE {
          $$ = $2;
        }
        | CGRA_UINT IMMEDIATE {
          $$ = $2;
        }
        | "\~" IMMEDIATE {
d871 1
a871 1
        | "-" IMMEDIATE {
d883 1
a883 1
        | "(" sexpr CGRA_SLL sexpr ")" {
d885 3
a887 3
	  strncpy(buf, id[$2].name, BUF_MAXLEN-1);
	  strncat(buf, "<<", 2);
	  strncat(buf, id[$4].name, BUF_MAXLEN-strlen(buf)-1);
d891 1
a891 1
	    id[hashval].val = id[$2].val << id[$4].val;
d895 1
a895 1
        | "(" sexpr CGRA_SRL sexpr ")" {
d897 3
a899 3
	  strncpy(buf, id[$2].name, BUF_MAXLEN-1);
	  strncat(buf, ">>", 2);
	  strncat(buf, id[$4].name, BUF_MAXLEN-strlen(buf)-1);
d903 1
a903 1
	    id[hashval].val = id[$2].val >> id[$4].val;
d909 19
@


1.71
log
@*** empty log message ***
@
text
@d348 4
a351 1
ex4_src : VARIABLE { /* var ([UNIT_WIDTH]) */
@


1.70
log
@*** empty log message ***
@
text
@d57 1
d62 1
@


1.69
log
@*** empty log message ***
@
text
@d57 4
a60 4
          fprintf(ofile, "volatile struct { struct addr  addr[%d][%d] ;} *emax6_addr_%s  = emax6.reg_addr;\n",  EMAX_DEPTH, EMAX_WIDTH, id[current_prefix].name);
          fprintf(ofile, "volatile struct { struct breg  breg[%d][%d] ;} *emax6_breg_%s  = emax6.reg_breg;\n",  EMAX_DEPTH, EMAX_WIDTH, id[current_prefix].name);
          fprintf(ofile, "volatile struct { struct lddmr lddmr[%d][%d];} *emax6_lddmr_%s = emax6.reg_lddmr;\n", EMAX_DEPTH, EMAX_WIDTH, id[current_prefix].name);
          fprintf(ofile, "volatile struct { struct lddmw lddmw[%d][%d];} *emax6_lddmw_%s = emax6.reg_lddmw;\n", EMAX_DEPTH, EMAX_WIDTH, id[current_prefix].name);
@


1.68
log
@*** empty log message ***
@
text
@d55 1
d57 4
a60 8
          if (y_emax6a_seqno >= ACP_CONF_MAX) {
	    fprintf(stderr, "in %s: y_emax6a_seqno exceeds ACP_CONF_MAX=%d\n", id[current_prefix].name, ACP_CONF_MAX);
            exit(1);
          }
	  /* lmmiは1wayあたり,16B*16行=0.25KB,16B*64行=1KB(最大). 4way分連続にするには,16行で1KB,64行で4KBアラインが必要.  ZYNQのpage-sizeが4KB以上であればOK */
          fprintf(ofile, "volatile struct { struct { Uint ctl, ofs; Ull top;} lmmi[%d][%d];} *emax6_lmmi_%s = acp_lmmi;\n", EMAX_WIDTH, EMAX_DEPTH, id[current_prefix].name);
	  /* regvは1wayあたり,64B*16行=1KB,   64B*64行=4KB(最大). 4way分連続にするには,16行で4KB,64行で16KBアラインが必要. ZYNQのpage-sizeが16KB以上であればOK */
          fprintf(ofile, "volatile struct { struct { Ull ea0br, ea0or, ea1br, ea1or; Ull br[%d];} regv[%d][%d];} *emax6_regv_%s = acp_regv;\n", UNIT_WIDTH, EMAX_WIDTH, EMAX_DEPTH, id[current_prefix].name);
@


1.67
log
@*** empty log message ***
@
text
@d786 1
a786 1
#include "conv-c2e.h"
@


1.66
log
@*** empty log message ***
@
text
@d2 1
a2 1
/* EMAX5 Compiler                      */
d11 2
a12 2
%token  EMAX5ABEGIN     EMAX5ASTATEM    EMAX5AEND	EMAX5ADRAIN
%token  EMAX5TBEGIN     EMAX5TSTATEM    EMAX5TEND
d43 2
a44 2
        | EMAX5ABEGIN VARIABLE expr { /* reset conf[][] */
          printf("==EMAX5AB reading line=%d name=%s\n", y_lineno, id[$2].name);
d55 3
a57 3
          fprintf(ofile, "volatile emax5_conf_%s();\n", id[current_prefix].name);
          if (y_emax5a_seqno >= ACP_CONF_MAX) {
	    fprintf(stderr, "in %s: y_emax5a_seqno exceeds ACP_CONF_MAX=%d\n", id[current_prefix].name, ACP_CONF_MAX);
d61 1
a61 1
          fprintf(ofile, "volatile struct { struct { Uint ctl, ofs; Ull top;} lmmi[%d][%d];} *emax5_lmmi_%s = acp_lmmi;\n", EMAX_WIDTH, EMAX_DEPTH, id[current_prefix].name);
d63 1
a63 1
          fprintf(ofile, "volatile struct { struct { Ull ea0br, ea0or, ea1br, ea1or; Ull br[%d];} regv[%d][%d];} *emax5_regv_%s = acp_regv;\n", UNIT_WIDTH, EMAX_WIDTH, EMAX_DEPTH, id[current_prefix].name);
d65 1
a65 1
        | EMAX5ASTATEM EMAX5ABODY {
d67 2
a68 2
        | EMAX5AEND {
	  emit_emax5a(0);
d71 2
a72 2
        | EMAX5ADRAIN {
	  emit_emax5a(1);
d75 2
a76 2
        | EMAX5TBEGIN VARIABLE { /* reset tconf[][] */
          printf("==EMAX5TB reading line=%d name=%s\n", y_lineno, id[$2].name);
d82 1
a82 1
        | EMAX5TSTATEM EMAX5TBODY {
d84 2
a85 2
        | EMAX5TEND {
	  emit_emax5t(0);
d90 1
a90 1
EMAX5ABODY : CGRA_WHILE "(" VARIABLE CGRA_DECR ")" "\{" {
d776 1
a776 1
EMAX5TBODY : TRAN_READ {
d786 2
a787 2
#include "conv-c2d.h"
#include "emax5.h"
@


1.65
log
@*** empty log message ***
@
text
@d45 1
a45 1
          current_prefix = $2;
d47 1
@


1.64
log
@*** empty log message ***
@
text
@d243 5
@


1.63
log
@*** empty log message ***
@
text
@d234 1
a234 1
		fprintf(stderr, "in %s: incremental base=%s is available with OP_LDRQ, OP_STRQ\n",
d243 9
d299 1
a299 1
		fprintf(stderr, "in %s: incremental base=%s is available with OP_LDR, OP_STR, OP_LD[U][WHB]R, OP_ST[WHB]R\n",
@


1.62
log
@*** empty log message ***
@
text
@d150 1
a150 1
	  insn[last_insn].iexe.src1s   = -1; /* no suffix */
d154 1
a154 1
	  insn[last_insn].iexe.src2s   = -1; /* no suffix */
d158 1
a158 1
	  insn[last_insn].iexe.src3s   = -1; /* no suffix */
d162 1
a162 1
	  insn[last_insn].iexe.src4s   = -1; /* no suffix */
d165 1
a165 1
	  insn[last_insn].iexe.src5s   = -1; /* no suffix */
d168 1
a168 1
	  insn[last_insn].iexe.exeds   = -1; /* no suffix */
d218 1
a218 1
	  insn[last_insn].imop.mopds   = -1;
@


1.61
log
@*** empty log message ***
@
text
@d15 1
a15 1
%token  CGRA_ULL        CGRA_UINT	CGRA_NULL
d557 5
a561 1
mop_base : VARIABLE {
d603 4
a606 1
mop_top : VARIABLE {
a611 3
        | CGRA_ULL CGRA_NULL {
          $$ = -1;
        }
d705 6
@


1.60
log
@*** empty log message ***
@
text
@d49 2
a50 2
	  bzero(&dec, sizeof(dec));
	  bzero(&bus, sizeof(bus));
d53 1
d60 1
a60 1
          fprintf(ofile, "volatile struct { struct { Ull low, high;} lmmi[%d][%d];} *emax5_lmmi_%s = acp_lmmi;\n", EMAX_WIDTH, EMAX_DEPTH, id[current_prefix].name);
d202 3
a204 3
        | CGRA_MO4 "(" expr "," mop_ex "," mo4_srcdst "," mop_base "," mop_offset "," expr "," mop_stream "," expr "," expr "," expr "," mop_stream ")" ";" {
	  /* mop(load,  ex, BR[r][c][s], single_reg, offset, offset_mask, stream_top, block, length, force, ptop); load requires target regs */
	  /* mop(store, ex, AR[r][c][s], single_reg, offset, offset_mask, stream_top, block, length, force, ptop); store requires current ex */
d246 3
a248 2
	  insn[last_insn].imop.blk     = id[$17].val;
	  insn[last_insn].imop.len     = id[$19].val-1; /* for axi */
d252 2
d256 3
a258 3
        | CGRA_MOP "(" expr "," mop_ex "," mop_srcdst "," mop_base "," mop_offset "," expr "," mop_stream "," expr "," expr "," expr "," mop_stream ")" ";" {
	  /* mop(load,  ex, BR[r][c][s], single_reg, offset, offset_mask, stream_top, block, length, force, ptop); load requires target regs */
	  /* mop(store, ex, AR[r][c][s], single_reg, offset, offset_mask, stream_top, block, length, force, ptop); store requires current ex */
d302 3
a304 2
	  insn[last_insn].imop.blk     = id[$17].val;
	  insn[last_insn].imop.len     = id[$19].val-1; /* for axi */
d308 2
d599 1
a599 1
mop_stream : VARIABLE {
d610 11
@


1.59
log
@*** empty log message ***
@
text
@d231 1
a231 1
	      case OP_LDRQ: case OP_LDBFQ: case OP_STRQ: case OP_STBFQ:	size = 32LL; break;
d233 1
a233 1
		fprintf(stderr, "in %s: incremental base=%s is available with OP_LDRQ, OP_LDBFQ, OP_STRQ, OP_STBFQ\n",
d281 4
a284 4
	      case OP_LDR:  case OP_LDBF:  case OP_STR:  case OP_STBF:  size =  8LL; break;
	      case OP_LDWR: case OP_LDUWR: case OP_STWR:                size =  4LL; break;
	      case OP_LDHR: case OP_LDUHR: case OP_STHR:                size =  2LL; break;
	      case OP_LDBR: case OP_LDUBR: case OP_STBR:                size =  1LL; break;
d286 1
a286 1
		fprintf(stderr, "in %s: incremental base=%s is available with OP_LDR, OP_LDBF, OP_STR, OP_STBF, OP_LD[U][WHB]R, OP_ST[WHB]R\n",
@


1.58
log
@*** empty log message ***
@
text
@d54 4
d59 1
a59 1
          fprintf(ofile, "volatile struct { Ull low, high;} emax5_lmmi_%s[%d][%d] __attribute__((aligned(4096)));\n", id[current_prefix].name, EMAX_WIDTH, EMAX_DEPTH);
d61 1
a61 1
          fprintf(ofile, "volatile struct { Ull ea0br, ea0or, ea1br, ea1or; Ull br[%d];} emax5_regv_%s[%d][%d] __attribute__((aligned(16384)));\n", UNIT_WIDTH, id[current_prefix].name, EMAX_WIDTH, EMAX_DEPTH);
@


1.57
log
@*** empty log message ***
@
text
@d54 3
a56 1
          fprintf(ofile, "volatile struct { Ull low, high;} emax5_lmmi_%s[%d][%d] __attribute__((aligned(16384)));\n", id[current_prefix].name, EMAX_WIDTH, EMAX_DEPTH);
@


1.56
log
@*** empty log message ***
@
text
@d54 2
a55 2
          fprintf(ofile, "volatile struct { Ull low, high;} emax5_lmmi_%s[%d][%d] __attribute__((aligned(128)));\n", id[current_prefix].name, EMAX_WIDTH, EMAX_DEPTH);
          fprintf(ofile, "volatile struct { Ull ea0br, ea0or, ea1br, ea1or; Ull br[%d];} emax5_regv_%s[%d][%d] __attribute__((aligned(128)));\n", UNIT_WIDTH, id[current_prefix].name, EMAX_WIDTH, EMAX_DEPTH);
@


1.55
log
@*** empty log message ***
@
text
@d301 2
@


1.54
log
@*** empty log message ***
@
text
@d61 1
d65 1
d78 1
d748 13
@


1.53
log
@*** empty log message ***
@
text
@d102 1
a102 1
        | CGRA_CEX "(" expr "," cex_src "," cex_src "," cex_src "," cex_src "," expr "," cex_dst ")" ";" {
d111 11
a121 11
	  insn[last_insn].icex.bit0v   = id[$11].type;
	  insn[last_insn].icex.bit0h   = $11;
	  insn[last_insn].icex.bit1v   = id[ $9].type;
	  insn[last_insn].icex.bit1h   = $9;
	  insn[last_insn].icex.bit2v   = id[ $7].type;
	  insn[last_insn].icex.bit2h   = $7;
	  insn[last_insn].icex.bit3v   = id[ $5].type;
	  insn[last_insn].icex.bit3h   = $5;
	  insn[last_insn].icex.table   = id[$13].val;
	  insn[last_insn].icex.cexdv   = id[$15].type;
	  insn[last_insn].icex.cexdh   = $15;
d124 1
a124 1
        | CGRA_EX4 "(" expr "," ex4_src "," expr "," ex4_src "," expr "," ex4_src "," expr "," expr "," ex4_src "," expr "," ex4_src "," ex4_dstd ")" ";" {
d132 2
a133 2
	  insn[last_insn].iheader.row  = id[$25].type==T_ALRNO?(id[$25].val):id[$25].type==T_BDRNO?(id[$25].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[$25].type==T_ALRNO?(         -1):id[$25].type==T_BDRNO?(id[$25].val%EMAX_WIDTH):-1; /* adr/bdr */
d135 5
a139 5
	  insn[last_insn].iexe.op2     = id[$17].val;
	  insn[last_insn].iexe.op3     = id[$21].val;
	  insn[last_insn].iexe.updt    = ($5 == $25)?1:0; /* if (src1 == dstd) self_update=1 */
	  insn[last_insn].iexe.src1v   = id[ $5].type;
	  insn[last_insn].iexe.src1h   = $5;
d141 3
a143 3
	  insn[last_insn].iexe.src1e   = id[ $7].val;
	  insn[last_insn].iexe.src2v   = id[ $9].type;
	  insn[last_insn].iexe.src2h   = $9;
d145 3
a147 3
	  insn[last_insn].iexe.src2e   = id[$11].val;
	  insn[last_insn].iexe.src3v   = id[$13].type;
	  insn[last_insn].iexe.src3h   = $13;
d149 3
a151 3
	  insn[last_insn].iexe.src3e   = id[$15].val;
	  insn[last_insn].iexe.src4v   = id[$19].type;
	  insn[last_insn].iexe.src4h   = $19;
d153 2
a154 2
	  insn[last_insn].iexe.src5v   = id[$23].type;
	  insn[last_insn].iexe.src5h   = $23;
d156 2
a157 2
	  insn[last_insn].iexe.exedv   = id[$25].type;
	  insn[last_insn].iexe.exedh   = $25;
d161 1
a161 1
        | CGRA_EXE "(" expr "," exe_src1 "," expr "," exe_src2 "," expr "," exe_src3 "," expr "," expr "," exe_src4 "," expr "," exe_src5 "," exe_dstd ")" ";" {
d169 2
a170 2
	  insn[last_insn].iheader.row  = id[$25].type==T_ALRNO?(id[$25].val)               :id[$25].type==T_BDRNO?(id[$25].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[$25].type==T_ALRNO?(insn[last_insn].iexe.exeds):id[$25].type==T_BDRNO?(id[$25].val%EMAX_WIDTH):-1; /* adr/bdr */
d172 18
a189 18
	  insn[last_insn].iexe.op2     = id[$17].val;
	  insn[last_insn].iexe.op3     = id[$21].val;
	  insn[last_insn].iexe.updt    = ($5 == $25)?1:0; /* if (src1 == dstd) self_update=1 */
	  insn[last_insn].iexe.src1v   = id[ $5].type;
	  insn[last_insn].iexe.src1h   = $5;
	  insn[last_insn].iexe.src1e   = id[ $7].val;
	  insn[last_insn].iexe.src2v   = id[ $9].type;
	  insn[last_insn].iexe.src2h   = $9;
	  insn[last_insn].iexe.src2e   = id[$11].val;
	  insn[last_insn].iexe.src3v   = id[$13].type;
	  insn[last_insn].iexe.src3h   = $13;
	  insn[last_insn].iexe.src3e   = id[$15].val;
	  insn[last_insn].iexe.src4v   = id[$19].type;
	  insn[last_insn].iexe.src4h   = $19;
	  insn[last_insn].iexe.src5v   = id[$23].type;
	  insn[last_insn].iexe.src5h   = $23;
	  insn[last_insn].iexe.exedv   = id[$25].type;
	  insn[last_insn].iexe.exedh   = $25;
@


1.52
log
@*** empty log message ***
@
text
@d169 2
a170 2
	  insn[last_insn].iheader.row  = id[$25].type==T_ALRNO?(id[$25].val):id[$25].type==T_BDRNO?(id[$25].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[$25].type==T_ALRNO?(         -1):id[$25].type==T_BDRNO?(id[$25].val%EMAX_WIDTH):-1; /* adr/bdr */
d251 2
a252 2
	  insn[last_insn].iheader.row  = id[$7].type==T_ALRNO?(id[$7].val):id[$7].type==T_BDRNO?(id[$7].val/EMAX_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[$7].type==T_ALRNO?(        -1):id[$7].type==T_BDRNO?(id[$7].val%EMAX_WIDTH):-1; /* adr/bdr */
@


1.51
log
@*** empty log message ***
@
text
@d237 1
a237 1
	  insn[last_insn].imop.len     = id[$19].val;
d290 1
a290 1
	  insn[last_insn].imop.len     = id[$19].val;
@


1.50
log
@*** empty log message ***
@
text
@d11 2
a12 2
%token  EMAX5ASTART     EMAX5ADESCR    EMAX5AEND
%token  EMAX5TSTART     EMAX5TDESCR    EMAX5TEND
d43 2
a44 2
        | EMAX5ASTART VARIABLE expr { /* reset conf[][] */
          printf("==EMAX5AS reading line=%d name=%s\n", y_lineno, id[$2].name);
d57 1
a57 1
        | EMAX5ADESCR EMAX5ABODY {
d60 1
a60 1
	  emit_emax5a();
d62 5
a66 2
        | EMAX5TSTART VARIABLE { /* reset tconf[][] */
          printf("==EMAX5TS reading line=%d name=%s\n", y_lineno, id[$2].name);
d72 1
a72 1
        | EMAX5TDESCR EMAX5TBODY {
d75 1
a75 1
	  emit_emax5t();
@


1.49
log
@*** empty log message ***
@
text
@d54 1
a54 1
          fprintf(ofile, "volatile struct { Ull high, low;} emax5_lmmi_%s[%d][%d] __attribute__((aligned(128)));\n", id[current_prefix].name, EMAX_WIDTH, EMAX_DEPTH);
@


1.48
log
@*** empty log message ***
@
text
@d54 1
a55 1
          fprintf(ofile, "volatile struct { Ull high, low;} emax5_lmmi_%s[%d][%d] __attribute__((aligned(128)));\n", id[current_prefix].name, EMAX_WIDTH, EMAX_DEPTH);
@


1.47
log
@*** empty log message ***
@
text
@a338 4
        | EXRNO { /* CMOV */
	  insn[last_insn].iexe.src1s = -1;
          $$ = $1;
	}
@


1.46
log
@*** empty log message ***
@
text
@a85 1
	  insn[last_insn].iexe.adjust  = 1; /* pre_adjust is required for implementing a-- w/ --a */
d210 20
d260 23
a549 1
	  insn[last_insn].imop.adjust = 1;
a554 1
	  insn[last_insn].imop.adjust = 1;
d737 9
d756 1
a756 1
    if (!strcmp(buf, id[hashval].name)) {
d780 1
a780 1
hash(s) register char *s;
d782 8
a789 5
  register int    hashval;

  for (hashval=0; *s!=0;)
    hashval += *s++;
  return(hashval % ID_NUM+1);
@


1.45
log
@*** empty log message ***
@
text
@d52 1
d55 1
a55 1
          fprintf(ofile, "volatile struct { Ull v:1; Ull rw:1; Ull f:1; Ull p:1; Ull blk:2; Ull len:21; Ull dmy:37; Ull top:64;} emax5_lmmi_%s[%d][%d] __attribute__((aligned(128)));\n", id[current_prefix].name, EMAX_WIDTH, EMAX_DEPTH);
@


1.44
log
@*** empty log message ***
@
text
@d54 1
a54 1
          fprintf(ofile, "volatile struct { Ull v:1; Ull top:63; Ull blk:2; Ull dist:9; Ull len:21; Ull rw:1; Ull f:1; Ull p:1; Ull dmy:29;} emax5_lmmi_%s[%d][%d] __attribute__((aligned(128)));\n", id[current_prefix].name, EMAX_WIDTH, EMAX_DEPTH);
d189 3
a191 3
        | CGRA_MO4 "(" expr "," mop_ex "," mo4_srcdst "," mop_base "," mop_offset "," expr "," mop_stream "," expr "," expr "," expr "," expr "," mop_stream ")" ";" {
	  /* mop(load,  ex, BR[r][c][s], single_reg, offset, offset_mask, stream_top, distance, length, force); load requires target regs */
	  /* mop(store, ex, AR[r][c][s], single_reg, offset, offset_mask, stream_top, distance, length, force); store requires current ex */
d214 4
a217 5
	  insn[last_insn].imop.dist    = id[$19].val;
	  insn[last_insn].imop.len     = id[$21].val;
	  insn[last_insn].imop.force   = id[$23].val;
	  insn[last_insn].imop.ptopv   = id[$25].type;
	  insn[last_insn].imop.ptoph   = $25;
d220 3
a222 3
        | CGRA_MOP "(" expr "," mop_ex "," mop_srcdst "," mop_base "," mop_offset "," expr "," mop_stream "," expr "," expr "," expr "," expr "," mop_stream ")" ";" {
	  /* mop(load,  ex, BR[r][c][s], single_reg, offset, offset_mask, stream_top, distance, length, force); load requires target regs */
	  /* mop(store, ex, AR[r][c][s], single_reg, offset, offset_mask, stream_top, distance, length, force); store requires current ex */
d244 4
a247 5
	  insn[last_insn].imop.dist    = id[$19].val;
	  insn[last_insn].imop.len     = id[$21].val;
	  insn[last_insn].imop.force   = id[$23].val;
	  insn[last_insn].imop.ptopv   = id[$25].type;
	  insn[last_insn].imop.ptoph   = $25;
d552 37
a588 1
expr : expr "\&" sexpr {
@


1.43
log
@*** empty log message ***
@
text
@d54 1
a54 1
          fprintf(ofile, "volatile struct { Ull v:1; Ull top:63; Ull dist:9; Ull len:21; Ull rw:1; Ull f:1; Ull blk:2; Ull dmy:30;} emax5_lmmi_%s[%d][%d] __attribute__((aligned(128)));\n", id[current_prefix].name, EMAX_WIDTH, EMAX_DEPTH);
@


1.42
log
@*** empty log message ***
@
text
@d189 1
a189 1
        | CGRA_MO4 "(" expr "," mop_ex "," mo4_srcdst "," mop_base "," mop_offset "," expr "," mop_stream "," expr "," expr "," expr "," mop_stream ")" ";" {
d213 6
a218 5
	  insn[last_insn].imop.dist    = id[$17].val;
	  insn[last_insn].imop.len     = id[$19].val;
	  insn[last_insn].imop.force   = id[$21].val;
	  insn[last_insn].imop.ptopv   = id[$23].type;
	  insn[last_insn].imop.ptoph   = $15;
d221 1
a221 1
        | CGRA_MOP "(" expr "," mop_ex "," mop_srcdst "," mop_base "," mop_offset "," expr "," mop_stream "," expr "," expr "," expr "," mop_stream ")" ";" {
d244 6
a249 5
	  insn[last_insn].imop.dist    = id[$17].val;
	  insn[last_insn].imop.len     = id[$19].val;
	  insn[last_insn].imop.force   = id[$21].val;
	  insn[last_insn].imop.ptopv   = id[$23].type;
	  insn[last_insn].imop.ptoph   = $15;
@


1.41
log
@*** empty log message ***
@
text
@d54 1
a54 1
          fprintf(ofile, "volatile struct { Ull v:1; Ull top:63; Ull dist:9; Ull len:21; Ull rw:1; Ull f:1; Ull dmy:32;} emax5_lmmi_%s[%d][%d] __attribute__((aligned(128)));\n", id[current_prefix].name, EMAX_WIDTH, EMAX_DEPTH);
@


1.40
log
@*** empty log message ***
@
text
@d49 2
a50 2
	  bzero(&decode, sizeof(decode));
	  bzero(&busmap, sizeof(busmap));
@


1.39
log
@*** empty log message ***
@
text
@d53 2
a54 2
          fprintf(ofile, "volatile struct { Ull ea0br, ea0or, ea1br, ea1or; Ull br[%d];} emax5_regv_%s[%d][%d];\n", UNIT_WIDTH, id[current_prefix].name, EMAX_WIDTH, EMAX_DEPTH);
          fprintf(ofile, "volatile struct { Ull v:1; Ull top:63; Ull dist:9; Ull len:21; Ull rw:1; Ull f:1; Ull dmy0:32; Ull pv:1; Ull preftop:63; Ull prefdist:9; Ull preflen:21; Ull prw:1; Ull dmy1:33;} emax5_lmmi_%s[%d][%d];\n", id[current_prefix].name, EMAX_WIDTH, EMAX_DEPTH);
d189 1
a189 1
        | CGRA_MO4 "(" expr "," mop_ex "," mo4_srcdst "," mop_base "," mop_offset "," expr "," mop_stream "," expr "," expr "," expr "," mop_stream "," expr "," expr ")" ";" {
a217 2
	  insn[last_insn].imop.pdist   = id[$25].val;
	  insn[last_insn].imop.plen    = id[$27].val;
d220 1
a220 1
        | CGRA_MOP "(" expr "," mop_ex "," mop_srcdst "," mop_base "," mop_offset "," expr "," mop_stream "," expr "," expr "," expr "," mop_stream "," expr "," expr ")" ";" {
a247 2
	  insn[last_insn].imop.pdist   = id[$25].val;
	  insn[last_insn].imop.plen    = id[$27].val;
@


1.38
log
@*** empty log message ***
@
text
@d54 1
a54 1
          fprintf(ofile, "volatile struct { Ull v:1; Ull top:63; Ull dist:9; Ull len:21; Ull rw:1; Ull f:1; Ull dmy0:32; Ull pv:1; Ull preftop:63; Ull prefdist:9; Ull preflen:21; Ull prw:1; Ull pf:1; Ull dmy1:32;} emax5_lmmi_%s[%d][%d];\n", id[current_prefix].name, EMAX_WIDTH, EMAX_DEPTH);
d189 1
a189 1
        | CGRA_MO4 "(" expr "," mop_ex "," mo4_srcdst "," mop_base "," mop_offset "," expr "," mop_stream "," expr "," expr "," expr "," mop_stream "," expr "," expr "," expr ")" ";" {
a219 1
	  insn[last_insn].imop.pforce  = id[$29].val;
d222 1
a222 1
        | CGRA_MOP "(" expr "," mop_ex "," mop_srcdst "," mop_base "," mop_offset "," expr "," mop_stream "," expr "," expr "," expr "," mop_stream "," expr "," expr "," expr ")" ";" {
a251 1
	  insn[last_insn].imop.pforce  = id[$29].val;
@


1.37
log
@*** empty log message ***
@
text
@d54 1
a54 1
          fprintf(ofile, "volatile struct { Ull v:1; Ull top:63; Ull dist:9; Ull len:22; Ull f:1; Ull dmy0:32; Ull pv:1; Ull preftop:63; Ull prefdist:9; Ull preflen:22; Ull pf:1; Ull dmy1:32;} emax5_lmmi_%s[%d][%d];\n", id[current_prefix].name, EMAX_WIDTH, EMAX_DEPTH);
@


1.36
log
@*** empty log message ***
@
text
@d54 1
a54 1
          fprintf(ofile, "volatile struct { Uint v:1; Uint f:1; Uint dist:9; Uint len:21; Uint dmy:31; Ull top;} emax5_lmmi_%s[%d][%d];\n", id[current_prefix].name, EMAX_WIDTH, EMAX_DEPTH);
d189 1
a189 1
        | CGRA_MO4 "(" expr "," mop_ex "," mo4_srcdst "," mop_base "," mop_offset "," expr "," mop_stream "," expr "," expr "," expr "," mop_stream "," expr "," expr ")" ";" {
d216 5
a220 4
	  insn[last_insn].imop.preftopv = id[$23].type;
	  insn[last_insn].imop.preftoph = $15;
	  insn[last_insn].imop.prefdist = id[$25].val;
	  insn[last_insn].imop.preflen  = id[$27].val;
d223 1
a223 1
        | CGRA_MOP "(" expr "," mop_ex "," mop_srcdst "," mop_base "," mop_offset "," expr "," mop_stream "," expr "," expr "," expr "," mop_stream "," expr "," expr ")" ";" {
d249 5
a253 4
	  insn[last_insn].imop.preftopv = id[$23].type;
	  insn[last_insn].imop.preftoph = $15;
	  insn[last_insn].imop.prefdist = id[$25].val;
	  insn[last_insn].imop.preflen  = id[$27].val;
@


1.35
log
@*** empty log message ***
@
text
@d53 2
a54 2
          fprintf(ofile, "volatile struct { Ull ea0br, ea0or, ea1br, ea1or; Ull br[%d];} emax5_regv_%s[%d][%d];\n", UNIT_WIDTH, id[current_prefix].name, EMAX_DEPTH, EMAX_WIDTH);
          fprintf(ofile, "volatile struct { Uint v:1; Uint f:1; Uint dist:9; Uint len:21; Uint dmy:31; Ull top;} emax5_lmmi_%s[%d][%d];\n", id[current_prefix].name, EMAX_DEPTH, EMAX_WIDTH);
@


1.34
log
@*** empty log message ***
@
text
@a51 2
	  bzero(&regv, sizeof(regv));
	  bzero(&lmmi, sizeof(lmmi));
d53 1
a53 1
          fprintf(ofile, "volatile struct { Ull eab0r, eao0r, eab1r, eao1r; Ull br[%d];} emax5_regv_%s[%d][%d];\n", UNIT_WIDTH, id[current_prefix].name, EMAX_DEPTH, EMAX_WIDTH);
@


1.33
log
@*** empty log message ***
@
text
@d54 3
a56 1
          fprintf(ofile, "struct { Ull eab0r, eao0r, eab1r, eao1r; Ull br[%d];} emax5_regv_%s[%d][%d];\n", UNIT_WIDTH, id[current_prefix].name, EMAX_DEPTH, EMAX_WIDTH);
@


1.32
log
@*** empty log message ***
@
text
@d54 1
a54 1
          fprintf(ofile, "struct { Ull eab1r, eao1r, eab0r, eao0r; Ull br[%d];} emax5_regv_%s[%d][%d];\n", UNIT_WIDTH, id[current_prefix].name, EMAX_DEPTH, EMAX_WIDTH);
@


1.31
log
@*** empty log message ***
@
text
@d200 1
a200 1
	  insn[last_insn].imop.op_type = get_mop_optype(id[ $3].val);
d233 1
a233 1
	  insn[last_insn].imop.op_type = get_mop_optype(id[ $3].val);
@


1.30
log
@*** empty log message ***
@
text
@d205 1
d297 1
d301 1
d331 1
d361 1
d391 1
d421 1
a472 1
	  insn[last_insn].imop.mopds = -1;
a475 1
	  insn[last_insn].imop.mopds = -1;
a478 1
	  insn[last_insn].imop.mopds = -1;
d528 1
@


1.29
log
@*** empty log message ***
@
text
@d94 3
a96 3
	  insn[last_insn].iexe.dstdv   = T_VARIABLE; /* variable */
	  insn[last_insn].iexe.dstdh   = $3;
	  insn[last_insn].iexe.dstds   = -1; /* no suffix */
d117 2
a118 2
	  insn[last_insn].icex.dstev   = id[$15].type;
	  insn[last_insn].icex.dsteh   = $15;
d153 3
a155 3
	  insn[last_insn].iexe.dstdv   = id[$25].type;
	  insn[last_insn].iexe.dstdh   = $25;
	  insn[last_insn].iexe.dstds   = -1; /* no suffix */
d185 2
a186 2
	  insn[last_insn].iexe.dstdv   = id[$25].type;
	  insn[last_insn].iexe.dstdh   = $25;
d203 2
a204 2
	  insn[last_insn].imop.dstv    = id[ $7].type;
	  insn[last_insn].imop.dsth    = $7;
d235 2
a236 2
	  insn[last_insn].imop.dstv    = id[ $7].type;
	  insn[last_insn].imop.dsth    = $7;
d444 1
a444 1
	  insn[last_insn].iexe.dstds = -1;
d448 1
a448 1
	  insn[last_insn].iexe.dstds = id[$4].val;
d452 1
a452 1
	  insn[last_insn].iexe.dstds = id[$4].val;
d466 1
a466 1
	  insn[last_insn].imop.dsts = -1;
d470 1
a470 1
	  insn[last_insn].imop.dsts = -1;
d474 1
a474 1
	  insn[last_insn].imop.dsts = -1;
d480 1
a480 1
	  insn[last_insn].imop.dsts = -1;
d484 1
a484 1
	  insn[last_insn].imop.dsts = id[$4].val;
d488 1
a488 1
	  insn[last_insn].imop.dsts = id[$4].val;
d492 1
a492 1
	  insn[last_insn].imop.dsts = id[$4].val;
@


1.28
log
@*** empty log message ***
@
text
@a27 1
%token  GPRNO
a265 3
        | GPRNO {
          $$ = $1;
	}
d298 3
a316 3
        | GPRNO {
          $$ = $1;
	}
a345 3
        | GPRNO {
          $$ = $1;
	}
a374 3
        | GPRNO {
          $$ = $1;
	}
a403 3
        | GPRNO {
          $$ = $1;
	}
a432 3
        | GPRNO {
          $$ = $1;
	}
d443 1
a443 4
exe_dstd : CGRA_NULL {
          $$ = -1;
        }
        | "\&" VARIABLE { /* &var */
a450 3
        | "\&" GPRNO { /* &rx */
          $$ = $2;
        }
a486 3
        | "\&" GPRNO { /* for load/store */
          $$ = $2;
	}
a516 3
        | GPRNO {
          $$ = $1;
	}
a533 3
        | GPRNO {
          $$ = $1;
	}
a545 3
        | GPRNO {
          $$ = $1;
	}
@


1.27
log
@*** empty log message ***
@
text
@d261 6
@


1.26
log
@*** empty log message ***
@
text
@a28 1
%token  CCRNO
d122 1
a122 1
        | CGRA_EX4 "(" expr "," ex4_src "," expr "," ex4_src "," expr "," ex4_src "," expr "," expr "," ex4_src "," expr "," ex4_src "," ex4_dstd "," exe_dstc ")" ";" {
a156 2
	  insn[last_insn].iexe.dstcv   = id[$27].type;
	  insn[last_insn].iexe.dstch   = $27;
d159 3
a161 3
        | CGRA_EXE "(" expr "," exe_src1 "," expr "," exe_src2 "," expr "," exe_src3 "," expr "," expr "," exe_src4 "," expr "," exe_src5 "," exe_dstd "," exe_dstc ")" ";" {
	  /* exe(op1, BR[r-1][c1][s], BR[r-1][c2][s], BR[r-1][c3][s], op2, IMM, op3, IMM, &BR[r][c][s], &CR[r][c]); followed by next ex */
	  /* exe(op1, BR[r-1][c1][s], BR[r-1][c2][s], BR[r-1][c3][s], op2, IMM, op3, IMM, &AR[r][c],    &CR[r][c]); followed by store(automatic allocating) */
a187 2
	  insn[last_insn].iexe.dstcv   = id[$27].type;
	  insn[last_insn].iexe.dstch   = $27;
d261 1
a261 1
        | CCRNO {
a472 8
exe_dstc : CGRA_NULL {
          $$ = -1;
        }
        | "\&" CCRNO { /* &cx */
          $$ = $2;
        }
	;

@


1.25
log
@*** empty log message ***
@
text
@d494 1
a494 1
mo4_srcdst : VARIABLE { /* for store */
d508 1
a508 1
mop_srcdst : "\&" VARIABLE { /* for store */
d512 1
a512 1
        | "\&" VARIABLE "\[" expr "\]" { /* for store */
d516 1
a516 1
        | "\&" GPRNO { /* for store */
@


1.24
log
@*** empty log message ***
@
text
@d56 1
a56 1
          fprintf(ofile, "struct { Ull eab1r, eao1r, eab0r, eao0r; Ull br[4];} emax5_regv_%s[%d][%d];\n", id[current_prefix].name, UNIT_DEPTH, UNIT_WIDTH);
d131 2
a132 2
	  insn[last_insn].iheader.row  = id[$25].type==T_ALRNO?(id[$25].val):id[$25].type==T_BDRNO?(id[$25].val/UNIT_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[$25].type==T_ALRNO?(         -1):id[$25].type==T_BDRNO?(id[$25].val%UNIT_WIDTH):-1; /* adr/bdr */
d170 2
a171 2
	  insn[last_insn].iheader.row  = id[$25].type==T_ALRNO?(id[$25].val):id[$25].type==T_BDRNO?(id[$25].val/UNIT_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[$25].type==T_ALRNO?(         -1):id[$25].type==T_BDRNO?(id[$25].val%UNIT_WIDTH):-1; /* adr/bdr */
d203 2
a204 2
	  insn[last_insn].iheader.row  = id[$7].type==T_ALRNO?(id[$7].val):id[$7].type==T_BDRNO?(id[$7].val/UNIT_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[$7].type==T_ALRNO?(        -1):id[$7].type==T_BDRNO?(id[$7].val%UNIT_WIDTH):-1; /* adr/bdr */
d235 2
a236 2
	  insn[last_insn].iheader.row  = id[$7].type==T_ALRNO?(id[$7].val):id[$7].type==T_BDRNO?(id[$7].val/UNIT_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].iheader.col  = id[$7].type==T_ALRNO?(        -1):id[$7].type==T_BDRNO?(id[$7].val%UNIT_WIDTH):-1; /* adr/bdr */
d276 1
a276 1
ex4_src : VARIABLE { /* var ([4]) */
d279 1
a279 1
        | CGRA_ULL VARIABLE { /* var ([4]) */
d282 1
a282 1
        | ALRNO { /* AR[r] ([4]) */
d285 1
a285 1
        | BDRNO { /* BR[r][c] ([4]) */
d290 1
a290 1
ex4_dstd : VARIABLE { /* var ([4]) */
d293 1
a293 1
        | ALRNO { /* AR[r] ([4]) */
@


1.23
log
@*** empty log message ***
@
text
@d592 37
a628 1
expr : IMMEDIATE {
d633 53
d700 1
a700 1
hash_search(buf, buflen, reth) char *buf; int buflen, *reth;
d705 1
a705 1
  int  hashval, hashsave, indx;
d725 1
d727 3
a729 2
  for (indx=0; indx<buflen; indx++)
    *bufptr++ = buf[indx];
@


1.22
log
@*** empty log message ***
@
text
@d16 1
d45 1
a45 1
        | EMAX5ASTART VARIABLE IMMEDIATE { /* reset conf[][] */
d48 1
a48 1
          current_mapdist = $3;
d101 1
a101 1
        | CGRA_CEX "(" IMMEDIATE "," cex_src "," cex_src "," cex_src "," cex_src "," IMMEDIATE "," cex_dst ")" ";" {
d123 1
a123 1
        | CGRA_EX4 "(" IMMEDIATE "," ex4_src "," IMMEDIATE "," ex4_src "," IMMEDIATE "," ex4_src "," IMMEDIATE "," IMMEDIATE "," ex4_src "," IMMEDIATE "," ex4_src "," ex4_dstd "," exe_dstc ")" ";" {
d162 1
a162 1
        | CGRA_EXE "(" IMMEDIATE "," exe_src1 "," IMMEDIATE "," exe_src2 "," IMMEDIATE "," exe_src3 "," IMMEDIATE "," IMMEDIATE "," exe_src4 "," IMMEDIATE "," exe_src5 "," exe_dstd "," exe_dstc ")" ";" {
d195 1
a195 1
        | CGRA_MO4 "(" IMMEDIATE "," mop_ex "," mo4_srcdst "," mop_base "," mop_offset "," IMMEDIATE "," mop_stream "," IMMEDIATE "," IMMEDIATE "," IMMEDIATE "," mop_stream "," IMMEDIATE "," IMMEDIATE ")" ";" {
d227 1
a227 1
        | CGRA_MOP "(" IMMEDIATE "," mop_ex "," mop_srcdst "," mop_base "," mop_offset "," IMMEDIATE "," mop_stream "," IMMEDIATE "," IMMEDIATE "," IMMEDIATE "," mop_stream "," IMMEDIATE "," IMMEDIATE ")" ";" {
d263 1
a263 1
cex_src : IMMEDIATE {
d298 1
a298 1
exe_src1 : IMMEDIATE {
d309 1
a309 1
        | VARIABLE "\[" IMMEDIATE "\]" { /* var[s] */
d313 1
a313 1
        | CGRA_ULL VARIABLE "\[" IMMEDIATE "\]" { /* var[s] */
d320 1
a320 1
        | ALRNO "\[" IMMEDIATE "\]" { /* AR[r][s] */
d324 1
a324 1
        | BDRNO "\[" IMMEDIATE "\]" { /* BR[r][c][s] */
d330 1
a330 1
exe_src2 : IMMEDIATE {
d341 1
a341 1
        | VARIABLE "\[" IMMEDIATE "\]" { /* var[s] */
d345 1
a345 1
        | CGRA_ULL VARIABLE "\[" IMMEDIATE "\]" { /* var[s] */
d352 1
a352 1
        | ALRNO "\[" IMMEDIATE "\]" { /* AR[r][s] */
d356 1
a356 1
        | BDRNO "\[" IMMEDIATE "\]" { /* BR[r][c][s] */
d362 1
a362 1
exe_src3 : IMMEDIATE {
d373 1
a373 1
        | VARIABLE "\[" IMMEDIATE "\]" { /* var[s] */
d377 1
a377 1
        | CGRA_ULL VARIABLE "\[" IMMEDIATE "\]" { /* var[s] */
d384 1
a384 1
        | ALRNO "\[" IMMEDIATE "\]" { /* AR[r][s] */
d388 1
a388 1
        | BDRNO "\[" IMMEDIATE "\]" { /* BR[r][c][s] */
d394 1
a394 1
exe_src4 : IMMEDIATE {
d405 1
a405 1
        | VARIABLE "\[" IMMEDIATE "\]" { /* var[s] */
d409 1
a409 1
        | CGRA_ULL VARIABLE "\[" IMMEDIATE "\]" { /* var[s] */
d416 1
a416 1
        | ALRNO "\[" IMMEDIATE "\]" { /* AR[r][s] */
d420 1
a420 1
        | BDRNO "\[" IMMEDIATE "\]" { /* BR[r][c][s] */
d426 1
a426 1
exe_src5 : IMMEDIATE {
d437 1
a437 1
        | VARIABLE "\[" IMMEDIATE "\]" { /* var[s] */
d441 1
a441 1
        | CGRA_ULL VARIABLE "\[" IMMEDIATE "\]" { /* var[s] */
d448 1
a448 1
        | ALRNO "\[" IMMEDIATE "\]" { /* AR[r][s] */
d452 1
a452 1
        | BDRNO "\[" IMMEDIATE "\]" { /* BR[r][c][s] */
d465 1
a465 1
        | "\&" VARIABLE "\[" IMMEDIATE "\]" { /* &var[s] */
d472 1
a472 1
        | "\&" ALRNO "\[" IMMEDIATE "\]" { /* &AR[r][s] */
d486 1
a486 1
mop_ex : IMMEDIATE {
d512 1
a512 1
        | "\&" VARIABLE "\[" IMMEDIATE "\]" { /* for store */
d519 1
a519 1
        | "\&" ALRNO "\[" IMMEDIATE "\]" { /* for store */
d523 1
a523 1
        | "\&" BDRNO "\[" IMMEDIATE "\]" { /* for load */
d552 1
a552 1
        | BDRNO "\[" IMMEDIATE "\]" {
d558 1
a558 1
mop_offset : IMMEDIATE {
d572 1
a572 1
        | BDRNO "\[" IMMEDIATE "\]" {
d592 5
d611 32
@


1.21
log
@*** empty log message ***
@
text
@d194 1
a194 1
        | CGRA_MO4 "(" IMMEDIATE "," mop_ex "," mo4_srcdst "," mop_base "," mop_offset "," IMMEDIATE "," mop_stream "," IMMEDIATE "," IMMEDIATE "," IMMEDIATE ")" ";" {
d215 2
a216 2
	  insn[last_insn].imop.strmv   = id[$15].type;
	  insn[last_insn].imop.strmh   = $15;
d220 4
d226 1
a226 1
        | CGRA_MOP "(" IMMEDIATE "," mop_ex "," mop_srcdst "," mop_base "," mop_offset "," IMMEDIATE "," mop_stream "," IMMEDIATE "," IMMEDIATE "," IMMEDIATE ")" ";" {
d247 2
a248 2
	  insn[last_insn].imop.strmv   = id[$15].type;
	  insn[last_insn].imop.strmh   = $15;
d252 4
d586 3
@


1.20
log
@*** empty log message ***
@
text
@d118 2
a119 1
	  insn[last_insn].icex.dstex   = $15;
@


1.19
log
@*** empty log message ***
@
text
@d51 1
a51 1
	  bzero(&regmap, sizeof(regmap));
d55 1
@


1.18
log
@*** empty log message ***
@
text
@d94 3
@


1.17
log
@*** empty log message ***
@
text
@a564 1
	  insn[last_insn].imop.strms = -1;
a567 1
	  insn[last_insn].imop.strms = -1;
a572 4
        | BDRNO "\[" IMMEDIATE "\]" {
	  insn[last_insn].imop.strms = id[$3].val;
          $$ = $1;
	}
@


1.16
log
@*** empty log message ***
@
text
@d90 4
d117 1
a117 1
        | CGRA_EX4 "(" IMMEDIATE "," ex4_src "," IMMEDIATE "," ex4_src "," IMMEDIATE "," ex4_src "," IMMEDIATE "," IMMEDIATE "," ex4_src "," IMMEDIATE "," ex4_src "," ex4_dstr "," exe_dstc ")" ";" {
d130 1
a130 1
	  insn[last_insn].iexe.updt    = ($5 == $25)?1:0; /* if (src1 == dstr) self_update=1 */
d149 3
a151 3
	  insn[last_insn].iexe.dstrv   = id[$25].type;
	  insn[last_insn].iexe.dstrh   = $25;
	  insn[last_insn].iexe.dstrs   = -1; /* no suffix */
d156 1
a156 1
        | CGRA_EXE "(" IMMEDIATE "," exe_src1 "," IMMEDIATE "," exe_src2 "," IMMEDIATE "," exe_src3 "," IMMEDIATE "," IMMEDIATE "," exe_src4 "," IMMEDIATE "," exe_src5 "," exe_dstr "," exe_dstc ")" ";" {
d169 1
a169 1
	  insn[last_insn].iexe.updt    = ($5 == $25)?1:0; /* if (src1 == dstr) self_update=1 */
d183 2
a184 2
	  insn[last_insn].iexe.dstrv   = id[$25].type;
	  insn[last_insn].iexe.dstrh   = $25;
d276 1
a276 1
ex4_dstr : VARIABLE { /* var ([4]) */
d444 1
a444 1
exe_dstr : CGRA_NULL {
d448 1
a448 1
	  insn[last_insn].iexe.dstrs = -1;
d452 1
a452 1
	  insn[last_insn].iexe.dstrs = id[$4].val;
d459 1
a459 1
	  insn[last_insn].iexe.dstrs = id[$4].val;
@


1.15
log
@*** empty log message ***
@
text
@d51 1
d86 1
a86 1
	  insn[last_insn].iexe.src1v   = 2; /* variable */
d89 1
a89 1
	  insn[last_insn].iexe.src1e   = 3; /* full */
d264 3
d302 4
d334 4
d366 4
d398 4
d430 4
a457 4
        | "\&" BDRNO "\[" IMMEDIATE "\]" { /* &BR[r][c][s] */
	  insn[last_insn].iexe.dstrs = id[$4].val;
          $$ = $2;
	}
@


1.14
log
@*** empty log message ***
@
text
@a50 1
	  bzero(&prop_skp, sizeof(prop_skp));
@


1.13
log
@*** empty log message ***
@
text
@d196 1
d224 1
@


1.12
log
@*** empty log message ***
@
text
@d87 2
a89 6
	  insn[last_insn].iexe.src1s   = -1; /* no suffix */
	  insn[last_insn].iexe.src1n   = id[$3].val;
	  insn[last_insn].iexe.src2v   = 1; /* immediate */
	  insn[last_insn].iexe.src2e   = 3; /* full */
	  insn[last_insn].iexe.src2s   = -1; /* no suffix */
	  insn[last_insn].iexe.src2n   = -1; /* DECR */
d98 2
d102 1
a102 1
	  insn[last_insn].icex.bit0n   = id[$11].val;
d104 1
a104 1
	  insn[last_insn].icex.bit1n   = id[ $9].val;
d106 1
a106 1
	  insn[last_insn].icex.bit2n   = id[ $7].val;
d108 1
a108 1
	  insn[last_insn].icex.bit3n   = id[ $5].val;
d110 1
a110 1
	  insn[last_insn].icex.dstex   = id[$15].val;
d128 2
a130 2
	  insn[last_insn].iexe.src1s   = -1; /* no suffix */
	  insn[last_insn].iexe.src1n   = id[ $5].val;
d132 2
a134 2
	  insn[last_insn].iexe.src2s   = -1; /* no suffix */
	  insn[last_insn].iexe.src2n   = id[ $9].val;
d136 2
a138 2
	  insn[last_insn].iexe.src3s   = -1; /* no suffix */
	  insn[last_insn].iexe.src3n   = id[$13].val;
d140 1
a141 1
	  insn[last_insn].iexe.src4n   =  id[$19].val;
d143 1
a144 1
	  insn[last_insn].iexe.src5n   = id[$23].val;
d146 1
a147 1
	  insn[last_insn].iexe.dstrn   = id[$25].val;
d149 1
a149 1
	  insn[last_insn].iexe.dstcn   = id[$27].val;
d167 1
a168 1
	  insn[last_insn].iexe.src1n   = id[ $5].val;
d170 1
a171 1
	  insn[last_insn].iexe.src2n   = id[ $9].val;
d173 1
a174 1
	  insn[last_insn].iexe.src3n   = id[$13].val;
d176 1
a176 1
	  insn[last_insn].iexe.src4n   = id[$19].val;
d178 1
a178 1
	  insn[last_insn].iexe.src5n   = id[$23].val;
d180 1
a180 1
	  insn[last_insn].iexe.dstrn   = id[$25].val;
d182 1
a182 1
	  insn[last_insn].iexe.dstcn   = id[$27].val;
d197 1
a197 1
	  insn[last_insn].imop.exn     = id[ $5].val;
d199 1
a199 1
	  insn[last_insn].imop.dstn    = id[ $7].val;
d201 1
a201 1
	  insn[last_insn].imop.basen   = id[ $9].val;
d203 1
a204 1
	  insn[last_insn].imop.offsn   = id[$11].val;
d206 1
a206 1
	  insn[last_insn].imop.strmn   = id[$15].val;
d224 1
a224 1
	  insn[last_insn].imop.exn     = id[ $5].val;
d226 1
a226 1
	  insn[last_insn].imop.dstn    = id[ $7].val;
d228 1
a228 1
	  insn[last_insn].imop.basen   = id[ $9].val;
d230 1
a231 1
	  insn[last_insn].imop.offsn   = id[$11].val;
d233 1
a233 1
	  insn[last_insn].imop.strmn   = id[$15].val;
@


1.11
log
@*** empty log message ***
@
text
@d50 1
d77 1
a77 1
	    fprintf(stderr, "last_insn exceeds in %s INSN_DEPTH=%d.\n", id[current_prefix].name, INSN_DEPTH);
d80 14
a93 14
	  insn[last_insn].header.type = 1; /* WHILE */
	  insn[last_insn].header.row  = 0; /* top */
	  insn[last_insn].header.col  = 0; /* top */
	  insn[last_insn].exe.op1     = OP_WHILE;
	  insn[last_insn].exe.updt    = 1;
	  insn[last_insn].exe.adjust  = 1; /* pre_adjust is required for implementing a-- w/ --a */
	  insn[last_insn].exe.src1v   = 2; /* variable */
	  insn[last_insn].exe.src1e   = 3; /* full */
	  insn[last_insn].exe.src1s   = -1; /* no suffix */
	  insn[last_insn].exe.src1n   = id[$3].val;
	  insn[last_insn].exe.src2v   = 1; /* immediate */
	  insn[last_insn].exe.src2e   = 3; /* full */
	  insn[last_insn].exe.src2s   = -1; /* no suffix */
	  insn[last_insn].exe.src2n   = -1; /* DECR */
d98 1
a98 1
	    fprintf(stderr, "last_insn exceeds in %s INSN_DEPTH=%d.\n", id[current_prefix].name, INSN_DEPTH);
d101 12
a112 12
	  insn[last_insn].header.type = 2; /* CEX */
	  insn[last_insn].cex.op      = id[ $3].val;
	  insn[last_insn].cex.bit0v   = id[$11].type;
	  insn[last_insn].cex.bit0n   = id[$11].val;
	  insn[last_insn].cex.bit1v   = id[ $9].type;
	  insn[last_insn].cex.bit1n   = id[ $9].val;
	  insn[last_insn].cex.bit2v   = id[ $7].type;
	  insn[last_insn].cex.bit2n   = id[ $7].val;
	  insn[last_insn].cex.bit3v   = id[ $5].type;
	  insn[last_insn].cex.bit3n   = id[ $5].val;
	  insn[last_insn].cex.table   = id[$13].val;
	  insn[last_insn].cex.dstex   = id[$15].val;
d119 1
a119 1
	    fprintf(stderr, "last_insn exceeds in %s INSN_DEPTH=%d.\n", id[current_prefix].name, INSN_DEPTH);
d122 30
a151 30
	  insn[last_insn].header.type = 3; /* EX4 */
	  insn[last_insn].header.row  = id[$25].type==T_ALRNO?(id[$25].val):id[$25].type==T_BDRNO?(id[$25].val/UNIT_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].header.col  = id[$25].type==T_ALRNO?(         -1):id[$25].type==T_BDRNO?(id[$25].val%UNIT_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].exe.op1     = id[ $3].val;
	  insn[last_insn].exe.op2     = id[$17].val;
	  insn[last_insn].exe.op3     = id[$21].val;
	  insn[last_insn].exe.updt    = ($5 == $25)?1:0; /* if (src1 == dstr) self_update=1 */
	  insn[last_insn].exe.src1v   = id[ $5].type;
	  insn[last_insn].exe.src1e   = id[ $7].val;
	  insn[last_insn].exe.src1s   = -1; /* no suffix */
	  insn[last_insn].exe.src1n   = id[ $5].val;
	  insn[last_insn].exe.src2v   = id[ $9].type;
	  insn[last_insn].exe.src2e   = id[$11].val;
	  insn[last_insn].exe.src2s   = -1; /* no suffix */
	  insn[last_insn].exe.src2n   = id[ $9].val;
	  insn[last_insn].exe.src3v   = id[$13].type;
	  insn[last_insn].exe.src3e   = id[$15].val;
	  insn[last_insn].exe.src3s   = -1; /* no suffix */
	  insn[last_insn].exe.src3n   = id[$13].val;
	  insn[last_insn].exe.src4v   = id[$19].type;
	  insn[last_insn].exe.src4s   = -1; /* no suffix */
	  insn[last_insn].exe.src4n   =  id[$19].val;
	  insn[last_insn].exe.src5v   = id[$23].type;
	  insn[last_insn].exe.src5s   = -1; /* no suffix */
	  insn[last_insn].exe.src5n   = id[$23].val;
	  insn[last_insn].exe.dstrv   = id[$25].type;
	  insn[last_insn].exe.dstrs   = -1; /* no suffix */
	  insn[last_insn].exe.dstrn   = id[$25].val;
	  insn[last_insn].exe.dstcv   = id[$27].type;
	  insn[last_insn].exe.dstcn   = id[$27].val;
d158 1
a158 1
	    fprintf(stderr, "last_insn exceeds in %s INSN_DEPTH=%d.\n", id[current_prefix].name, INSN_DEPTH);
d161 24
a184 24
	  insn[last_insn].header.type = 4; /* EXE */
	  insn[last_insn].header.row  = id[$25].type==T_ALRNO?(id[$25].val):id[$25].type==T_BDRNO?(id[$25].val/UNIT_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].header.col  = id[$25].type==T_ALRNO?(         -1):id[$25].type==T_BDRNO?(id[$25].val%UNIT_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].exe.op1     = id[ $3].val;
	  insn[last_insn].exe.op2     = id[$17].val;
	  insn[last_insn].exe.op3     = id[$21].val;
	  insn[last_insn].exe.updt    = ($5 == $25)?1:0; /* if (src1 == dstr) self_update=1 */
	  insn[last_insn].exe.src1v   = id[ $5].type;
	  insn[last_insn].exe.src1e   = id[ $7].val;
	  insn[last_insn].exe.src1n   = id[ $5].val;
	  insn[last_insn].exe.src2v   = id[ $9].type;
	  insn[last_insn].exe.src2e   = id[$11].val;
	  insn[last_insn].exe.src2n   = id[ $9].val;
	  insn[last_insn].exe.src3v   = id[$13].type;
	  insn[last_insn].exe.src3e   = id[$15].val;
	  insn[last_insn].exe.src3n   = id[$13].val;
	  insn[last_insn].exe.src4v   = id[$19].type;
	  insn[last_insn].exe.src4n   = id[$19].val;
	  insn[last_insn].exe.src5v   = id[$23].type;
	  insn[last_insn].exe.src5n   = id[$23].val;
	  insn[last_insn].exe.dstrv   = id[$25].type;
	  insn[last_insn].exe.dstrn   = id[$25].val;
	  insn[last_insn].exe.dstcv   = id[$27].type;
	  insn[last_insn].exe.dstcn   = id[$27].val;
d191 1
a191 1
	    fprintf(stderr, "last_insn exceeds in %s INSN_DEPTH=%d.\n", id[current_prefix].name, INSN_DEPTH);
d194 18
a211 18
	  insn[last_insn].header.type = 5; /* MO4 */
	  insn[last_insn].header.row  = id[$7].type==T_ALRNO?(id[$7].val):id[$7].type==T_BDRNO?(id[$7].val/UNIT_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].header.col  = id[$7].type==T_ALRNO?(        -1):id[$7].type==T_BDRNO?(id[$7].val%UNIT_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].mop.op      = id[ $3].val;
	  insn[last_insn].mop.exv     = id[ $5].type;
	  insn[last_insn].mop.exn     = id[ $5].val;
	  insn[last_insn].mop.dstv    = id[ $7].type;
	  insn[last_insn].mop.dstn    = id[ $7].val;
	  insn[last_insn].mop.basev   = id[ $9].type;
	  insn[last_insn].mop.basen   = id[ $9].val;
	  insn[last_insn].mop.offsv   = id[$11].type;
	  insn[last_insn].mop.offsm   = id[$13].val;
	  insn[last_insn].mop.offsn   = id[$11].val;
	  insn[last_insn].mop.strmv   = id[$15].type;
	  insn[last_insn].mop.strmn   = id[$15].val;
	  insn[last_insn].mop.dist    = id[$17].val;
	  insn[last_insn].mop.len     = id[$19].val;
	  insn[last_insn].mop.force   = id[$21].val;
d218 1
a218 1
	    fprintf(stderr, "last_insn exceeds in %s INSN_DEPTH=%d.\n", id[current_prefix].name, INSN_DEPTH);
d221 18
a238 18
	  insn[last_insn].header.type = 6; /* MOP */
	  insn[last_insn].header.row  = id[$7].type==T_ALRNO?(id[$7].val):id[$7].type==T_BDRNO?(id[$7].val/UNIT_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].header.col  = id[$7].type==T_ALRNO?(        -1):id[$7].type==T_BDRNO?(id[$7].val%UNIT_WIDTH):-1; /* adr/bdr */
	  insn[last_insn].mop.op      = id[ $3].val;
	  insn[last_insn].mop.exv     = id[ $5].type;
	  insn[last_insn].mop.exn     = id[ $5].val;
	  insn[last_insn].mop.dstv    = id[ $7].type;
	  insn[last_insn].mop.dstn    = id[ $7].val;
	  insn[last_insn].mop.basev   = id[ $9].type;
	  insn[last_insn].mop.basen   = id[ $9].val;
	  insn[last_insn].mop.offsv   = id[$11].type;
	  insn[last_insn].mop.offsm   = id[$13].val;
	  insn[last_insn].mop.offsn   = id[$11].val;
	  insn[last_insn].mop.strmv   = id[$15].type;
	  insn[last_insn].mop.strmn   = id[$15].val;
	  insn[last_insn].mop.dist    = id[$17].val;
	  insn[last_insn].mop.len     = id[$19].val;
	  insn[last_insn].mop.force   = id[$21].val;
a274 3
        | BDRNO { /* BR[r][c] ([4]) */
          $$ = $1;
	}
d281 1
a281 1
	  insn[last_insn].exe.src1s = -1;
d285 1
a285 1
	  insn[last_insn].exe.src1s = -1;
d289 1
a289 1
	  insn[last_insn].exe.src1s = id[$3].val;
d293 1
a293 1
	  insn[last_insn].exe.src1s = id[$4].val;
d300 1
a300 1
	  insn[last_insn].exe.src1s = id[$3].val;
d309 1
a309 1
	  insn[last_insn].exe.src2s = -1;
d313 1
a313 1
	  insn[last_insn].exe.src2s = -1;
d317 1
a317 1
	  insn[last_insn].exe.src2s = id[$3].val;
d321 1
a321 1
	  insn[last_insn].exe.src2s = id[$4].val;
d328 1
a328 1
	  insn[last_insn].exe.src2s = id[$3].val;
d337 1
a337 1
	  insn[last_insn].exe.src3s = -1;
d341 1
a341 1
	  insn[last_insn].exe.src3s = -1;
d345 1
a345 1
	  insn[last_insn].exe.src3s = id[$3].val;
d349 1
a349 1
	  insn[last_insn].exe.src3s = id[$4].val;
d356 1
a356 1
	  insn[last_insn].exe.src3s = id[$3].val;
d365 1
a365 1
	  insn[last_insn].exe.src4s = -1;
d369 1
a369 1
	  insn[last_insn].exe.src4s = -1;
d373 1
a373 1
	  insn[last_insn].exe.src4s = id[$3].val;
d377 1
a377 1
	  insn[last_insn].exe.src4s = id[$4].val;
d384 1
a384 1
	  insn[last_insn].exe.src4s = id[$3].val;
d393 1
a393 1
	  insn[last_insn].exe.src5s = -1;
d397 1
a397 1
	  insn[last_insn].exe.src5s = -1;
d401 1
a401 1
	  insn[last_insn].exe.src5s = id[$3].val;
d405 1
a405 1
	  insn[last_insn].exe.src5s = id[$4].val;
d412 1
a412 1
	  insn[last_insn].exe.src5s = id[$3].val;
d421 1
a421 1
	  insn[last_insn].exe.dstrs = -1;
d425 1
a425 1
	  insn[last_insn].exe.dstrs = id[$4].val;
d432 1
a432 1
	  insn[last_insn].exe.dstrs = id[$4].val;
d436 1
a436 1
	  insn[last_insn].exe.dstrs = id[$4].val;
d458 1
a458 1
	  insn[last_insn].mop.dsts = -1;
d462 1
a462 1
	  insn[last_insn].mop.dsts = -1;
d466 1
a466 1
	  insn[last_insn].mop.dsts = -1;
d472 1
a472 1
	  insn[last_insn].mop.dsts = -1;
d476 1
a476 1
	  insn[last_insn].mop.dsts = id[$4].val;
d483 1
a483 1
	  insn[last_insn].mop.dsts = id[$4].val;
d487 1
a487 1
	  insn[last_insn].mop.dsts = id[$4].val;
d493 1
a493 1
	  insn[last_insn].mop.bases = -1;
d497 1
a497 1
	  insn[last_insn].mop.bases = -1;
d501 3
a503 3
	  insn[last_insn].mop.updt = 1;
	  insn[last_insn].mop.adjust = 1;
	  insn[last_insn].mop.bases = -1;
d507 3
a509 3
	  insn[last_insn].mop.updt = 1;
	  insn[last_insn].mop.adjust = 1;
	  insn[last_insn].mop.bases = -1;
d516 1
a516 1
	  insn[last_insn].mop.bases = id[$3].val;
d525 1
a525 1
	  insn[last_insn].mop.offss = -1;
d529 1
a529 1
	  insn[last_insn].mop.offss = -1;
d536 1
a536 1
	  insn[last_insn].mop.offss = id[$3].val;
d542 1
a542 1
	  insn[last_insn].mop.strms = -1;
d546 1
a546 1
	  insn[last_insn].mop.strms = -1;
d553 1
a553 1
	  insn[last_insn].mop.strms = id[$3].val;
@


1.10
log
@*** empty log message ***
@
text
@d76 1
a76 1
	    fprintf(stderr, "last_insn exceeds INSN_DEPTH=%d.\n", INSN_DEPTH);
d97 1
a97 1
	    fprintf(stderr, "last_insn exceeds INSN_DEPTH=%d.\n", INSN_DEPTH);
d118 1
a118 1
	    fprintf(stderr, "last_insn exceeds INSN_DEPTH=%d.\n", INSN_DEPTH);
d157 1
a157 1
	    fprintf(stderr, "last_insn exceeds INSN_DEPTH=%d.\n", INSN_DEPTH);
d190 1
a190 1
	    fprintf(stderr, "last_insn exceeds INSN_DEPTH=%d.\n", INSN_DEPTH);
d217 1
a217 1
	    fprintf(stderr, "last_insn exceeds INSN_DEPTH=%d.\n", INSN_DEPTH);
@


1.9
log
@*** empty log message ***
@
text
@d83 2
d127 1
a127 1
	  insn[last_insn].exe.updt    = 0; /* ★★★ 自己更新は要追加 */
d166 1
a166 1
	  insn[last_insn].exe.updt    = 0; /* ★★★ 自己更新は要追加 */
a196 1
	  insn[last_insn].mop.updt    = 0; /* ★★★ 自己更新は要追加 */
a223 1
	  insn[last_insn].mop.updt    = 0; /* ★★★ 自己更新は要追加 */
d504 1
d510 1
@


1.8
log
@*** empty log message ***
@
text
@d16 3
a18 1
%token  CGRA_WHILE	CGRA_CEX	CGRA_EX4	CGRA_EXE	CGRA_MOP
d184 28
d219 1
a219 1
	  insn[last_insn].header.type = 5; /* MOP */
d459 14
a483 4
        | "\&" ALRNO { /* for store */
	  insn[last_insn].mop.dsts = -1;
          $$ = $2;
	}
a487 4
        | "\&" BDRNO { /* for load */
	  insn[last_insn].mop.dsts = -1;
          $$ = $2;
        }
d503 1
d508 1
@


1.7
log
@*** empty log message ***
@
text
@d260 8
d288 8
d316 8
d344 8
d372 8
@


1.6
log
@*** empty log message ***
@
text
@d227 1
a227 4
ex4_src : IMMEDIATE {
          $$ = $1;
        }
        | VARIABLE {
d230 1
a230 1
        | CGRA_ULL VARIABLE {
d233 2
a234 2
        | "\&" BDRNO {
          $$ = $2;
d238 2
a239 2
ex4_dstr : "\&" VARIABLE {
          $$ = $2;
d241 2
a242 2
        | "\&" ALRNO {
          $$ = $2;
d244 2
a245 2
        | "\&" BDRNO {
          $$ = $2;
d253 1
d257 1
d263 1
a263 1
        | BDRNO "\[" IMMEDIATE "\]" {
d273 1
d277 1
d283 1
a283 1
        | BDRNO "\[" IMMEDIATE "\]" {
d293 1
d297 1
d303 1
a303 1
        | BDRNO "\[" IMMEDIATE "\]" {
d313 1
d317 1
d323 1
a323 1
        | BDRNO "\[" IMMEDIATE "\]" {
d333 1
d337 1
d343 1
a343 1
        | BDRNO "\[" IMMEDIATE "\]" {
d352 2
a353 1
        | "\&" VARIABLE {
d356 2
a357 1
        | "\&" VARIABLE "\[" IMMEDIATE "\]" {
d360 1
a360 1
        | "\&" GPRNO {
d363 1
a363 1
        | "\&" ALRNO "\[" IMMEDIATE "\]" {
d367 1
a367 1
        | "\&" BDRNO "\[" IMMEDIATE "\]" {
d376 1
a376 1
        | "\&" CCRNO {
d384 1
a384 1
        | EXRNO {
d390 1
d394 1
d419 1
d423 1
d427 1
d431 1
d447 1
d451 1
d464 1
d468 1
@


1.5
log
@*** empty log message ***
@
text
@d16 1
a16 1
%token  CGRA_WHILE	CGRA_MOP        CGRA_EXE	CGRA_EX4	CGRA_CEX
d28 1
d77 12
d91 1
a91 1
        | CGRA_MOP "(" IMMEDIATE "," mop_ex "," mop_srcdst "," mop_base "," mop_offset "," IMMEDIATE "," mop_base "," IMMEDIATE "," IMMEDIATE "," IMMEDIATE ")" ";" {
d96 12
a107 3
	  insn[last_insn].header.type= 1; /* MOP */
	  insn[last_insn].header.row = id[$7].val/UNIT_WIDTH;
	  insn[last_insn].header.col = id[$7].val%UNIT_WIDTH;
d110 3
a112 1
        | CGRA_EX4 "(" IMMEDIATE "," ex4_src "," IMMEDIATE "," ex4_src "," IMMEDIATE "," ex4_src "," IMMEDIATE "," IMMEDIATE "," ex4_src "," ex4_src "," IMMEDIATE "," ex4_src "," ex4_dstr "," exe_dstc ")" ";" {
d117 30
a146 1
	  insn[last_insn].header.type= 2; /* EX4 */
d149 3
a151 1
        | CGRA_EXE "(" IMMEDIATE "," exe_src "," IMMEDIATE "," exe_src "," IMMEDIATE "," exe_src "," IMMEDIATE "," IMMEDIATE "," exe_src "," exe_src "," IMMEDIATE "," exe_src "," exe_dstr "," exe_dstc ")" ";" {
d156 24
a179 1
	  insn[last_insn].header.type= 3; /* EXE */
d182 3
a184 1
        | CGRA_CEX "(" IMMEDIATE "," cex_src "," cex_src "," cex_src "," cex_src "," IMMEDIATE "," cex_dst ")" ";" {
d189 19
a207 1
	  insn[last_insn].header.type= 4; /* CEX */
d214 1
a214 1
mop_ex : IMMEDIATE {
d217 1
a217 1
        | EXRNO {
d220 5
d227 4
a230 1
mop_srcdst : "\&" VARIABLE { /* for store */
d233 16
a248 2
        | "\&" GPRNO { /* for store */
          $$ = $1;
a249 6
        | "\&" BDRNO { /* for load */
          $$ = $1;
        }
        | "\&" BDRNO "\[" IMMEDIATE "\]" { /* for load */
          $$ = $1;
        }
d252 1
a252 1
mop_base : IMMEDIATE {
d258 4
a261 1
        | VARIABLE CGRA_INCR {
d264 2
a265 1
        | CGRA_ULL VARIABLE {
d268 6
a273 1
        | CGRA_ULL "(" VARIABLE CGRA_INCR ")" {
d276 3
d283 1
d288 1
a288 1
mop_offset : IMMEDIATE {
d295 1
a295 1
          $$ = $1;
d301 1
d306 4
a309 1
ex4_src : "\&" BDRNO {
d312 8
a319 3
	;

ex4_dstr : "\&" BDRNO {
d324 1
a324 1
exe_src : IMMEDIATE {
d331 1
a331 1
          $$ = $1;
d337 1
d343 1
a343 1
          $$ = $1;
d346 4
a349 1
          $$ = $1;
d352 1
a352 1
          $$ = $1;
d354 4
d359 2
a360 1
          $$ = $1;
d365 8
d375 1
a375 1
        | "\&" VARIABLE {
d377 27
d405 19
a423 1
        | "\&" CCRNO {
d425 1
a425 1
        }
d428 1
a428 1
cex_src : IMMEDIATE {
d431 11
a441 1
        | CCRNO {
d444 1
a444 1
	; 
d446 11
a456 1
cex_dst : "\&" EXRNO {
d458 1
a458 1
        }
@


1.4
log
@*** empty log message ***
@
text
@d42 1
a42 1
          printf("EMAX5AS reading line=%d name=%s\n", y_lineno, id[$2].name);
d58 1
a58 1
          printf("EMAX5TS reading line=%d name=%s\n", y_lineno, id[$2].name);
@


1.3
log
@*** empty log message ***
@
text
@d16 2
a17 1
%token  CGRA_WHILE	CGRA_MOP        CGRA_EXE	CGRA_CEX	CGRA_DECR	CGRA_INCR
d42 1
a42 1
          printf("reading EMAX5AS line=%d name=%s\n", y_lineno, id[$2].name);
a52 1
          printf("reading EMAX5AD line=%d\n", y_lineno);
a54 1
          printf("reading EMAX5AE line=%d\n", y_lineno);
d58 1
a58 1
          printf("reading EMAX5TS line=%d name=%s\n", y_lineno, id[$2].name);
a64 1
          printf("reading EMAX5TD line=%d\n", y_lineno);
a66 1
          printf("reading EMAX5TE line=%d\n", y_lineno);
d88 8
d101 1
a101 1
	  insn[last_insn].header.type= 2; /* EXE */
d109 1
a109 1
	  insn[last_insn].header.type= 3; /* CEX */
d178 10
@


1.2
log
@*** empty log message ***
@
text
@d9 1
a12 1
%token  EOL
d16 1
a16 3
%token  CGRA_NOP	CGRA_WHILE	CGRA_DECR	CGRA_INCR
%token	CGRA_MOP        CGRA_EXE	CGRA_CEX
%token  CGRA_AR		CGRA_BR		CGRA_CR
d19 1
a19 1
%token  READ    WRITE
d228 1
a228 1
EMAX5TBODY : READ {
d231 1
a231 1
        | WRITE {
@


1.1
log
@Initial revision
@
text
@d9 3
a12 24
%token  EMAX5APREFIX    EMAX5TPREFIX
%token  INTEL
%token  START   CTL     M_DIST  END
%token  CEXE
%token  READ    WRITE   BASE    REGV    OFS     LEN
%token  EQ      NE      GE      TERM    ERROR
%token  DST     SRC

%token  POSTI
%token  SUFFL   SUFHI   SUFLO   SUFB3   SUFB2   SUFB1   SUFB0
%token  RI      RGI
%token  LMR     LMW     LMX     LMP     LMF     LMD
%token  MMR     MMTR

%token  NOP

%token  LDB     LDUB    LDH     LDUH    LD
%token  STB     STH     ST

%token  WHILE   ADD     ADD3    SUB     SUB3
%token  MAUH    MAUH3   MSUH    MSUH3   MLUH    MMRG3   MSAD
%token  MINL    MINL3   MH2BW   MCAS    
%token  MMID3   MMAX    MMAX3   MMIN    MMIN3
%token  FMUL    FMA3    FADD
d14 5
a18 2
%token  CMPEQ   CMPNE   CMPLT   CMPLE   CMPGT   CMPGE
%token  CMOV
d20 2
a21 2
%token  AND     OR      XOR     SUMH    SUML    
%token  SLL     SRL     MSRL    SRA31   SRA23   SRA15   SRA07
d23 1
d25 2
a26 1
%token  REGNO
d28 2
a29 2
%token  LABEL
%token  STRING
d37 1
a37 1
line :  EMAX5APREFIX EMAX5ABODY {
d39 1
a39 3
        | EMAX5TPREFIX EMAX5TBODY {
	}
        | INTEL {
d42 5
a46 7
        | EOL {
        }
        ;

EMAX5ABODY : START LOC { /* reset conf[][] */
          encode.map_dist = 0;
	  bzero(&encode, sizeof(encode));
a47 1
	  bzero(&decode, sizeof(decode));
a48 1
	  bzero(&regmap, sizeof(regmap));
d51 1
a51 8
	  bzero(&memi, sizeof(memi));
          printf("reading EMAX5A %s\n", label[$2].name);
          fprintf(ofile, "%s /* start-label */\n", ($2)!=-1?label[$2].name:"");
        }
        | CTL M_DIST "=" IMMEDIATE {
          encode.map_dist  = label[$4].val;
	}
        | insn condop aluop alureginit "&" memop memreginit memctl {
d53 2
a54 2
        | insn condop aluop alureginit {
          //fprintf(ofile, "\t.word\t0,0,0,0,0 /* mem-nop */\n");
d56 2
a57 1
        | END LOC { /* emit conf[][] */
d59 5
a63 5
          fprintf(ofile, "%s /* end-label */\n", ($2)!=-1?label[$2].name:"");
	}
        ;

EMAX5TBODY : START LOC { /* reset conf[][] */
d65 1
a65 5
          printf("reading EMAX5T %s\n", label[$2].name);
          fprintf(ofile, "%s /* start-label */\n", ($2)!=-1?label[$2].name:"");
        }
        | tran_pc READ tran_base tran_ofs tran_oper tran_dst {
          trans[trans_pc].rw = 0;
d67 2
a68 2
        | tran_pc WRITE tran_base tran_ofs tran_oper tran_src {
          trans[trans_pc].rw = 1;
d70 2
a71 1
        | END LOC { /* emit conf[][] */
a72 1
          fprintf(ofile, "%s /* end-label */\n", ($2)!=-1?label[$2].name:"");
d76 34
a109 6
tran_pc : "@@" IMMEDIATE {
          trans_pc = label[$2].val;
          if (trans_pc >= TRANS_DEPTH) {
	    fprintf(stderr, "trans_pc exceeds TRANS_DEPTH=%d.\n", TRANS_DEPTH);
	    exit(1);
	  }
d113 5
a117 11
tran_base : REGV "=" REGNO {
          trans[trans_pc].base_type = 0;
          trans[trans_pc].base_num  = $3;
        }
        | BASE "=" REGNO {
          trans[trans_pc].base_type = 1;
          trans[trans_pc].base_num  = $3;
        }
        | BASE "=" LABEL {
          trans[trans_pc].base_type = 2;
          trans[trans_pc].base_symbol = label[$3].name;
d119 1
a119 1
        ;
d121 2
a122 29
tran_ofs : OFS "=" REGNO {
          trans[trans_pc].offset_type   = 0;
          trans[trans_pc].offset        = $3;
          trans[trans_pc].offset_suffix = 0;
          trans[trans_pc].offset_sll    = 0;
	}
        | OFS "=" REGNO SLL IMMEDIATE {
          trans[trans_pc].offset_type   = 0;
          trans[trans_pc].offset        = $3;
          trans[trans_pc].offset_suffix = 0;
          trans[trans_pc].offset_sll    = label[$5].val;
	}
        | OFS "=" REGNO SUFB0 SLL IMMEDIATE {
          trans[trans_pc].offset_type   = 0;
          trans[trans_pc].offset        = $3;
          trans[trans_pc].offset_suffix = 4;
          trans[trans_pc].offset_sll    = label[$6].val;
	}
	| OFS "=" IMMEDIATE {
          trans[trans_pc].offset_type   = 1;
          trans[trans_pc].offset        = label[$3].val;
          trans[trans_pc].offset_suffix = 0;
          trans[trans_pc].offset_sll    = 0;
        }
        | {
          trans[trans_pc].offset_type   = 1;
          trans[trans_pc].offset        = 0;
          trans[trans_pc].offset_suffix = 0;
          trans[trans_pc].offset_sll    = 0;
d124 2
a125 61
        ;

tran_oper : "+" REGNO {
          trans[trans_pc].op_type       = 1;
          trans[trans_pc].op_val_type   = 0;
          trans[trans_pc].op_val_num    = $2;
	}
        | "+" IMMEDIATE {
          trans[trans_pc].op_type       = 1;
          trans[trans_pc].op_val_type   = 1;
          trans[trans_pc].op_val_num    = label[$2].val;
	}
        | "?" EQ "(" REGNO ")" tran_action {
          trans[trans_pc].op_type       = 2;
          trans[trans_pc].op_val_type   = 0;
          trans[trans_pc].op_val_num    = $4;
        }
        | "?" EQ "(" IMMEDIATE ")" tran_action {
          trans[trans_pc].op_type       = 2;
          trans[trans_pc].op_val_type   = 1;
          trans[trans_pc].op_val_num    = label[$4].val;
        }
        | "?" EQ "(" LABEL ")" tran_action {
          trans[trans_pc].op_type       = 2;
          trans[trans_pc].op_val_type   = 2;
          trans[trans_pc].op_val_symbol = label[$4].name;
        }
        | "?" NE "(" REGNO ")" tran_action {
          trans[trans_pc].op_type       = 3;
          trans[trans_pc].op_val_type   = 0;
          trans[trans_pc].op_val_num    = $4;
	}
        | "?" NE "(" IMMEDIATE ")" tran_action {
          trans[trans_pc].op_type       = 3;
          trans[trans_pc].op_val_type   = 1;
          trans[trans_pc].op_val_num    = label[$4].val;
	}
        | "?" NE "(" LABEL ")" tran_action {
          trans[trans_pc].op_type       = 3;
          trans[trans_pc].op_val_type   = 2;
          trans[trans_pc].op_val_symbol = label[$4].name;
	}
        | "?" GE "(" REGNO ")" tran_action {
          trans[trans_pc].op_type       = 4;
          trans[trans_pc].op_val_type   = 0;
          trans[trans_pc].op_val_num    = $4;
	}
        | "?" GE "(" IMMEDIATE ")" tran_action {
          trans[trans_pc].op_type       = 4;
          trans[trans_pc].op_val_type   = 1;
          trans[trans_pc].op_val_num    = label[$4].val;
	}
        | "?" GE "(" LABEL ")" tran_action {
          trans[trans_pc].op_type       = 4;
          trans[trans_pc].op_val_type   = 2;
          trans[trans_pc].op_val_symbol = label[$4].name;
	}
        | tran_action {
          trans[trans_pc].op_type       = 0;
          trans[trans_pc].op_val_type   = 0;
          trans[trans_pc].op_val_num    = 0;
d127 5
a131 33
        | {
          trans[trans_pc].op_type       = 0;
	}
        ;

tran_action : tran_action_term tran_action_term {
          if ($1 == -1)
	    trans[trans_pc].t_action_type = 1; /* term */
	  else if ($1 == -2)
	    trans[trans_pc].t_action_type = 2; /* error */
	  else {
	    trans[trans_pc].t_action_type = 3;  /* goto */
	    trans[trans_pc].t_action      = $1; /* goto */
	  }
	  if ($2 == -1)
	    trans[trans_pc].f_action_type = 1; /* term */
	  else if ($2 == -2)
	    trans[trans_pc].f_action_type = 2; /* error */
	  else {
	    trans[trans_pc].f_action_type = 3;  /* goto */
	    trans[trans_pc].f_action      = $2; /* goto */
	  }
        }
        | tran_action_term {
          if ($1 == -1)
	    trans[trans_pc].t_action_type = 1; /* term */
	  else if ($1 == -2)
	    trans[trans_pc].t_action_type = 2; /* error */
	  else {
	    trans[trans_pc].t_action_type = 3;  /* goto */
	    trans[trans_pc].t_action      = $1; /* goto */
	  }
	  trans[trans_pc].f_action_type = 0;  /* none */
d133 1
a133 1
        ;
d135 2
a136 2
tran_action_term : TERM {
          $$ = -1;
d138 17
a154 15
        | ERROR {
          $$ = -2;
        }
        | "@@" IMMEDIATE {
	  $$ = label[$2].val;
        }
        ;

tran_src : SRC "=" REGNO {
          trans[trans_pc].reg_type = 0;
          trans[trans_pc].reg_num  = $3;
        }
        | SRC "=" LABEL {
	  trans[trans_pc].reg_type   = 1;
	  trans[trans_pc].reg_symbol = label[$3].name;
d156 1
a156 1
        ;
d158 2
a159 3
tran_dst : DST "=" REGNO {
          trans[trans_pc].reg_type   = 0;
          trans[trans_pc].reg_num    = $3;
d161 13
a173 1
        ;
d175 2
a176 20
insn :  "@@" IMMEDIATE "," IMMEDIATE {
	  encode.insn_row  = label[$2].val;
	  encode.insn_col  = label[$4].val;
          if (encode.insn_row >= INSN_DEPTH) {
	    fprintf(stderr, "insn_row exceeds INSN_DEPTH=%d.\n", INSN_DEPTH);
	    exit(1);
	  }
          if (encode.insn_col >= INSN_WIDTH) {
	    fprintf(stderr, "insn_col exceeds INSN_WIDTH=%d.\n", INSN_WIDTH);
	    exit(1);
	  }
	  encode.reg_inuse = 0;
          encode.regspec_top = 0; /* reset */
          encode.ccrspec_top = 0; /* reset */
	  insn[encode.insn_row][encode.insn_col].header.v         = 1;
	  insn[encode.insn_row][encode.insn_col].header.insn_row  = encode.insn_row;
	  insn[encode.insn_row][encode.insn_col].header.insn_col  = encode.insn_col;
	  insn[encode.insn_row][encode.insn_col].header.map_dist  = encode.map_dist;
          //fprintf(ofile, "//insn%d.%d map_dist=%d\n", encode.insn_row, encode.insn_col, encode.map_dist);
	  //fprintf(ofile, "\t.word\t0x%08.8x\n", *((int*)(&insn[encode.insn_row][encode.insn_col].header)));
d178 11
a188 6
        ;

condop : CEXE "(" CCR "," CCR "," CCR "," CCR "," expr ")" {
	  set_insn_cond_ccr_ccr_ccr_ccr_expr_template($3, $5, $7, $9, $11);
        }
	| {
d192 2
a193 54
aluop : ex1 "|" ex2 shift "," REG CCR {
          /* type-1: ex1 (regX, regY/imm32)       | ex2 (-,   regZ) [<< imm5], regD */
          /* type-2: ex1 (regX, regY/imm32)       | ex2 (-, simm14) [<< regZ], regD */
          /* type-3: ex1 (regX, regY/imm32)       | ex2 (-, simm14) [<< imm5], regD */
          /* type-4: ex1 (regX, regY/imm32)       | ex2 (-)         [<< regZ], regD */
          /* type-5: ex1 (regX, regY/imm32)       | ex2 (-)         [<< imm5], regD */
          /* type-6: ex1 (regX, regY/imm32, regZ) | ex2 (-, simm14) [<< imm5], regD */
          /* type-7: ex1 (regX, regY/imm32, regZ) | ex2 (-)         [<< imm5], regD */
          insn[encode.insn_row][encode.insn_col].alu.Dw_v   = encode.regspec[$6].type>0;
          insn[encode.insn_row][encode.insn_col].alu.Dw     = encode.regspec[$6].num;
	  insn[encode.insn_row][encode.insn_col].alu.Cw_v   = encode.ccrspec[$7].type>0;
          insn[encode.insn_row][encode.insn_col].alu.Cw     = encode.ccrspec[$7].num;
        }
        |   "|" ex2 shift "," REG CCR {
          /* type-8:|ex2 (regX, regY/imm32) [<< regZ], regD */
          /* type-9:|ex2 (regX, regY/imm32) [<< imm5], regD */
          /* type-a:|ex2 (regX)             [<< regZ], regD */
          /* type-b:|ex2 (regX)             [<< imm5], regD */
	  insn[encode.insn_row][encode.insn_col].alu.ex1_op = OP_NOP;
	  insn[encode.insn_row][encode.insn_col].alu.Dw_v   = encode.regspec[$5].type>0;
	  insn[encode.insn_row][encode.insn_col].alu.Dw     = encode.regspec[$5].num;
	  insn[encode.insn_row][encode.insn_col].alu.Cw_v   = encode.ccrspec[$6].type>0;
	  insn[encode.insn_row][encode.insn_col].alu.Cw     = encode.ccrspec[$6].num;
        }
        | ex1 "," REG CCR {
          /* type-c:ex1 (regX, regY/imm32)      , regD */
          /* type-d:ex1 (regX, regY/imm32, regZ), regD */
	  insn[encode.insn_row][encode.insn_col].alu.ex2_op = OP_NOP;
	  insn[encode.insn_row][encode.insn_col].alu.sft_op = OP_NOP;
          insn[encode.insn_row][encode.insn_col].alu.simmS_v= 0;
          insn[encode.insn_row][encode.insn_col].alu.immT_v = 0;
          insn[encode.insn_row][encode.insn_col].alu.Dw_v   = encode.regspec[$3].type>0;
          insn[encode.insn_row][encode.insn_col].alu.Dw     = encode.regspec[$3].num;
	  insn[encode.insn_row][encode.insn_col].alu.Cw_v   = encode.ccrspec[$4].type>0;
	  insn[encode.insn_row][encode.insn_col].alu.Cw     = encode.ccrspec[$4].num;
        }
        | ex1 {
          /* type-e:ex1 (regX, regY/imm32)       */
          /* type-f:ex1 (regX, regY/imm32, regZ) */
	  insn[encode.insn_row][encode.insn_col].alu.ex2_op = OP_NOP;
	  insn[encode.insn_row][encode.insn_col].alu.sft_op = OP_NOP;
          insn[encode.insn_row][encode.insn_col].alu.simmS_v= 0;
          insn[encode.insn_row][encode.insn_col].alu.immT_v = 0;
          insn[encode.insn_row][encode.insn_col].alu.Dw_v   = 0;
	  insn[encode.insn_row][encode.insn_col].alu.Cw_v   = 0;
        }
        | {
	  insn[encode.insn_row][encode.insn_col].alu.ex1_op = OP_NOP;
	  insn[encode.insn_row][encode.insn_col].alu.ex2_op = OP_NOP;
	  insn[encode.insn_row][encode.insn_col].alu.sft_op = OP_NOP;
          insn[encode.insn_row][encode.insn_col].alu.simmS_v= 0;
          insn[encode.insn_row][encode.insn_col].alu.immT_v = 0;
          insn[encode.insn_row][encode.insn_col].alu.Dw_v   = 0;
	  insn[encode.insn_row][encode.insn_col].alu.Cw_v   = 0;
d195 2
a196 4
        ;

ex1 :   LDB "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_LDB, $3, $5);
d198 2
a199 2
        | LDB "(" REG "," expr ")" {
	  set_insn_ex1_reg_expr_template(OP_LDB, $3, $5);
d201 4
a204 187
        | LDUB "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_LDUB, $3, $5);
        }
        | LDUB "(" REG "," expr ")" {
	  set_insn_ex1_reg_expr_template(OP_LDUB, $3, $5);
        }
        | LDH "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_LDH, $3, $5);
        }
        | LDH "(" REG "," expr ")" {
	  set_insn_ex1_reg_expr_template(OP_LDH, $3, $5);
        }
        | LDUH "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_LDUH, $3, $5);
        }
        | LDUH "(" REG "," expr ")" {
	  set_insn_ex1_reg_expr_template(OP_LDUH, $3, $5);
        }
        | LD "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_LD, $3, $5);
        }
        | LD "(" REG "," expr ")" {
	  set_insn_ex1_reg_expr_template(OP_LD, $3, $5);
        }
        | WHILE "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_WHILE, $3, $5);
        }
        | WHILE "(" REG "," expr ")" {
	  set_insn_ex1_reg_expr_template(OP_WHILE, $3, $5);
        }
        | ADD "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_ADD, $3, $5);
        }
        | ADD "(" REG "," expr ")" {
	  set_insn_ex1_reg_expr_template(OP_ADD, $3, $5);
        }
        | ADD "(" expr "," REG ")" {
	  set_insn_ex1_expr_reg_template(OP_ADD, $3, $5);
        }
        | ADD3 "(" REG "," REG "," REG ")" {
	  set_insn_ex1_reg_reg_reg_template(OP_ADD3, $3, $5, $7);
        }
        | ADD3 "(" REG "," expr "," REG ")" {
	  set_insn_ex1_reg_expr_reg_template(OP_ADD3, $3, $5, $7);
        }
        | ADD3 "(" expr "," REG "," REG ")" {
	  set_insn_ex1_expr_reg_reg_template(OP_ADD3, $3, $5, $7);
        }
        | SUB "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_SUB, $3, $5);
        }
        | SUB "(" REG "," expr ")" {
	  set_insn_ex1_reg_expr_template(OP_SUB, $3, $5);
        }
        | SUB "(" expr "," REG ")" {
	  set_insn_ex1_expr_reg_template(OP_SUB, $3, $5);
        }
        | SUB3 "(" REG "," REG "," REG ")" {
	  set_insn_ex1_reg_reg_reg_template(OP_SUB3, $3, $5, $7);
        }
        | SUB3 "(" REG "," expr "," REG ")" {
	  set_insn_ex1_reg_expr_reg_template(OP_SUB3, $3, $5, $7);
        }
        | SUB3 "(" expr "," REG "," REG ")" {
	  set_insn_ex1_expr_reg_reg_template(OP_SUB3, $3, $5, $7);
        }
        | MAUH "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_MAUH, $3, $5);
        }
        | MAUH3 "(" REG "," REG "," REG ")" {
	  set_insn_ex1_reg_reg_reg_template(OP_MAUH3, $3, $5, $7);
        }
        | MSUH "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_MSUH, $3, $5);
        }
        | MSUH3 "(" REG "," REG "," REG ")" {
	  set_insn_ex1_reg_reg_reg_template(OP_MSUH3, $3, $5, $7);
        }
        | MLUH "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_MLUH, $3, $5);
        }
        | MMRG3 "(" REG "," REG "," REG ")" {
	  set_insn_ex1_reg_reg_reg_template(OP_MMRG3, $3, $5, $7);
        }
        | MSAD "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_MSAD, $3, $5);
        }
        | MINL "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_MINL, $3, $5);
        }
        | MINL3 "(" REG "," REG "," REG ")" {
	  set_insn_ex1_reg_reg_reg_template(OP_MINL3, $3, $5, $7);
        }
        | MH2BW "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_MH2BW, $3, $5);
        }
        | MCAS "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_MCAS, $3, $5);
        }
        | MMID3 "(" REG "," REG "," REG ")" {
	  set_insn_ex1_reg_reg_reg_template(OP_MMID3, $3, $5, $7);
        }
        | MMAX "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_MMAX, $3, $5);
        }
        | MMAX3 "(" REG "," REG "," REG ")" {
	  set_insn_ex1_reg_reg_reg_template(OP_MMAX3, $3, $5, $7);
        }
        | MMIN "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_MMIN, $3, $5);
        }
        | MMIN3 "(" REG "," REG "," REG ")" {
	  set_insn_ex1_reg_reg_reg_template(OP_MMIN3, $3, $5, $7);
        }
        | FMUL "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_FMUL, $3, $5);
        }
        | FMA3 "(" REG "," REG "," REG ")" {
	  set_insn_ex1_reg_reg_reg_template(OP_FMA3, $3, $5, $7);
        }
        | FADD "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_FADD, $3, $5);
        }
        | CMPEQ "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_CMPEQ, $3, $5);
        }
        | CMPEQ "(" REG "," expr ")" {
	  set_insn_ex1_reg_expr_template(OP_CMPEQ, $3, $5);
        }
        | CMPEQ "(" expr "," REG ")" {
	  set_insn_ex1_expr_reg_template(OP_CMPEQ, $3, $5);
        }
        | CMPNE "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_CMPNE, $3, $5);
        }
        | CMPNE "(" REG "," expr ")" {
	  set_insn_ex1_reg_expr_template(OP_CMPNE, $3, $5);
        }
        | CMPNE "(" expr "," REG ")" {
	  set_insn_ex1_expr_reg_template(OP_CMPNE, $3, $5);
        }
        | CMPLT "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_CMPLT, $3, $5);
        }
        | CMPLT "(" REG "," expr ")" {
	  set_insn_ex1_reg_expr_template(OP_CMPLT, $3, $5);
        }
        | CMPLT "(" expr "," REG ")" {
	  set_insn_ex1_expr_reg_template(OP_CMPLT, $3, $5);
        }
        | CMPLE "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_CMPLE, $3, $5);
        }
        | CMPLE "(" REG "," expr ")" {
	  set_insn_ex1_reg_expr_template(OP_CMPLE, $3, $5);
        }
        | CMPLE "(" expr "," REG ")" {
	  set_insn_ex1_expr_reg_template(OP_CMPLE, $3, $5);
        }
        | CMPGT "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_CMPGT, $3, $5);
        }
        | CMPGT "(" REG "," expr ")" {
	  set_insn_ex1_reg_expr_template(OP_CMPGT, $3, $5);
        }
        | CMPGT "(" expr "," REG ")" {
	  set_insn_ex1_expr_reg_template(OP_CMPGT, $3, $5);
        }
        | CMPGE "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_CMPGE, $3, $5);
        }
        | CMPGE "(" REG "," expr ")" {
	  set_insn_ex1_reg_expr_template(OP_CMPGE, $3, $5);
        }
        | CMPGE "(" expr "," REG ")" {
	  set_insn_ex1_expr_reg_template(OP_CMPGE, $3, $5);
        }
        | CMOV "(" REG "," REG ")" {
	  set_insn_ex1_reg_reg_template(OP_CMOV, $3, $5);
        }
        | CMOV "(" REG "," expr ")" {
	  set_insn_ex1_reg_expr_template(OP_CMOV, $3, $5);
        }
        | CMOV "(" expr "," REG ")" {
	  set_insn_ex1_expr_reg_template(OP_CMOV, $3, $5);
        }
        ;
d206 2
a207 2
ex2 :   AND "(" REG "," REG ")" { /* (-) or regX, regY or regZ */
	  set_insn_ex2_reg_reg_template(OP_AND, $3, $5);
d209 2
a210 2
        | AND "(" REG "," expr ")" { /* (-) or regX */
	  set_insn_ex2_reg_expr_template(OP_AND, $3, $5);
d212 2
a213 2
        | OR "(" REG "," REG ")" { /* (-) or regX, regY or regZ */
	  set_insn_ex2_reg_reg_template(OP_OR, $3, $5);
d215 1
a215 16
        | OR "(" REG "," expr ")" { /* (-) or regX */
	  set_insn_ex2_reg_expr_template(OP_OR, $3, $5);
        }
        | XOR "(" REG "," REG ")" { /* (-) or regX, regY or regZ */
	  set_insn_ex2_reg_reg_template(OP_XOR, $3, $5);
        }
        | XOR "(" REG "," expr ")" { /* (-) or regX */
	  set_insn_ex2_reg_expr_template(OP_XOR, $3, $5);
        }
        | SUMH "(" REG ")" { /* (-) or regX */
	  set_insn_ex2_reg_template(OP_SUMH, $3);
        }
        | SUML "(" REG ")" { /* (-) or regX */
	  set_insn_ex2_reg_template(OP_SUML, $3);
        }
        ;
d217 1
a217 175
shift : SLL REG {
	  set_insn_sft_reg_template(OP_SLL, $2);
        }
        | SLL IMMEDIATE {
	  set_insn_sft_expr_template(OP_SLL, label[$2].val);
        }
        | SRL REG {
	  set_insn_sft_reg_template(OP_SRL, $2);
        }
        | SRL IMMEDIATE {
	  set_insn_sft_expr_template(OP_SRL, label[$2].val);
        }
        | MSRL REG {
	  set_insn_sft_reg_template(OP_MSRL, $2);
        }
        | MSRL IMMEDIATE {
	  set_insn_sft_expr_template(OP_MSRL, label[$2].val);
        }
        | SRA31 REG {
	  set_insn_sft_reg_template(OP_SRA31, $2);
        }
        | SRA31 IMMEDIATE {
	  set_insn_sft_expr_template(OP_SRA31, label[$2].val);
        }
        | SRA23 REG {
	  set_insn_sft_reg_template(OP_SRA23, $2);
        }
        | SRA23 IMMEDIATE {
	  set_insn_sft_expr_template(OP_SRA23, label[$2].val);
        }
        | SRA15 REG {
	  set_insn_sft_reg_template(OP_SRA15, $2);
        }
        | SRA15 IMMEDIATE {
	  set_insn_sft_expr_template(OP_SRA15, label[$2].val);
        }
        | SRA07 REG {
	  set_insn_sft_reg_template(OP_SRA07, $2);
        }
        | SRA07 IMMEDIATE {
	  set_insn_sft_expr_template(OP_SRA07, label[$2].val);
        }
        | {
	  insn[encode.insn_row][encode.insn_col].alu.sft_op = OP_NOP;
          insn[encode.insn_row][encode.insn_col].alu.immT_v = 0;
        }
        ;

memop : LDB "(" REG "," REG ")" "," REG {
	  set_insn_mem_reg_reg_template(OP_LDB, $3, $5, $8);
        }
        | LDB "(" REG "," expr ")" "," REG {
	  set_insn_mem_reg_expr_template(OP_LDB, $3, $5, $8);
        }
        | LDB "(" expr "," REG ")" "," REG {
	  set_insn_mem_expr_reg_template(OP_LDB, $3, $5, $8);
        }
        | LDUB "(" REG "," REG ")" "," REG {
	  set_insn_mem_reg_reg_template(OP_LDUB, $3, $5, $8);
        }
        | LDUB "(" REG "," expr ")" "," REG {
	  set_insn_mem_reg_expr_template(OP_LDUB, $3, $5, $8);
        }
        | LDUB "(" expr "," REG ")" "," REG {
	  set_insn_mem_expr_reg_template(OP_LDUB, $3, $5, $8);
        }
        | LDH "(" REG "," REG ")" "," REG {
	  set_insn_mem_reg_reg_template(OP_LDH, $3, $5, $8);
        }
        | LDH "(" REG "," expr ")" "," REG {
	  set_insn_mem_reg_expr_template(OP_LDH, $3, $5, $8);
        }
        | LDH "(" expr "," REG ")" "," REG {
	  set_insn_mem_expr_reg_template(OP_LDH, $3, $5, $8);
        }
        | LDUH "(" REG "," REG ")" "," REG {
	  set_insn_mem_reg_reg_template(OP_LDUH, $3, $5, $8);
        }
        | LDUH "(" REG "," expr ")" "," REG {
	  set_insn_mem_reg_expr_template(OP_LDUH, $3, $5, $8);
        }
        | LDUH "(" expr "," REG ")" "," REG {
	  set_insn_mem_expr_reg_template(OP_LDUH, $3, $5, $8);
        }
        | LD "(" REG "," REG ")" "," REG {
	  set_insn_mem_reg_reg_template(OP_LD, $3, $5, $8);
        }
        | LD "(" REG "," expr ")" "," REG {
	  set_insn_mem_reg_expr_template(OP_LD, $3, $5, $8);
        }
        | LD "(" expr "," REG ")" "," REG {
	  set_insn_mem_expr_reg_template(OP_LD, $3, $5, $8);
        }
        | STB REG "," "(" REG "," REG ")" {
	  set_insn_mem_reg_reg_template(OP_STB, $5, $7, $2);
        }
        | STB REG "," "(" REG "," expr ")" {
	  set_insn_mem_reg_expr_template(OP_STB, $5, $7, $2);
        }
        | STB REG "," "(" expr "," REG ")" {
	  set_insn_mem_expr_reg_template(OP_STB, $5, $7, $2);
        }
        | STH REG "," "(" REG "," REG ")" {
	  set_insn_mem_reg_reg_template(OP_STH, $5, $7, $2);
        }
        | STH REG "," "(" REG "," expr ")" {
	  set_insn_mem_reg_expr_template(OP_STH, $5, $7, $2);
        }
        | STH REG "," "(" expr "," REG ")" {
	  set_insn_mem_expr_reg_template(OP_STH, $5, $7, $2);
        }
        | ST REG "," "(" REG "," REG ")" {
	  set_insn_mem_reg_reg_template(OP_ST, $5, $7, $2);
        }
        | ST REG "," "(" REG "," expr ")" {
	  set_insn_mem_reg_expr_template(OP_ST, $5, $7, $2);
        }
        | ST REG "," "(" expr "," REG ")" {
	  set_insn_mem_expr_reg_template(OP_ST, $5, $7, $2);
        }
        | {
	  insn[encode.insn_row][encode.insn_col].mem.op = OP_NOP;
        }
        ;

REG :   RI POSTI {
          $$ = set_regno_template(1, 3, 0, 1);
        }
        | RI {
          $$ = set_regno_template(1, 3, 0, 0);
        }
        | REGNO SUFFL {
          $$ = set_regno_template(3, 3, $1, 0);
        }
        | REGNO SUFHI {
          $$ = set_regno_template(3, 2, $1, 0);
        }
        | REGNO SUFLO {
          $$ = set_regno_template(3, 1, $1, 0);
        }
        | REGNO SUFB3 {
          $$ = set_regno_template(3, 7, $1, 0);
        }
        | REGNO SUFB2 {
          $$ = set_regno_template(3, 6, $1, 0);
        }
        | REGNO SUFB1 {
          $$ = set_regno_template(3, 5, $1, 0);
        }
        | REGNO SUFB0 {
          $$ = set_regno_template(3, 4, $1, 0);
        }
        | REGNO POSTI {
          $$ = set_regno_template(3, 3, $1, 1);
        }
        | REGNO {
          $$ = set_regno_template(3, 3, $1, 0);
        }
        | "-" {
	  $$ = set_regno_template(2, 3, 0, 0);
        }
        | {
	  $$ = set_regno_template(0, 0, 0, 0);
        }
        ;

CCR:    CCRNO {
          $$ = set_ccrno_template(3, $1);
        }
        | {
	  $$ = set_ccrno_template(0, 0);
        }
        ;

LOC :   LABEL {
d220 1
a220 1
        | IMMEDIATE {
d222 2
a223 5
        }
        | {
          $$ = -1;
        }
        ;
d225 2
a226 2
expr :  IMMEDIATE {
          $$ = label[$1].val;
d228 1
a228 10
        | "\~" IMMEDIATE {
          $$ = ~ label[$2].val;
        }
        | "(" expr SLL expr ")" {
          $$ = $2 << $4;
        }
        | "(" expr SRL expr ")" {
          $$ = $2 >> $4;
        }
        ;
d230 5
a234 152
alureginit : RGI "[" LOC "," LOC "]" {
	  emit_emax_alu();
          //fprintf(ofile, "%s\t.word\t0x%08.8x /* alu-reginit#X */\n", ($3)!=-1?label[$3].name:"", insn[encode.insn_row][encode.insn_col].alu.initX);
          //fprintf(ofile, "%s\t.word\t0x%08.8x /* alu-reginit#Y */\n", ($5)!=-1?label[$5].name:"", insn[encode.insn_row][encode.insn_col].alu.initY);
	  insn[encode.insn_row][encode.insn_col].alu.initX_symbol = ($3)!=-1?label[$3].type==T_LABEL?label[$3].name:NULL:NULL;
	  if (($3)!=-1 && label[$3].type==T_IMMEDIATE) insn[encode.insn_row][encode.insn_col].alu.initX = label[$3].val;
	  insn[encode.insn_row][encode.insn_col].alu.initY_symbol = ($5)!=-1?label[$5].type==T_LABEL?label[$5].name:NULL:NULL;
	  if (($5)!=-1 && label[$5].type==T_IMMEDIATE) insn[encode.insn_row][encode.insn_col].alu.initY = label[$5].val;
        }
        | {
	  emit_emax_alu();
          //fprintf(ofile, "\t.word\t0x%08.8x /* alu-reginit#X */\n", insn[encode.insn_row][encode.insn_col].alu.initX);
          //fprintf(ofile, "\t.word\t0x%08.8x /* alu-reginit#Y */\n", insn[encode.insn_row][encode.insn_col].alu.initY);
        }
        ;

memreginit : RGI "[" LOC "," LOC "]" {
	  emit_emax_mem();
          //fprintf(ofile, "%s\t.word\t0x%08.8x /* mem-reginit#X */\n", ($3)!=-1?label[$3].name:"", insn[encode.insn_row][encode.insn_col].mem.initX);
          //fprintf(ofile, "%s\t.word\t0x%08.8x /* mem-reginit#Y */\n", ($5)!=-1?label[$5].name:"", insn[encode.insn_row][encode.insn_col].mem.initY);
	  insn[encode.insn_row][encode.insn_col].mem.initX_symbol = ($3)!=-1?label[$3].type==T_LABEL?label[$3].name:NULL:NULL;
	  if (($3)!=-1 && label[$3].type==T_IMMEDIATE) insn[encode.insn_row][encode.insn_col].mem.initX = label[$3].val;
	  insn[encode.insn_row][encode.insn_col].mem.initY_symbol = ($5)!=-1?label[$5].type==T_LABEL?label[$5].name:NULL:NULL;
	  if (($5)!=-1 && label[$5].type==T_IMMEDIATE) insn[encode.insn_row][encode.insn_col].mem.initY = label[$5].val;
        }
        | {
	  emit_emax_mem();
          //fprintf(ofile, "\t.word\t0x%08.8x /* mem-reginit#X */\n", insn[encode.insn_row][encode.insn_col].mem.initX);
          //fprintf(ofile, "\t.word\t0x%08.8x /* mem-reginit#Y */\n", insn[encode.insn_row][encode.insn_col].mem.initY);
        }
        ;

memctl : LMR "[" LOC "," IMMEDIATE "," IMMEDIATE "," IMMEDIATE "," IMMEDIATE "," LOC "," LOC "]" {
	  insn[encode.insn_row][encode.insn_col].ctl.v               = 1;
	  insn[encode.insn_row][encode.insn_col].ctl.bank            = label[$5].val;
	  insn[encode.insn_row][encode.insn_col].ctl.width           = label[$7].val;
	  insn[encode.insn_row][encode.insn_col].ctl.block           = label[$9].val;
	  insn[encode.insn_row][encode.insn_col].ctl.dist            = label[$11].val;
	  emit_emax_ctl();
          //fprintf(ofile, "%s\t.word\t0x%08.8x\n", ($5)!=-1?label[$5].name:"", insn[encode.insn_row][encode.insn_col].ctl.top);
	  insn[encode.insn_row][encode.insn_col].ctl.lmm_top_symbol = ($3 )!=-1?label[$3 ].type==T_LABEL?label[$3 ].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.lmm_top        = ($3 )!=-1?label[$3 ].val:0;
	  insn[encode.insn_row][encode.insn_col].ctl.mem_top_symbol = ($13)!=-1?label[$13].type==T_LABEL?label[$13].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.mem_top        = ($13)!=-1?label[$13].val:0;
	  insn[encode.insn_row][encode.insn_col].ctl.len_symbol     = ($15)!=-1?label[$15].type==T_LABEL?label[$15].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.len            = ($15)!=-1?label[$15].val:0;
        }
        | LMW "[" LOC "," IMMEDIATE "," IMMEDIATE "," IMMEDIATE "," IMMEDIATE "," LOC "," LOC "]" {
	  insn[encode.insn_row][encode.insn_col].ctl.v               = 2;
	  insn[encode.insn_row][encode.insn_col].ctl.bank            = label[$5].val;
	  insn[encode.insn_row][encode.insn_col].ctl.width           = label[$7].val;
	  insn[encode.insn_row][encode.insn_col].ctl.block           = label[$9].val;
	  insn[encode.insn_row][encode.insn_col].ctl.dist            = label[$11].val;
	  emit_emax_ctl();
          //fprintf(ofile, "%s\t.word\t0x%08.8x\n", ($5)!=-1?label[$5].name:"", insn[encode.insn_row][encode.insn_col].ctl.top);
	  insn[encode.insn_row][encode.insn_col].ctl.lmm_top_symbol = ($3 )!=-1?label[$3 ].type==T_LABEL?label[$3 ].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.lmm_top        = ($3 )!=-1?label[$3 ].val:0;
	  insn[encode.insn_row][encode.insn_col].ctl.mem_top_symbol = ($13)!=-1?label[$13].type==T_LABEL?label[$13].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.mem_top        = ($13)!=-1?label[$13].val:0;
	  insn[encode.insn_row][encode.insn_col].ctl.len_symbol     = ($15)!=-1?label[$15].type==T_LABEL?label[$15].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.len            = ($15)!=-1?label[$15].val:0;
        }
        | LMX "[" LOC "," IMMEDIATE "," IMMEDIATE "," IMMEDIATE "," IMMEDIATE "," LOC "," LOC "]" {
	  insn[encode.insn_row][encode.insn_col].ctl.v               = 3;
	  insn[encode.insn_row][encode.insn_col].ctl.bank            = label[$5].val;
	  insn[encode.insn_row][encode.insn_col].ctl.width           = label[$7].val;
	  insn[encode.insn_row][encode.insn_col].ctl.block           = label[$9].val;
	  insn[encode.insn_row][encode.insn_col].ctl.dist            = label[$11].val;
	  emit_emax_ctl();
          //fprintf(ofile, "%s\t.word\t0x%08.8x\n", ($5)!=-1?label[$5].name:"", insn[encode.insn_row][encode.insn_col].ctl.top);
	  insn[encode.insn_row][encode.insn_col].ctl.lmm_top_symbol = ($3 )!=-1?label[$3 ].type==T_LABEL?label[$3 ].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.lmm_top        = ($3 )!=-1?label[$3 ].val:0;
	  insn[encode.insn_row][encode.insn_col].ctl.mem_top_symbol = ($13)!=-1?label[$13].type==T_LABEL?label[$13].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.mem_top        = ($13)!=-1?label[$13].val:0;
	  insn[encode.insn_row][encode.insn_col].ctl.len_symbol     = ($15)!=-1?label[$15].type==T_LABEL?label[$15].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.len            = ($15)!=-1?label[$15].val:0;
        }
        | LMP "[" LOC "," IMMEDIATE "," IMMEDIATE "," IMMEDIATE "," IMMEDIATE "," LOC "," LOC "]" {
	  insn[encode.insn_row][encode.insn_col].ctl.v               = 4;
	  insn[encode.insn_row][encode.insn_col].ctl.bank            = label[$5].val;
	  insn[encode.insn_row][encode.insn_col].ctl.width           = label[$7].val;
	  insn[encode.insn_row][encode.insn_col].ctl.block           = label[$9].val;
	  insn[encode.insn_row][encode.insn_col].ctl.dist            = label[$11].val;
	  emit_emax_ctl();
          //fprintf(ofile, "%s\t.word\t0x%08.8x\n", ($5)!=-1?label[$5].name:"", insn[encode.insn_row][encode.insn_col].ctl.top);
	  insn[encode.insn_row][encode.insn_col].ctl.lmm_top_symbol = ($3 )!=-1?label[$3 ].type==T_LABEL?label[$3 ].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.lmm_top        = ($3 )!=-1?label[$3 ].val:0;
	  insn[encode.insn_row][encode.insn_col].ctl.mem_top_symbol = ($13)!=-1?label[$13].type==T_LABEL?label[$13].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.mem_top        = ($13)!=-1?label[$13].val:0;
	  insn[encode.insn_row][encode.insn_col].ctl.len_symbol     = ($15)!=-1?label[$15].type==T_LABEL?label[$15].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.len            = ($15)!=-1?label[$15].val:0;
        }
        | LMF "[" LOC "," IMMEDIATE "," IMMEDIATE "," IMMEDIATE "," IMMEDIATE "," LOC "," LOC "]" {
	  insn[encode.insn_row][encode.insn_col].ctl.v               = 5;
	  insn[encode.insn_row][encode.insn_col].ctl.bank            = label[$5].val;
	  insn[encode.insn_row][encode.insn_col].ctl.width           = label[$7].val;
	  insn[encode.insn_row][encode.insn_col].ctl.block           = label[$9].val;
	  insn[encode.insn_row][encode.insn_col].ctl.dist            = label[$11].val;
	  emit_emax_ctl();
          //fprintf(ofile, "%s\t.word\t0x%08.8x\n", ($5)!=-1?label[$5].name:"", insn[encode.insn_row][encode.insn_col].ctl.top);
	  insn[encode.insn_row][encode.insn_col].ctl.lmm_top_symbol = ($3 )!=-1?label[$3 ].type==T_LABEL?label[$3 ].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.lmm_top        = ($3 )!=-1?label[$3 ].val:0;
	  insn[encode.insn_row][encode.insn_col].ctl.mem_top_symbol = ($13)!=-1?label[$13].type==T_LABEL?label[$13].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.mem_top        = ($13)!=-1?label[$13].val:0;
	  insn[encode.insn_row][encode.insn_col].ctl.len_symbol     = ($15)!=-1?label[$15].type==T_LABEL?label[$15].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.len            = ($15)!=-1?label[$15].val:0;
        }
        | LMD "[" LOC "," IMMEDIATE "," IMMEDIATE "," IMMEDIATE "," IMMEDIATE "," LOC "," LOC "]" {
	  insn[encode.insn_row][encode.insn_col].ctl.v               = 6;
	  insn[encode.insn_row][encode.insn_col].ctl.bank            = label[$5].val;
	  insn[encode.insn_row][encode.insn_col].ctl.width           = label[$7].val;
	  insn[encode.insn_row][encode.insn_col].ctl.block           = label[$9].val;
	  insn[encode.insn_row][encode.insn_col].ctl.dist            = label[$11].val;
	  emit_emax_ctl();
          //fprintf(ofile, "%s\t.word\t0x%08.8x\n", ($5)!=-1?label[$5].name:"", insn[encode.insn_row][encode.insn_col].ctl.top);
	  insn[encode.insn_row][encode.insn_col].ctl.lmm_top_symbol = ($3 )!=-1?label[$3 ].type==T_LABEL?label[$3 ].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.lmm_top        = ($3 )!=-1?label[$3 ].val:0;
	  insn[encode.insn_row][encode.insn_col].ctl.mem_top_symbol = ($13)!=-1?label[$13].type==T_LABEL?label[$13].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.mem_top        = ($13)!=-1?label[$13].val:0;
	  insn[encode.insn_row][encode.insn_col].ctl.len_symbol     = ($15)!=-1?label[$15].type==T_LABEL?label[$15].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.len            = ($15)!=-1?label[$15].val:0;
        }
        | MMR "[" LOC "," IMMEDIATE "," IMMEDIATE "," IMMEDIATE "," IMMEDIATE "," LOC "," LOC "]" {
	  insn[encode.insn_row][encode.insn_col].ctl.v               = 8;
	  insn[encode.insn_row][encode.insn_col].ctl.bank            = label[$5].val;
	  insn[encode.insn_row][encode.insn_col].ctl.width           = label[$7].val;
	  insn[encode.insn_row][encode.insn_col].ctl.block           = label[$9].val;
	  insn[encode.insn_row][encode.insn_col].ctl.dist            = label[$11].val;
	  emit_emax_ctl();
          //fprintf(ofile, "%s\t.word\t0x%08.8x\n", ($5)!=-1?label[$5].name:"", insn[encode.insn_row][encode.insn_col].ctl.top);
	  insn[encode.insn_row][encode.insn_col].ctl.lmm_top_symbol = ($3 )!=-1?label[$3 ].type==T_LABEL?label[$3 ].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.lmm_top        = ($3 )!=-1?label[$3 ].val:0;
	  insn[encode.insn_row][encode.insn_col].ctl.mem_top_symbol = ($13)!=-1?label[$13].type==T_LABEL?label[$13].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.mem_top        = ($13)!=-1?label[$13].val:0;
	  insn[encode.insn_row][encode.insn_col].ctl.len_symbol     = ($15)!=-1?label[$15].type==T_LABEL?label[$15].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.len            = ($15)!=-1?label[$15].val:0;
        }
        | MMTR "[" IMMEDIATE "," STRING "," STRING "]" { /* lenは実際にはend_addr */
	  insn[encode.insn_row][encode.insn_col].ctl.v               = 9;
	  insn[encode.insn_row][encode.insn_col].ctl.bank            = label[$3].val;
	  insn[encode.insn_row][encode.insn_col].ctl.width           = 2;
	  insn[encode.insn_row][encode.insn_col].ctl.block           = 0;
	  insn[encode.insn_row][encode.insn_col].ctl.dist            = 0;
	  emit_emax_ctl();
          //fprintf(ofile, "%s\t.word\t0x%08.8x\n", ($5)!=-1?label[$5].name:"", insn[encode.insn_row][encode.insn_col].ctl.top);
	  insn[encode.insn_row][encode.insn_col].ctl.tran_start = ($5)!=-1?label[$5].type==T_STRING?label[$5].name:NULL:NULL;
	  insn[encode.insn_row][encode.insn_col].ctl.tran_end   = ($7)!=-1?label[$7].type==T_STRING?label[$7].name:NULL:NULL;
        }
        | {
	  insn[encode.insn_row][encode.insn_col].ctl.v = 0;
	  emit_emax_ctl();
          //fprintf(ofile, "\t.word\t0x00000000\n");
d250 1
a250 1
  return(hashval % LABEL_NUM+1);
d259 1
a260 1
#endif
a262 442

emit_emax_alu()
{
  //fprintf(ofile, "\t.word\t0x%08.8x,0x%08.8x /* alu */\n",
  //	  *((int*)(&insn[encode.insn_row][encode.insn_col].alu)),
  //	  *((int*)(&insn[encode.insn_row][encode.insn_col].alu)+1)
  //	  );
}

emit_emax_mem()
{
  //fprintf(ofile, "\t.word\t0x%08.8x /* mem */\n",
  //	  *((int*)(&insn[encode.insn_row][encode.insn_col].mem))
  //	  );
}

emit_emax_ctl()
{
  //fprintf(ofile, "\t.word\t0x%08.8x /* ctl */\n",
  //	  *((int*)(&insn[encode.insn_row][encode.insn_col].ctl)));
}

/* Matching Templates */

int
set_insn_cond_ccr_ccr_ccr_ccr_expr_template(ccr1, ccr2, ccr3, ccr4, expr) int ccr1, ccr2, ccr3, ccr4, expr;
{
  insn[encode.insn_row][encode.insn_col].cond.use_bit0 = (encode.ccrspec[ccr4].type==3);
  insn[encode.insn_row][encode.insn_col].cond.use_bit1 = (encode.ccrspec[ccr3].type==3);
  insn[encode.insn_row][encode.insn_col].cond.use_bit2 = (encode.ccrspec[ccr2].type==3);
  insn[encode.insn_row][encode.insn_col].cond.use_bit3 = (encode.ccrspec[ccr1].type==3);
  insn[encode.insn_row][encode.insn_col].cond.bit0 = encode.ccrspec[ccr4].num;
  insn[encode.insn_row][encode.insn_col].cond.bit1 = encode.ccrspec[ccr3].num;
  insn[encode.insn_row][encode.insn_col].cond.bit2 = encode.ccrspec[ccr2].num;
  insn[encode.insn_row][encode.insn_col].cond.bit3 = encode.ccrspec[ccr1].num;
  insn[encode.insn_row][encode.insn_col].cond.table = expr;
}

int
set_insn_ex1_reg_reg_template(op, src1, src2) int op, src1, src2;
{
  insn[encode.insn_row][encode.insn_col].alu.ex1_use_regZ = 0;
  insn[encode.insn_row][encode.insn_col].alu.ex1_op  = op;
  if (encode.regspec[src1].type == 2) {
    yyerror("ex1 cannot use (-)");
    exit(1);
  }
  insn[encode.insn_row][encode.insn_col].alu.upd     = encode.regspec[src1].post;
  insn[encode.insn_row][encode.insn_col].alu.Xini    = (encode.regspec[src1].type==1);
  insn[encode.insn_row][encode.insn_col].alu.Xfhl    = encode.regspec[src1].suffix;
  insn[encode.insn_row][encode.insn_col].alu.Xr      = encode.regspec[src1].num;
  insn[encode.insn_row][encode.insn_col].alu.initX   = 0;
  encode.reg_inuse |= ALU_USE_REGX;
  if (encode.regspec[src2].type == 2) {
    yyerror("ex1 cannot use (-)");
    exit(1);
  }
  insn[encode.insn_row][encode.insn_col].alu.Yini    = (encode.regspec[src2].type==1);
  insn[encode.insn_row][encode.insn_col].alu.Yfhl    = encode.regspec[src2].suffix;
  insn[encode.insn_row][encode.insn_col].alu.Yr      = encode.regspec[src2].num;
  insn[encode.insn_row][encode.insn_col].alu.initY   = 0;
  encode.reg_inuse |= ALU_USE_REGY;
}

int
set_insn_ex1_reg_expr_template(op, src1, expr) int op, src1, expr;
{
  insn[encode.insn_row][encode.insn_col].alu.ex1_use_regZ = 0;
  insn[encode.insn_row][encode.insn_col].alu.ex1_op  = op;
  if (encode.regspec[src1].type == 2) {
    yyerror("ex1 cannot use (-)");
    exit(1);
  }
  insn[encode.insn_row][encode.insn_col].alu.upd     = encode.regspec[src1].post;
  insn[encode.insn_row][encode.insn_col].alu.Xini    = (encode.regspec[src1].type==1);
  insn[encode.insn_row][encode.insn_col].alu.Xfhl    = encode.regspec[src1].suffix;
  insn[encode.insn_row][encode.insn_col].alu.Xr      = encode.regspec[src1].num;
  insn[encode.insn_row][encode.insn_col].alu.initX   = 0;
  encode.reg_inuse |= ALU_USE_REGX;
  insn[encode.insn_row][encode.insn_col].alu.Yini    = 1;
  insn[encode.insn_row][encode.insn_col].alu.Yfhl    = 0; /* imm */
  insn[encode.insn_row][encode.insn_col].alu.Yr      = 0;
  insn[encode.insn_row][encode.insn_col].alu.initY   = expr;
  encode.reg_inuse |= ALU_USE_REGY;
}

int
set_insn_ex1_expr_reg_template(op, expr, src2) int op, expr, src2;
{
  insn[encode.insn_row][encode.insn_col].alu.ex1_use_regZ = 0;
  insn[encode.insn_row][encode.insn_col].alu.ex1_op  = op;
  insn[encode.insn_row][encode.insn_col].alu.upd     = 0;
  insn[encode.insn_row][encode.insn_col].alu.Xini    = 1;
  insn[encode.insn_row][encode.insn_col].alu.Xfhl    = 0; /* imm */
  insn[encode.insn_row][encode.insn_col].alu.Xr      = 0;
  insn[encode.insn_row][encode.insn_col].alu.initX   = expr;
  encode.reg_inuse |= ALU_USE_REGX;
  if (encode.regspec[src2].type == 2) {
    yyerror("ex1 cannot use (-)");
    exit(1);
  }
  insn[encode.insn_row][encode.insn_col].alu.Yini    = (encode.regspec[src2].type==1);
  insn[encode.insn_row][encode.insn_col].alu.Yfhl    = encode.regspec[src2].suffix;
  insn[encode.insn_row][encode.insn_col].alu.Yr      = encode.regspec[src2].num;
  insn[encode.insn_row][encode.insn_col].alu.initY   = 0;
  encode.reg_inuse |= ALU_USE_REGY;
}

int
set_insn_ex1_reg_reg_reg_template(op, src1, src2, src3) int op, src1, src2, src3;
{
  insn[encode.insn_row][encode.insn_col].alu.ex1_use_regZ = 1;
  insn[encode.insn_row][encode.insn_col].alu.ex1_op  = op;
  if (encode.regspec[src1].type == 2) {
    yyerror("ex1 cannot use (-)");
    exit(1);
  }
  insn[encode.insn_row][encode.insn_col].alu.upd     = encode.regspec[src1].post;
  insn[encode.insn_row][encode.insn_col].alu.Xini    = (encode.regspec[src1].type==1);
  insn[encode.insn_row][encode.insn_col].alu.Xfhl    = encode.regspec[src1].suffix;
  insn[encode.insn_row][encode.insn_col].alu.Xr      = encode.regspec[src1].num;
  insn[encode.insn_row][encode.insn_col].alu.initX   = 0;
  encode.reg_inuse |= ALU_USE_REGX;
  if (encode.regspec[src2].type == 2) {
    yyerror("ex1 cannot use (-)");
    exit(1);
  }
  insn[encode.insn_row][encode.insn_col].alu.Yini    = (encode.regspec[src2].type==1);
  insn[encode.insn_row][encode.insn_col].alu.Yfhl    = encode.regspec[src2].suffix;
  insn[encode.insn_row][encode.insn_col].alu.Yr      = encode.regspec[src2].num;
  insn[encode.insn_row][encode.insn_col].alu.initY   = 0;
  encode.reg_inuse |= ALU_USE_REGY;
  if (encode.regspec[src3].type==1) {
    yyerror("ex1_regZ cannot use RI constant");
    exit(1);
  }
  if (encode.regspec[src3].type == 2) {
    yyerror("ex1 cannot use (-)");
    exit(1);
  }
  insn[encode.insn_row][encode.insn_col].alu.Zfhl    = encode.regspec[src3].suffix;
  insn[encode.insn_row][encode.insn_col].alu.Zr      = encode.regspec[src3].num;
  encode.reg_inuse |= ALU_USE_REGZ;
}

int
set_insn_ex1_reg_expr_reg_template(op, src1, expr, src3) int op, src1, expr, src3;
{
  insn[encode.insn_row][encode.insn_col].alu.ex1_use_regZ = 1;
  insn[encode.insn_row][encode.insn_col].alu.ex1_op  = op;
  if (encode.regspec[src1].type == 2) {
    yyerror("ex1 cannot use (-)");
    exit(1);
  }
  insn[encode.insn_row][encode.insn_col].alu.upd     = encode.regspec[src1].post;
  insn[encode.insn_row][encode.insn_col].alu.Xini    = (encode.regspec[src1].type==1);
  insn[encode.insn_row][encode.insn_col].alu.Xfhl    = encode.regspec[src1].suffix;
  insn[encode.insn_row][encode.insn_col].alu.Xr      = encode.regspec[src1].num;
  insn[encode.insn_row][encode.insn_col].alu.initX   = 0;
  encode.reg_inuse |= ALU_USE_REGX;
  insn[encode.insn_row][encode.insn_col].alu.Yini    = 1;
  insn[encode.insn_row][encode.insn_col].alu.Yfhl    = 0; /* imm */
  insn[encode.insn_row][encode.insn_col].alu.Yr      = 0;
  insn[encode.insn_row][encode.insn_col].alu.initY   = expr;
  encode.reg_inuse |= ALU_USE_REGY;
  if (encode.regspec[src3].type==1) {
    yyerror("ex1_regZ cannot use RI constant");
    exit(1);
  }
  if (encode.regspec[src3].type == 2) {
    yyerror("ex1 cannot use (-)");
    exit(1);
  }
  insn[encode.insn_row][encode.insn_col].alu.Zfhl    = encode.regspec[src3].suffix;
  insn[encode.insn_row][encode.insn_col].alu.Zr      = encode.regspec[src3].num;
  encode.reg_inuse |= ALU_USE_REGZ;
}

int
set_insn_ex1_expr_reg_reg_template(op, expr, src2, src3) int op, expr, src2, src3;
{
  insn[encode.insn_row][encode.insn_col].alu.ex1_use_regZ = 1;
  insn[encode.insn_row][encode.insn_col].alu.ex1_op  = op;
  insn[encode.insn_row][encode.insn_col].alu.upd     = 0;
  insn[encode.insn_row][encode.insn_col].alu.Xini    = 1;
  insn[encode.insn_row][encode.insn_col].alu.Xfhl    = 0; /* imm */
  insn[encode.insn_row][encode.insn_col].alu.Xr      = 0;
  insn[encode.insn_row][encode.insn_col].alu.initX   = expr;
  encode.reg_inuse |= ALU_USE_REGX;
  if (encode.regspec[src2].type == 2) {
    yyerror("ex1 cannot use (-)");
    exit(1);
  }
  insn[encode.insn_row][encode.insn_col].alu.Yini    = (encode.regspec[src2].type==1);
  insn[encode.insn_row][encode.insn_col].alu.Yfhl    = encode.regspec[src2].suffix;
  insn[encode.insn_row][encode.insn_col].alu.Yr      = encode.regspec[src2].num;
  insn[encode.insn_row][encode.insn_col].alu.initY   = 0;
  encode.reg_inuse |= ALU_USE_REGY;
  if (encode.regspec[src3].type==1) {
    yyerror("ex1_regZ cannot use RI constant");
    exit(1);
  }
  if (encode.regspec[src3].type == 2) {
    yyerror("ex1 cannot use (-)");
    exit(1);
  }
  insn[encode.insn_row][encode.insn_col].alu.Zfhl    = encode.regspec[src3].suffix;
  insn[encode.insn_row][encode.insn_col].alu.Zr      = encode.regspec[src3].num;
  encode.reg_inuse |= ALU_USE_REGZ;
}

int
set_insn_ex2_reg_reg_template(op, src1, src2) int op, src1, src2;
{
  insn[encode.insn_row][encode.insn_col].alu.ex2_op  = op;
  insn[encode.insn_row][encode.insn_col].alu.simmS_v = 0;
  /* If ex1 exists, regX cannot be used in here. Only (-) is allowed. */
  /*                expr can only use simmS */
  if (encode.reg_inuse & ALU_USE_REGX) {
    if (encode.regspec[src1].type != 2) {
      yyerror("ex1 exists. ex2 can only use (-)");
      exit(1);
    }
    /* If ex1 exists, regY is also occupied */
    if ((encode.reg_inuse & ALU_USE_REGZ) == 0) {
      if (encode.regspec[src2].type==1) {
	yyerror("ex2_regZ cannot use RI constant");
	exit(1);
      }
      insn[encode.insn_row][encode.insn_col].alu.Zfhl= encode.regspec[src2].suffix;
      insn[encode.insn_row][encode.insn_col].alu.Zr  = encode.regspec[src2].num;
      encode.reg_inuse |= ALU_USE_REGZ;
    }
    else {
      yyerror("no register is available for ex2 operation");
      exit(1);
    }
  }
  /* If ex1 is empty, regX should be used in here. */
  else {
    if (encode.regspec[src1].type == 2) {
      yyerror("ex1 is empty. ex2 cannot use (-)");
      exit(1);
    }
    insn[encode.insn_row][encode.insn_col].alu.upd   = encode.regspec[src1].post;
    insn[encode.insn_row][encode.insn_col].alu.Xini  = (encode.regspec[src1].type==1);
    insn[encode.insn_row][encode.insn_col].alu.Xfhl  = encode.regspec[src1].suffix;
    insn[encode.insn_row][encode.insn_col].alu.Xr    = encode.regspec[src1].num;
    insn[encode.insn_row][encode.insn_col].alu.initX = 0;
    encode.reg_inuse |= ALU_USE_REGX;
    insn[encode.insn_row][encode.insn_col].alu.Yini  = (encode.regspec[src2].type==1);
    insn[encode.insn_row][encode.insn_col].alu.Yfhl  = encode.regspec[src2].suffix;
    insn[encode.insn_row][encode.insn_col].alu.Yr    = encode.regspec[src2].num;
    insn[encode.insn_row][encode.insn_col].alu.initY = 0;
    encode.reg_inuse |= ALU_USE_REGY;
  }
}

int
set_insn_ex2_reg_expr_template(op, src1, expr) int op, src1, expr;
{
  insn[encode.insn_row][encode.insn_col].alu.ex2_op  = op;
  insn[encode.insn_row][encode.insn_col].alu.simmS_v = 0;
  /* If ex1 exists, regX cannot be used in here. Only (-) is allowed. */
  /*                expr can only use simmS */
  if (encode.reg_inuse & ALU_USE_REGX) {
    if (encode.regspec[src1].type != 2) {
      yyerror("ex1 exists. ex2 can only use (-)");
      exit(1);
    }
    /* If ex1 exists, regY is also occupied */
    insn[encode.insn_row][encode.insn_col].alu.simmS_v = 1;
    insn[encode.insn_row][encode.insn_col].alu.simmS   = expr;
    if (expr != ((int)(expr<<19)>>19)) {
      yyerror("ex2 expr cannot fit to 13bit-simmS. use single LOGICAL instruction");
      exit(1);
    }
  }
  /* If ex1 is empty, regX should be used in here. */
  else {
    if (encode.regspec[src1].type == 2) {
      yyerror("ex1 is empty. ex2 cannot use (-)");
      exit(1);
    }
    insn[encode.insn_row][encode.insn_col].alu.upd   = encode.regspec[src1].post;
    insn[encode.insn_row][encode.insn_col].alu.Xini  = (encode.regspec[src1].type==1);
    insn[encode.insn_row][encode.insn_col].alu.Xfhl  = encode.regspec[src1].suffix;
    insn[encode.insn_row][encode.insn_col].alu.Xr    = encode.regspec[src1].num;
    insn[encode.insn_row][encode.insn_col].alu.initX = 0;
    encode.reg_inuse |= ALU_USE_REGX;
    insn[encode.insn_row][encode.insn_col].alu.Yini  = 1;
    insn[encode.insn_row][encode.insn_col].alu.Yfhl  = 0; /* imm */
    insn[encode.insn_row][encode.insn_col].alu.Yr    = 0;
    insn[encode.insn_row][encode.insn_col].alu.initY = expr;
    encode.reg_inuse |= ALU_USE_REGY;
  }
}

int
set_insn_ex2_reg_template(op, src) int op, src;
{
  insn[encode.insn_row][encode.insn_col].alu.ex2_op  = op;
  insn[encode.insn_row][encode.insn_col].alu.simmS_v = 0;
  /* If ex1 exists,   regX cannot be used in here. Only (-) is allowed. */
  if (encode.reg_inuse & ALU_USE_REGX) {
    if (encode.regspec[src].type != 2) {
      yyerror("ex1 exists. ex2 can only use (-)");
      exit(1);
    }
  }
  /* If ex1 is empty, regX should be used in here. */
  else {
    if (encode.regspec[src].type == 2) {
      yyerror("ex1 is empty. ex2 cannot use (-)");
      exit(1);
    }
    insn[encode.insn_row][encode.insn_col].alu.upd   = encode.regspec[src].post;
    insn[encode.insn_row][encode.insn_col].alu.Xini  = (encode.regspec[src].type==1);
    insn[encode.insn_row][encode.insn_col].alu.Xfhl  = encode.regspec[src].suffix;
    insn[encode.insn_row][encode.insn_col].alu.Xr    = encode.regspec[src].num;
    insn[encode.insn_row][encode.insn_col].alu.initX = 0;
    encode.reg_inuse |= ALU_USE_REGX;
  }
}

int
set_insn_sft_reg_template(op, src) int op, src;
{
  if (encode.reg_inuse & ALU_USE_REGZ) {
    yyerror("no register is available for shift operation");
    exit(1);
  }
  insn[encode.insn_row][encode.insn_col].alu.sft_op  = op;
  insn[encode.insn_row][encode.insn_col].alu.immT_v  = 0;
  insn[encode.insn_row][encode.insn_col].alu.Zfhl    = encode.regspec[src].suffix;
  insn[encode.insn_row][encode.insn_col].alu.Zr      = encode.regspec[src].num;
  encode.reg_inuse |= ALU_USE_REGZ;
}

int
set_insn_sft_expr_template(op, immT) int op, immT;
{
  if (immT >= 32) {
    yyerror("shift >= 32");
    exit(1);
  }
  insn[encode.insn_row][encode.insn_col].alu.sft_op  = op;
  insn[encode.insn_row][encode.insn_col].alu.immT_v  = 1;
  insn[encode.insn_row][encode.insn_col].alu.immT    = immT;
}

int
set_insn_mem_reg_reg_template(op, src1, src2, dst) int op, src1, src2, dst;
{
  insn[encode.insn_row][encode.insn_col].mem.op      = op;
  insn[encode.insn_row][encode.insn_col].mem.upd     = encode.regspec[src1].post;
  insn[encode.insn_row][encode.insn_col].mem.X_v     = (encode.regspec[src1].type>0);
  insn[encode.insn_row][encode.insn_col].mem.Xini    = (encode.regspec[src1].type==1);
  insn[encode.insn_row][encode.insn_col].mem.Xr      = encode.regspec[src1].num;
  insn[encode.insn_row][encode.insn_col].mem.initX   = 0;
  insn[encode.insn_row][encode.insn_col].mem.Y_v     = (encode.regspec[src2].type>0);
  insn[encode.insn_row][encode.insn_col].mem.Yini    = (encode.regspec[src2].type==1);
  insn[encode.insn_row][encode.insn_col].mem.Ysuffix = encode.regspec[src2].suffix;
  insn[encode.insn_row][encode.insn_col].mem.Yr      = encode.regspec[src2].num;
  insn[encode.insn_row][encode.insn_col].mem.initY   = 0;
  insn[encode.insn_row][encode.insn_col].mem.Zthru   = (encode.regspec[dst].type==2);
  insn[encode.insn_row][encode.insn_col].mem.Zr      = encode.regspec[dst].num;
}

int
set_insn_mem_reg_expr_template(op, src1, expr, dst) int op, src1, expr, dst;
{
  insn[encode.insn_row][encode.insn_col].mem.op      = op;
  insn[encode.insn_row][encode.insn_col].mem.upd     = encode.regspec[src1].post;
  insn[encode.insn_row][encode.insn_col].mem.X_v     = (encode.regspec[src1].type>0);
  insn[encode.insn_row][encode.insn_col].mem.Xini    = (encode.regspec[src1].type==1||(encode.regspec[src1].type==3&&encode.regspec[src1].post));
  insn[encode.insn_row][encode.insn_col].mem.Xr      = encode.regspec[src1].num;
  insn[encode.insn_row][encode.insn_col].mem.initX   = 0;
  insn[encode.insn_row][encode.insn_col].mem.Y_v     = 1;
  insn[encode.insn_row][encode.insn_col].mem.Yini    = 1;
  insn[encode.insn_row][encode.insn_col].mem.Ysuffix = 0; /* imm */
  insn[encode.insn_row][encode.insn_col].mem.Yr      = 0;
  insn[encode.insn_row][encode.insn_col].mem.initY   = expr;
  insn[encode.insn_row][encode.insn_col].mem.Zthru   = (encode.regspec[dst].type==2);
  insn[encode.insn_row][encode.insn_col].mem.Zr      = encode.regspec[dst].num;
}

int
set_insn_mem_expr_reg_template(op, expr, src2, dst) int op, expr, src2, dst;
{
  insn[encode.insn_row][encode.insn_col].mem.op      = op;
  insn[encode.insn_row][encode.insn_col].mem.upd     = 0;
  insn[encode.insn_row][encode.insn_col].mem.X_v     = 1;
  insn[encode.insn_row][encode.insn_col].mem.Xini    = 1;
  insn[encode.insn_row][encode.insn_col].mem.Xr      = 0;
  insn[encode.insn_row][encode.insn_col].mem.initX   = expr;
  insn[encode.insn_row][encode.insn_col].mem.Y_v     = (encode.regspec[src2].type>0);
  insn[encode.insn_row][encode.insn_col].mem.Yini    = (encode.regspec[src2].type==1);
  insn[encode.insn_row][encode.insn_col].mem.Ysuffix = encode.regspec[src2].suffix;
  insn[encode.insn_row][encode.insn_col].mem.Yr      = encode.regspec[src2].num;
  insn[encode.insn_row][encode.insn_col].mem.initY   = 0;
  insn[encode.insn_row][encode.insn_col].mem.Zthru   = (encode.regspec[dst].type==2);
  insn[encode.insn_row][encode.insn_col].mem.Zr      = encode.regspec[dst].num;
}

int
set_regno_template(type, suffix, num, post) int type, suffix, num, post;
{
  if (encode.regspec_top+1 >= MAX_REGSPEC) {
    yyerror("regspec >= MAX_REGSPEC");
    fprintf(stderr, "encode.regspec_top=%d MAX_REGSPEC=%d.\n", encode.regspec_top, MAX_REGSPEC);
    exit(1);
  }
  if (num >= REGNUM) {
    yyerror("REG number > REGNUM");
    exit(1);
  }
  encode.regspec_top++;
  encode.regspec[encode.regspec_top].type   = type;
  encode.regspec[encode.regspec_top].suffix = suffix;
  encode.regspec[encode.regspec_top].num    = num;
  encode.regspec[encode.regspec_top].post   = post;
  return (encode.regspec_top);
}

int
set_ccrno_template(type, num) int type, num;
{
  if (encode.ccrspec_top+1 >= MAX_CCRSPEC) {
    yyerror("ccrspec >= MAX_CCRSPEC");
    fprintf(stderr, "encode.ccrspec_top=%d MAX_CCRSPEC=%d.\n", encode.ccrspec_top, MAX_CCRSPEC);
    exit(1);
  }
  if (num >= CCRNUM) {
    yyerror("CCR number > CCRNUM");
    exit(1);
  }
  encode.ccrspec_top++;
  encode.ccrspec[encode.ccrspec_top].type   = type;
  encode.ccrspec[encode.ccrspec_top].num    = num;
  return (encode.ccrspec_top);
}
@
